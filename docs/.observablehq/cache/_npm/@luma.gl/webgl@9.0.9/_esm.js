/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@luma.gl/webgl@9.0.9/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{assert as e,decodeTextureFormat as t,DeviceFeatures as r,DeviceLimits as n,isObjectEmpty as i,log as s,Buffer as a,Sampler as o,TextureView as l,Texture as c,loadImage as u,Framebuffer as h,CanvasContext as d,loadScript as f,Shader as g,RenderPass as p,checkProps as m,RenderPipeline as b,cast as y,mergeShaderLayout as v,splitUniformsAndBindings as x,CommandBuffer as w,CommandEncoder as _,VertexArray as S,getScratchArray as F,fillArray as E,TransformFeedback as T,QuerySet as A,Device as L,uid as B,Resource as P,stubRemovedMethods as k}from"../core@9.0.9/_esm.js";import{GL as C}from"../constants@9.0.9/_esm.js";import{isBrowser as D,getBrowser as O}from"../../@probe.gl/env@4.0.9/_esm.js";const M={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},W=(e,t,r)=>t?e.enable(r):e.disable(r),I=(e,t,r)=>e.hint(r,t),R=(e,t,r)=>e.pixelStorei(r,t),U=(e,t,r)=>{const n=36006===r?36009:36008;return e.bindFramebuffer(n,t)},G=(e,t,r)=>{const n={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[r];e.bindBuffer(n,t)};function z(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}const $={3042:W,32773:(e,t)=>e.blendColor(...t),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(e,t)=>e.clearColor(...t),3107:(e,t)=>e.colorMask(...t),2884:W,2885:(e,t)=>e.cullFace(t),2929:W,2931:(e,t)=>e.clearDepth(t),2932:(e,t)=>e.depthFunc(t),2928:(e,t)=>e.depthRange(...t),2930:(e,t)=>e.depthMask(t),3024:W,35723:I,35725:(e,t)=>e.useProgram(t),36007:(e,t)=>e.bindRenderbuffer(36161,t),36389:(e,t)=>e.bindTransformFeedback?.(36386,t),34229:(e,t)=>e.bindVertexArray(t),36006:U,36010:U,34964:G,36662:G,36663:G,35053:G,35055:G,2886:(e,t)=>e.frontFace(t),33170:I,2849:(e,t)=>e.lineWidth(t),32823:W,32824:"polygonOffset",10752:"polygonOffset",35977:W,32926:W,32928:W,32938:"sampleCoverage",32939:"sampleCoverage",3089:W,3088:(e,t)=>e.scissor(...t),2960:W,2961:(e,t)=>e.clearStencil(t),2968:(e,t)=>e.stencilMaskSeparate(1028,t),36005:(e,t)=>e.stencilMaskSeparate(1029,t),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(e,t)=>e.viewport(...t),34383:W,10754:W,12288:W,12289:W,12290:W,12291:W,12292:W,12293:W,12294:W,12295:W,3333:R,3317:R,37440:R,37441:R,37443:R,3330:R,3332:R,3331:R,3314:R,32878:R,3316:R,3315:R,32877:R,framebuffer:(e,t)=>{const r=t&&"handle"in t?t.handle:t;return e.bindFramebuffer(36160,r)},blend:(e,t)=>t?e.enable(3042):e.disable(3042),blendColor:(e,t)=>e.blendColor(...t),blendEquation:(e,t)=>{const r="number"==typeof t?[t,t]:t;e.blendEquationSeparate(...r)},blendFunc:(e,t)=>{const r=2===t?.length?[...t,...t]:t;e.blendFuncSeparate(...r)},clearColor:(e,t)=>e.clearColor(...t),clearDepth:(e,t)=>e.clearDepth(t),clearStencil:(e,t)=>e.clearStencil(t),colorMask:(e,t)=>e.colorMask(...t),cull:(e,t)=>t?e.enable(2884):e.disable(2884),cullFace:(e,t)=>e.cullFace(t),depthTest:(e,t)=>t?e.enable(2929):e.disable(2929),depthFunc:(e,t)=>e.depthFunc(t),depthMask:(e,t)=>e.depthMask(t),depthRange:(e,t)=>e.depthRange(...t),dither:(e,t)=>t?e.enable(3024):e.disable(3024),derivativeHint:(e,t)=>{e.hint(35723,t)},frontFace:(e,t)=>e.frontFace(t),mipmapHint:(e,t)=>e.hint(33170,t),lineWidth:(e,t)=>e.lineWidth(t),polygonOffsetFill:(e,t)=>t?e.enable(32823):e.disable(32823),polygonOffset:(e,t)=>e.polygonOffset(...t),sampleCoverage:(e,t)=>e.sampleCoverage(...t),scissorTest:(e,t)=>t?e.enable(3089):e.disable(3089),scissor:(e,t)=>e.scissor(...t),stencilTest:(e,t)=>t?e.enable(2960):e.disable(2960),stencilMask:(e,t)=>{t=z(t)?t:[t,t];const[r,n]=t;e.stencilMaskSeparate(1028,r),e.stencilMaskSeparate(1029,n)},stencilFunc:(e,t)=>{t=z(t)&&3===t.length?[...t,...t]:t;const[r,n,i,s,a,o]=t;e.stencilFuncSeparate(1028,r,n,i),e.stencilFuncSeparate(1029,s,a,o)},stencilOp:(e,t)=>{t=z(t)&&3===t.length?[...t,...t]:t;const[r,n,i,s,a,o]=t;e.stencilOpSeparate(1028,r,n,i),e.stencilOpSeparate(1029,s,a,o)},viewport:(e,t)=>e.viewport(...t)};function V(e,t,r){return void 0!==t[e]?t[e]:r[e]}const N={blendEquation:(e,t,r)=>e.blendEquationSeparate(V(32777,t,r),V(34877,t,r)),blendFunc:(e,t,r)=>e.blendFuncSeparate(V(32969,t,r),V(32968,t,r),V(32971,t,r),V(32970,t,r)),polygonOffset:(e,t,r)=>e.polygonOffset(V(32824,t,r),V(10752,t,r)),sampleCoverage:(e,t,r)=>e.sampleCoverage(V(32938,t,r),V(32939,t,r)),stencilFuncFront:(e,t,r)=>e.stencilFuncSeparate(1028,V(2962,t,r),V(2967,t,r),V(2963,t,r)),stencilFuncBack:(e,t,r)=>e.stencilFuncSeparate(1029,V(34816,t,r),V(36003,t,r),V(36004,t,r)),stencilOpFront:(e,t,r)=>e.stencilOpSeparate(1028,V(2964,t,r),V(2965,t,r),V(2966,t,r)),stencilOpBack:(e,t,r)=>e.stencilOpSeparate(1029,V(34817,t,r),V(34818,t,r),V(34819,t,r))},j={enable:(e,t)=>e({[t]:!0}),disable:(e,t)=>e({[t]:!1}),pixelStorei:(e,t,r)=>e({[t]:r}),hint:(e,t,r)=>e({[t]:r}),useProgram:(e,t)=>e({35725:t}),bindRenderbuffer:(e,t,r)=>e({36007:r}),bindTransformFeedback:(e,t,r)=>e({36389:r}),bindVertexArray:(e,t)=>e({34229:t}),bindFramebuffer:(e,t,r)=>{switch(t){case 36160:return e({36006:r,36010:r});case 36009:return e({36006:r});case 36008:return e({36010:r});default:return null}},bindBuffer:(e,t,r)=>{const n={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[t];return n?e({[n]:r}):{valueChanged:!0}},blendColor:(e,t,r,n,i)=>e({32773:new Float32Array([t,r,n,i])}),blendEquation:(e,t)=>e({32777:t,34877:t}),blendEquationSeparate:(e,t,r)=>e({32777:t,34877:r}),blendFunc:(e,t,r)=>e({32969:t,32968:r,32971:t,32970:r}),blendFuncSeparate:(e,t,r,n,i)=>e({32969:t,32968:r,32971:n,32970:i}),clearColor:(e,t,r,n,i)=>e({3106:new Float32Array([t,r,n,i])}),clearDepth:(e,t)=>e({2931:t}),clearStencil:(e,t)=>e({2961:t}),colorMask:(e,t,r,n,i)=>e({3107:[t,r,n,i]}),cullFace:(e,t)=>e({2885:t}),depthFunc:(e,t)=>e({2932:t}),depthRange:(e,t,r)=>e({2928:new Float32Array([t,r])}),depthMask:(e,t)=>e({2930:t}),frontFace:(e,t)=>e({2886:t}),lineWidth:(e,t)=>e({2849:t}),polygonOffset:(e,t,r)=>e({32824:t,10752:r}),sampleCoverage:(e,t,r)=>e({32938:t,32939:r}),scissor:(e,t,r,n,i)=>e({3088:new Int32Array([t,r,n,i])}),stencilMask:(e,t)=>e({2968:t,36005:t}),stencilMaskSeparate:(e,t,r)=>e({[1028===t?2968:36005]:r}),stencilFunc:(e,t,r,n)=>e({2962:t,2967:r,2963:n,34816:t,36003:r,36004:n}),stencilFuncSeparate:(e,t,r,n,i)=>e({[1028===t?2962:34816]:r,[1028===t?2967:36003]:n,[1028===t?2963:36004]:i}),stencilOp:(e,t,r,n)=>e({2964:t,2965:r,2966:n,34817:t,34818:r,34819:n}),stencilOpSeparate:(e,t,r,n,i)=>e({[1028===t?2964:34817]:r,[1028===t?2965:34818]:n,[1028===t?2966:34819]:i}),viewport:(e,t,r,n,i)=>e({2978:[t,r,n,i]})},H=(e,t)=>e.isEnabled(t),Q={3042:H,2884:H,2929:H,3024:H,32823:H,32926:H,32928:H,3089:H,2960:H,35977:H},q=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function X(e,t){if(function(e){for(const t in e)return!1;return!0}(t))return;const r={};for(const n in t){const i=Number(n),s=$[n];s&&("string"==typeof s?r[s]=!0:s(e,t[n],i))}const n=e.state&&e.state.cache;if(n)for(const i in r){(0,N[i])(e,t,n)}}function Y(e,t=M){if("number"==typeof t){const r=t,n=Q[r];return n?n(e,r):e.getParameter(r)}const r=Array.isArray(t)?t:Object.keys(t),n={};for(const t of r){const r=Q[t];n[t]=r?r(e,Number(t)):e.getParameter(Number(t))}return n}function J(e){X(e,M)}function K(e,t){if(e===t)return!0;const r=Array.isArray(e)||ArrayBuffer.isView(e),n=Array.isArray(t)||ArrayBuffer.isView(t);if(r&&n&&e.length===t.length){for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}return!1}class Z{gl;program=null;stateStack=[];enable=!0;cache;log;constructor(e,{copyState:t=!1,log:r=(()=>{})}={}){this.gl=e,this.cache=t?Y(e):Object.assign({},M),this.log=r,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){e(this.stateStack.length>0);const t=this.stateStack[this.stateStack.length-1];X(this.gl,t),this.stateStack.pop()}_updateCache(t){let r,n=!1;const i=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const s in t){e(void 0!==s);const a=t[s],o=this.cache[s];K(a,o)||(n=!0,r=o,i&&!(s in i)&&(i[s]=o),this.cache[s]=a)}return{valueChanged:n,oldValue:r}}}function ee(e){return e.state}function te(t,r){const{enable:n=!0,copyState:i}=r;if(e(void 0!==i),!t.state){t.state=new Z(t,{copyState:i}),function(e){const t=e.useProgram.bind(e);e.useProgram=function(r){const n=ee(e);n.program!==r&&(t(r),n.program=r)}}(t);for(const e in j){se(t,e,j[e])}ie(t,"getParameter"),ie(t,"isEnabled")}return ee(t).enable=n,t}function re(e){let t=ee(e);t||(te(e,{copyState:!1}),t=ee(e)),t.push()}function ne(t){const r=ee(t);e(r),r.pop()}function ie(e,t){const r=e[t].bind(e);e[t]=function(t){if(void 0===t||q.has(t))return r(t);const n=ee(e);return t in n.cache||(n.cache[t]=r(t)),n.enable?n.cache[t]:r(t)},Object.defineProperty(e[t],"name",{value:`${t}-from-cache`,configurable:!1})}function se(e,t,r){if(!e[t])return;const n=e[t].bind(e);e[t]=function(...t){const i=ee(e),{valueChanged:s,oldValue:a}=r(i._updateCache,...t);return s&&n(...t),a},Object.defineProperty(e[t],"name",{value:`${t}-to-cache`,configurable:!1})}const ae={powerPreference:"high-performance",onContextLost:()=>console.error("WebGL context lost"),onContextRestored:()=>console.info("WebGL context restored")};function oe(e,t,r){return void 0===r[t]&&(r[t]=e.getExtension(t)||null),r[t]}function le(e,t){const r=e.getParameter(7936),n=e.getParameter(7937);oe(e,"WEBGL_debug_renderer_info",t);const i=t.WEBGL_debug_renderer_info,s=e.getParameter(i?i.UNMASKED_VENDOR_WEBGL:7936)||r,a=e.getParameter(i?i.UNMASKED_RENDERER_WEBGL:7937)||n,o=e.getParameter(7938),l=ce(s,a),c=function(e,t){if(/Metal/i.exec(e)||/Metal/i.exec(t))return"metal";if(/ANGLE/i.exec(e)||/ANGLE/i.exec(t))return"opengl";return"unknown"}(s,a),u=function(e,t){if(/SwiftShader/i.exec(e)||/SwiftShader/i.exec(t))return"cpu";switch(ce(e,t)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}(s,a);return{type:"webgl",gpu:l,gpuType:u,gpuBackend:c,vendor:s,renderer:a,version:o,shadingLanguage:"glsl",shadingLanguageVersion:300}}function ce(e,t){return/NVIDIA/i.exec(e)||/NVIDIA/i.exec(t)?"nvidia":/INTEL/i.exec(e)||/INTEL/i.exec(t)?"intel":/Apple/i.exec(e)||/Apple/i.exec(t)?"apple":/AMD/i.exec(e)||/AMD/i.exec(t)||/ATI/i.exec(e)||/ATI/i.exec(t)?"amd":/SwiftShader/i.exec(e)||/SwiftShader/i.exec(t)?"software":"unknown"}function ue(e){switch(e){case"uint8":case"unorm8":return 5121;case"sint8":case"snorm8":return 5120;case"uint16":case"unorm16":return 5123;case"sint16":case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(e))}const he="texture-compression-bc",de="texture-compression-astc",fe="texture-compression-etc2",ge="texture-compression-pvrtc-webgl",pe="texture-compression-atc-webgl",me="float32-renderable-webgl",be="float16-renderable-webgl",ye="snorm8-renderable-webgl",ve="norm16-renderable-webgl",xe="snorm16-renderable-webgl",we="float32-filterable",_e="float16-filterable-webgl",Se="WEBGL_compressed_texture_s3tc",Fe="WEBGL_compressed_texture_s3tc_srgb",Ee="EXT_texture_compression_rgtc",Te="EXT_texture_compression_bptc",Ae="EXT_texture_norm16",Le="EXT_render_snorm",Be={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat_renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[Le],"norm16-renderable-webgl":[Ae],"snorm16-renderable-webgl":[Ae,Le],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Se,Fe,Ee,Te],"texture-compression-bc5-webgl":[Ee],"texture-compression-bc7-webgl":[Te],"texture-compression-etc2":["WEBGL_compressed_texture_etc"],"texture-compression-astc":["WEBGL_compressed_texture_astc"],"texture-compression-etc1-webgl":["WEBGL_compressed_texture_etc1"],"texture-compression-pvrtc-webgl":["WEBGL_compressed_texture_pvrtc"],"texture-compression-atc-webgl":["WEBGL_compressed_texture_atc"]};const Pe={"rgb8unorm-unsized":{gl:6407,b:4,c:2,bpp:4,dataFormat:6407,types:[5121,33635]},"rgba8unorm-unsized":{gl:6408,b:4,c:2,bpp:4,dataFormat:6408,types:[5121,32819,32820]},r8unorm:{gl:33321,b:1,c:1,rb:!0},r8snorm:{gl:36756,b:1,c:1,render:ye},r8uint:{gl:33330,b:1,c:1,rb:!0},r8sint:{gl:33329,b:1,c:1,rb:!0},rg8unorm:{gl:33323,b:2,c:2,rb:!0},rg8snorm:{gl:36757,b:2,c:2,render:ye},rg8uint:{gl:33336,b:2,c:2,rb:!0},rg8sint:{gl:33335,b:2,c:2,rb:!0},r16uint:{gl:33332,b:2,c:1,rb:!0},r16sint:{gl:33331,b:2,c:1,rb:!0},r16float:{gl:33325,b:2,c:1,render:be,filter:"float16-filterable-webgl",rb:!0},"r16unorm-webgl":{gl:33322,b:2,c:1,f:ve,rb:!0},"r16snorm-webgl":{gl:36760,b:2,c:1,f:xe},"rgba4unorm-webgl":{gl:32854,b:2,c:4,wgpu:!1,rb:!0},"rgb565unorm-webgl":{gl:36194,b:2,c:4,wgpu:!1,rb:!0},"rgb5a1unorm-webgl":{gl:32855,b:2,c:4,wgpu:!1,rb:!0},"rgb8unorm-webgl":{gl:32849,b:3,c:3,wgpu:!1},"rgb8snorm-webgl":{gl:36758,b:3,c:3,wgpu:!1},rgba8unorm:{gl:32856,b:4,c:2,bpp:4},"rgba8unorm-srgb":{gl:35907,b:4,c:4,bpp:4},rgba8snorm:{gl:36759,b:4,c:4,render:ye},rgba8uint:{gl:36220,b:4,c:4,bpp:4},rgba8sint:{gl:36238,b:4,c:4,bpp:4},bgra8unorm:{b:4,c:4},"bgra8unorm-srgb":{b:4,c:4},rg16uint:{gl:33338,b:4,c:1,bpp:4},rg16sint:{gl:33337,b:4,c:2,bpp:4},rg16float:{gl:33327,bpp:4,b:4,c:2,render:be,filter:_e,rb:!0},"rg16unorm-webgl":{gl:33324,b:2,c:2,render:ve},"rg16snorm-webgl":{gl:36761,b:2,c:2,render:xe},r32uint:{gl:33334,b:4,c:1,bpp:4,rb:!0},r32sint:{gl:33333,b:4,c:1,bpp:4,rb:!0},r32float:{gl:33326,bpp:4,b:4,c:1,render:me,filter:we},rgb9e5ufloat:{gl:35901,b:4,c:3,p:1,render:"rgb9e5ufloat_renderable-webgl"},rg11b10ufloat:{gl:35898,b:4,c:3,p:1,render:me,rb:!0},rgb10a2unorm:{gl:32857,b:4,c:4,p:1,rb:!0},"rgb10a2uint-webgl":{b:4,c:4,gl:36975,p:1,wgpu:!1,bpp:4,rb:!0},"rgb16unorm-webgl":{gl:32852,b:2,c:3,f:ve},"rgb16snorm-webgl":{gl:36762,b:2,c:3,f:ve},rg32uint:{gl:33340,b:8,c:2,rb:!0},rg32sint:{gl:33339,b:8,c:2,rb:!0},rg32float:{gl:33328,b:8,c:2,render:me,filter:we,rb:!0},rgba16uint:{gl:36214,b:8,c:4,rb:!0},rgba16sint:{gl:36232,b:8,c:4,rb:!0},rgba16float:{gl:34842,b:8,c:4,render:be,filter:_e},"rgba16unorm-webgl":{gl:32859,b:2,c:4,render:ve,rb:!0},"rgba16snorm-webgl":{gl:36763,b:2,c:4,render:xe},"rgb32float-webgl":{gl:34837,render:me,filter:we,gl2ext:"EXT_color_buffer_float",dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,b:16,c:4,rb:!0},rgba32sint:{gl:36226,b:16,c:4,rb:!0},rgba32float:{gl:34836,b:16,c:4,render:me,filter:we,rb:!0},stencil8:{gl:36168,b:1,c:1,attachment:36128,rb:!0},depth16unorm:{gl:33189,b:2,c:1,attachment:36096,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,b:3,c:1,attachment:36096,dataFormat:6402,types:[5125]},depth32float:{gl:36012,b:4,c:1,attachment:36096,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth24unorm-stencil8":{gl:35056,b:4,c:2,p:1,attachment:33306,dataFormat:34041,types:[34042],rb:!0},"depth32float-stencil8":{gl:36013,b:5,c:2,p:1,attachment:33306,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Se,f:he},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:Fe,f:he},"bc1-rgba-unorm":{gl:33777,x:Se,f:he},"bc1-rgba-unorm-srgb":{gl:35916,x:Fe,f:he},"bc2-rgba-unorm":{gl:33778,x:Se,f:he},"bc2-rgba-unorm-srgb":{gl:35918,x:Fe,f:he},"bc3-rgba-unorm":{gl:33779,x:Se,f:he},"bc3-rgba-unorm-srgb":{gl:35919,x:Fe,f:he},"bc4-r-unorm":{gl:36283,x:Ee,f:he},"bc4-r-snorm":{gl:36284,x:Ee,f:he},"bc5-rg-unorm":{gl:36285,x:Ee,f:he},"bc5-rg-snorm":{gl:36286,x:Ee,f:he},"bc6h-rgb-ufloat":{gl:36495,x:Te,f:he},"bc6h-rgb-float":{gl:36494,x:Te,f:he},"bc7-rgba-unorm":{gl:36492,x:Te,f:he},"bc7-rgba-unorm-srgb":{gl:36493,x:Te,f:he},"etc2-rgb8unorm":{gl:37492,f:fe},"etc2-rgb8unorm-srgb":{gl:37494,f:fe},"etc2-rgb8a1unorm":{gl:37496,f:fe},"etc2-rgb8a1unorm-srgb":{gl:37497,f:fe},"etc2-rgba8unorm":{gl:37493,f:fe},"etc2-rgba8unorm-srgb":{gl:37495,f:fe},"eac-r11unorm":{gl:37488,f:fe},"eac-r11snorm":{gl:37489,f:fe},"eac-rg11unorm":{gl:37490,f:fe},"eac-rg11snorm":{gl:37491,f:fe},"astc-4x4-unorm":{gl:37808,f:de},"astc-4x4-unorm-srgb":{gl:37840,f:de},"astc-5x4-unorm":{gl:37809,f:de},"astc-5x4-unorm-srgb":{gl:37841,f:de},"astc-5x5-unorm":{gl:37810,f:de},"astc-5x5-unorm-srgb":{gl:37842,f:de},"astc-6x5-unorm":{gl:37811,f:de},"astc-6x5-unorm-srgb":{gl:37843,f:de},"astc-6x6-unorm":{gl:37812,f:de},"astc-6x6-unorm-srgb":{gl:37844,f:de},"astc-8x5-unorm":{gl:37813,f:de},"astc-8x5-unorm-srgb":{gl:37845,f:de},"astc-8x6-unorm":{gl:37814,f:de},"astc-8x6-unorm-srgb":{gl:37846,f:de},"astc-8x8-unorm":{gl:37815,f:de},"astc-8x8-unorm-srgb":{gl:37847,f:de},"astc-10x5-unorm":{gl:37819,f:de},"astc-10x5-unorm-srgb":{gl:37851,f:de},"astc-10x6-unorm":{gl:37817,f:de},"astc-10x6-unorm-srgb":{gl:37849,f:de},"astc-10x8-unorm":{gl:37818,f:de},"astc-10x8-unorm-srgb":{gl:37850,f:de},"astc-10x10-unorm":{gl:37819,f:de},"astc-10x10-unorm-srgb":{gl:37851,f:de},"astc-12x10-unorm":{gl:37820,f:de},"astc-12x10-unorm-srgb":{gl:37852,f:de},"astc-12x12-unorm":{gl:37821,f:de},"astc-12x12-unorm-srgb":{gl:37853,f:de},"pvrtc-rgb4unorm-webgl":{gl:35840,f:ge},"pvrtc-rgba4unorm-webgl":{gl:35842,f:ge},"pvrtc-rbg2unorm-webgl":{gl:35841,f:ge},"pvrtc-rgba2unorm-webgl":{gl:35843,f:ge},"etc1-rbg-unorm-webgl":{gl:36196,f:"texture-compression-etc1-webgl"},"atc-rgb-unorm-webgl":{gl:35986,f:pe},"atc-rgba-unorm-webgl":{gl:35986,f:pe},"atc-rgbai-unorm-webgl":{gl:34798,f:pe}},ke={6403:1,36244:1,33319:2,33320:2,6407:3,36248:3,6408:4,36249:4,6402:1,34041:1,6406:1,6409:1,6410:2},Ce={5126:4,5125:4,5124:4,5123:2,5122:2,5131:2,5120:1,5121:1};function De(e,t,r){const n=Pe[t];if(!n)return!1;if(void 0===n.gl)return!1;const i=n.x||n.gl2ext;return!i||Boolean(oe(e,i,r))}function Oe(e){if("string"==typeof e)return e;const t=Object.entries(Pe).find((([,t])=>t.gl===e));if(!t)throw new Error(`Unknown texture format ${e}`);return t[0]}function Me(e){const t=Pe[e],r=t?.gl;if(void 0===r)throw new Error(`Unsupported texture format ${e}`);return r}function We(e){const r=Pe[e],n=Me(e),i=t(e);return{format:n,dataFormat:r?.dataFormat||Re(i.format,i.integer,i.normalized,n),type:i.dataType?ue(i.dataType):r?.types?.[0]||5121,compressed:i.compressed}}function Ie(e){const t=We(e);return(ke[t.dataFormat]||4)*(Ce[t.type]||1)}function Re(e,t,r,n){if(6408===n||6407===n)return n;switch(e){case"r":return t&&!r?36244:6403;case"rg":return t&&!r?33320:33319;case"rgb":return t&&!r?36248:6407;case"rgba":return t&&!r?36249:6408;default:return 6408}}const Ue={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class Ge extends r{gl;extensions;testedFeatures=new Set;constructor(e,t,r){super([],r),this.gl=e,this.extensions=t,oe(e,"EXT_color_buffer_float",t)}*[Symbol.iterator](){const e=this.getFeatures();for(const t of e)this.has(t)&&(yield t);return[]}has(e){return!this.disabledFeatures[e]&&(this.testedFeatures.has(e)||(this.testedFeatures.add(e),function(e){return e in Be}(e)&&function(e,t,r){return(Be[t]||[]).every((t=>oe(e,t,r)))}(this.gl,e,this.extensions)&&this.features.add(e),this.getWebGLFeature(e)&&this.features.add(e)),this.features.has(e))}initializeFeatures(){const e=this.getFeatures().filter((e=>"polygon-mode-webgl"!==e));for(const t of e)this.has(t)}getFeatures(){return[...Object.keys(Ue),...Object.keys(Be)]}getWebGLFeature(e){const t=Ue[e];return"string"==typeof t?Boolean(oe(this.gl,t,this.extensions)):Boolean(t)}}class ze extends n{get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}gl;limits={};constructor(e){super(),this.gl=e}getParameter(e){return void 0===this.limits[e]&&(this.limits[e]=this.gl.getParameter(e)),this.limits[e]}}function $e(e,t,r){if(function(e){for(const t in e)return!1;return!0}(t))return r(e);const{nocatch:n=!0}=t;let i;if(re(e),X(e,t),n)i=r(e),ne(e);else try{i=r(e)}finally{ne(e)}return i}function Ve(e,t,r){if(i(t))return r(e);re(e.gl);try{return Ne(e,t),r(e)}finally{ne(e.gl)}}function Ne(e,t){const r=e,{gl:n}=r;if(t.cullMode)switch(t.cullMode){case"none":n.disable(2884);break;case"front":n.enable(2884),n.cullFace(1028);break;case"back":n.enable(2884),n.cullFace(1029)}if(t.frontFace&&n.frontFace(Xe("frontFace",t.frontFace,{ccw:2305,cw:2304})),t.unclippedDepth&&e.features.has("depth-clip-control")&&n.enable(34383),void 0!==t.depthBias&&(n.enable(32823),n.polygonOffset(t.depthBias,t.depthBiasSlopeScale||0)),t.provokingVertex&&e.features.has("provoking-vertex-webgl")){const e=r.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,n=Xe("provokingVertex",t.provokingVertex,{first:36429,last:36430});e?.provokingVertexWEBGL(n)}if((t.polygonMode||t.polygonOffsetLine)&&e.features.has("polygon-mode-webgl")){if(t.polygonMode){const e=r.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,n=Xe("polygonMode",t.polygonMode,{fill:6914,line:6913});e?.polygonModeWEBGL(1028,n),e?.polygonModeWEBGL(1029,n)}t.polygonOffsetLine&&n.enable(10754)}if(e.features.has("shader-clip-cull-distance-webgl")&&(t.clipDistance0&&n.enable(12288),t.clipDistance1&&n.enable(12289),t.clipDistance2&&n.enable(12290),t.clipDistance3&&n.enable(12291),t.clipDistance4&&n.enable(12292),t.clipDistance5&&n.enable(12293),t.clipDistance6&&n.enable(12294),t.clipDistance7&&n.enable(12295)),void 0!==t.depthWriteEnabled&&n.depthMask(t.depthWriteEnabled),t.depthCompare&&("always"!==t.depthCompare?n.enable(2929):n.disable(2929),n.depthFunc(je("depthCompare",t.depthCompare))),t.stencilWriteMask){const e=t.stencilWriteMask;n.stencilMaskSeparate(1028,e),n.stencilMaskSeparate(1029,e)}if(t.stencilReadMask&&s.warn("stencilReadMask not supported under WebGL"),t.stencilCompare){const e=t.stencilReadMask||4294967295,r=je("depthCompare",t.stencilCompare);"always"!==t.stencilCompare?n.enable(2960):n.disable(2960),n.stencilFuncSeparate(1028,r,0,e),n.stencilFuncSeparate(1029,r,0,e)}if(t.stencilPassOperation&&t.stencilFailOperation&&t.stencilDepthFailOperation){const e=He("stencilPassOperation",t.stencilPassOperation),r=He("stencilFailOperation",t.stencilFailOperation),i=He("stencilDepthFailOperation",t.stencilDepthFailOperation);n.stencilOpSeparate(1028,r,i,e),n.stencilOpSeparate(1029,r,i,e)}if(t.blendColorOperation||t.blendAlphaOperation){n.enable(3042);const e=Qe("blendColorOperation",t.blendColorOperation||"add"),r=Qe("blendAlphaOperation",t.blendAlphaOperation||"add");n.blendEquationSeparate(e,r);const i=qe("blendColorSrcFactor",t.blendColorSrcFactor||"one"),s=qe("blendColorDstFactor",t.blendColorDstFactor||"zero"),a=qe("blendAlphaSrcFactor",t.blendAlphaSrcFactor||"one"),o=qe("blendAlphaDstFactor",t.blendAlphaDstFactor||"zero");n.blendFuncSeparate(i,s,a,o)}}function je(e,t){return Xe(e,t,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function He(e,t){return Xe(e,t,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function Qe(e,t){return Xe(e,t,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function qe(e,t){return Xe(e,t,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function Xe(e,t,r){if(!(t in r))throw new Error(function(e,t){return`Illegal parameter ${t} for ${e}`}(e,t));return r[t]}function Ye(e){const t={};return e.addressModeU&&(t[10242]=Je(e.addressModeU)),e.addressModeV&&(t[10243]=Je(e.addressModeV)),e.addressModeW&&(t[32882]=Je(e.addressModeW)),e.magFilter&&(t[10240]=Ke(e.magFilter)),(e.minFilter||e.mipmapFilter)&&(t[10241]=function(e,t){if(!t)return Ke(e);switch(e){case"nearest":return"nearest"===t?9984:9986;case"linear":return"nearest"===t?9985:9987}}(e.minFilter||"linear",e.mipmapFilter)),void 0!==e.lodMinClamp&&(t[33082]=e.lodMinClamp),void 0!==e.lodMaxClamp&&(t[33083]=e.lodMaxClamp),"comparison-sampler"===e.type&&(t[34892]=34894),e.compare&&(t[34893]=je("compare",e.compare)),e.maxAnisotropy&&(t[34046]=e.maxAnisotropy),t}function Je(e){switch(e){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function Ke(e){switch(e){case"nearest":return 9728;case"linear":return 9729}}class Ze extends a{device;gl;handle;glTarget;glUsage;glIndexType=5123;byteLength;bytesUsed;constructor(e,t={}){super(e,t),this.device=e,this.gl=this.device.gl;const r="object"==typeof t?t.handle:void 0;this.handle=r||this.gl.createBuffer(),e.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=function(e){if(e&a.INDEX)return 34963;if(e&a.VERTEX)return 34962;if(e&a.UNIFORM)return 35345;return 34962}(this.props.usage),this.glUsage=function(e){if(e&a.INDEX)return 35044;if(e&a.VERTEX)return 35044;if(e&a.UNIFORM)return 35048;return 35044}(this.props.usage),this.glIndexType="uint32"===this.props.indexType?5125:5123,t.data?this._initWithData(t.data,t.byteOffset,t.byteLength):this._initWithByteLength(t.byteLength||0)}_initWithData(e,t=0,r=e.byteLength+t){const n=this.glTarget;this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,r,this.glUsage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(e,t,r),this.trackAllocatedMemory(r)}_initWithByteLength(t){e(t>=0);let r=t;0===t&&(r=new Float32Array(0));const n=this.glTarget;return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,r,this.glUsage),this.gl.bindBuffer(n,null),this.bytesUsed=t,this.byteLength=t,this._setDebugData(null,0,t),this.trackAllocatedMemory(t),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(e,t=0){const r=36663;this.gl.bindBuffer(r,this.handle),this.gl.bufferSubData(r,t,e),this.gl.bindBuffer(r,null),this._setDebugData(e,t,e.byteLength)}async readAsync(e=0,t){return this.readSyncWebGL(e,t)}readSyncWebGL(e=0,t){t=t??this.byteLength-e;const r=new Uint8Array(t);return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,r,0,t),this.gl.bindBuffer(36662,null),this._setDebugData(r,e,t),r}}class et extends o{device;handle;parameters;constructor(e,t){super(e,t),this.device=e,this.parameters=Ye(t),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(e){for(const[t,r]of Object.entries(e)){const e=Number(t);switch(e){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,e,r);break;default:this.device.gl.samplerParameteri(this.handle,e,r)}}}}class tt extends l{device;gl;handle;texture;constructor(e,t){super(e,{...c.defaultProps,...t}),this.device=e,this.gl=this.device.gl,this.handle=null,this.texture=t.texture}}const rt={parameters:{},pixelStore:{},pixels:null,border:0,dataFormat:void 0,textureUnit:void 0,target:void 0};class nt extends c{static FACES=[34069,34070,34071,34072,34073,34074];MAX_ATTRIBUTES;device;gl;handle;sampler=void 0;view=void 0;glFormat=void 0;type=void 0;dataFormat=void 0;mipmaps=void 0;target;textureUnit=void 0;loaded=!1;_video;constructor(e,t){super(e,{...rt,format:"rgba8unorm",...t}),this.device=e,this.gl=this.device.gl,this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glFormat=6408,this.target=function(e){switch(e.dimension){case"2d":return 3553;case"cube":return 34067;case"2d-array":return 35866;case"3d":return 32879;default:throw new Error(e.dimension)}}(this.props),this.loaded=!1,"string"==typeof this.props?.data&&Object.assign(this.props,{data:u(this.props.data)}),this.initialize(this.props),Object.seal(this)}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}toString(){return`Texture(${this.id},${this.width}x${this.height})`}createView(e){return new tt(this.device,{...e,texture:this})}initialize(e={}){if("cube"===this.props.dimension)return this.initializeCube(e);let t=e.data;if(t instanceof Promise)return t.then((t=>this.initialize(Object.assign({},e,{pixels:t,data:t})))),this;const r="undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement;if(r&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",(()=>this.initialize(e))),this;const{parameters:n={}}=e,{pixels:i=null,pixelStore:s={},textureUnit:a,mipmaps:o=!0}=e;t||(t=i);let{width:l,height:c,dataFormat:u,type:h,compressed:d=!1}=e;const{depth:f=0}=e,g=Me(e.format);return({width:l,height:c,compressed:d,dataFormat:u,type:h}=this._deduceParameters({format:e.format,type:h,dataFormat:u,compressed:d,data:t,width:l,height:c})),this.width=l,this.height=c,this.glFormat=g,this.type=h,this.dataFormat=u,this.textureUnit=a,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),this.mipmaps=o,this.setImageData({data:t,width:l,height:c,depth:f,format:g,type:h,dataFormat:u,parameters:s,compressed:d}),this.setSampler(e.sampler),this._setSamplerParameters(n),this.view=this.createView({...this.props,mipLevelCount:1,arrayLayerCount:1}),o&&this.device.isTextureFormatFilterable(e.format)&&this.generateMipmap(),r&&(this._video={video:t,parameters:n,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}initializeCube(e){const{mipmaps:t=!0,parameters:r={}}=e;return this.setCubeMapImageData(e).then((()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setSampler(e.sampler),this._setSamplerParameters(r)})),this}setSampler(e={}){let t;e instanceof et?(this.sampler=e,t=e.props):(this.sampler=new et(this.device,e),t=e);const r=Ye(t);return this._setSamplerParameters(r),this}resize(e){const{height:t,width:r,mipmaps:n=!1}=e;return r!==this.width||t!==this.height?this.initialize({width:r,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,mipmaps:n}):this}update(){if(this._video){const{video:e,parameters:t,lastTime:r}=this._video;if(r===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}generateMipmap(e={}){return this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),$e(this.gl,e,(()=>{this.gl.generateMipmap(this.target)})),this.gl.bindTexture(this.target,null),this}setImageData(t){if("3d"===this.props.dimension||"2d-array"===this.props.dimension)return this.setImageData3D(t);this.trackDeallocatedMemory("Texture");const{target:r=this.target,pixels:n=null,level:i=0,glFormat:s=this.glFormat,offset:a=0,parameters:o={}}=t;let{data:l=null,type:c=this.type,width:u=this.width,height:h=this.height,dataFormat:d=this.dataFormat,compressed:f=!1}=t;l||(l=n),({type:c,dataFormat:d,compressed:f,width:u,height:h}=this._deduceParameters({format:this.props.format,type:c,dataFormat:d,compressed:f,data:l,width:u,height:h}));const{gl:g}=this;g.bindTexture(this.target,this.handle);let p=null;if(({data:l,dataType:p}=this._getDataType({data:l,compressed:f})),$e(this.gl,o,(()=>{switch(p){case"null":case"browser-object":g.texImage2D(r,i,s,u,h,0,d,c,l);break;case"typed-array":g.texImage2D(r,i,s,u,h,0,d,c,l,a);break;case"buffer":this.device.gl.bindBuffer(35052,l.handle||l),this.device.gl.texImage2D(r,i,s,u,h,0,d,c,a),this.device.gl.bindBuffer(35052,null);break;case"compressed":for(const[e,t]of l.entries())g.compressedTexImage2D(r,e,t.format,t.width,t.height,0,t.data);break;default:e(!1,"Unknown image data type")}})),l&&l.byteLength)this.trackAllocatedMemory(l.byteLength,"Texture");else{const e=Ie(this.props.format);this.trackAllocatedMemory(this.width*this.height*e,"Texture")}return this.loaded=!0,this}setSubImageData({target:t=this.target,pixels:r=null,data:n=null,x:i=0,y:s=0,width:a=this.width,height:o=this.height,level:l=0,glFormat:c=this.glFormat,type:u=this.type,dataFormat:h=this.dataFormat,compressed:d=!1,offset:f=0,parameters:g={}}){if(({type:u,dataFormat:h,compressed:d,width:a,height:o}=this._deduceParameters({format:this.props.format,type:u,dataFormat:h,compressed:d,data:n,width:a,height:o})),e(1===this.depth,"texSubImage not supported for 3D textures"),n||(n=r),n&&n.data){const e=n;n=e.data,a=e.shape[0],o=e.shape[1]}n instanceof Ze&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),$e(this.gl,g,(()=>{d?this.gl.compressedTexSubImage2D(t,l,i,s,a,o,c,n):null===n?this.gl.texSubImage2D(t,l,i,s,a,o,h,u,null):ArrayBuffer.isView(n)?this.gl.texSubImage2D(t,l,i,s,a,o,h,u,n,f):"undefined"!=typeof WebGLBuffer&&n instanceof WebGLBuffer?(this.device.gl.bindBuffer(35052,n),this.device.gl.texSubImage2D(t,l,i,s,a,o,h,u,f),this.device.gl.bindBuffer(35052,null)):this.device.gl.texSubImage2D(t,l,i,s,a,o,h,u,n)})),this.gl.bindTexture(this.target,null)}copyFramebuffer(e={}){return s.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e=this.textureUnit){const{gl:t}=this;return void 0!==e&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(e=this.textureUnit){const{gl:t}=this;return void 0!==e&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType({data:e,compressed:t=!1}){return t?{data:e,dataType:"compressed"}:null===e?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof Ze?{data:e.handle,dataType:"buffer"}:"undefined"!=typeof WebGLBuffer&&e instanceof WebGLBuffer?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(e){const{format:t,data:r}=e;let{width:n,height:i,dataFormat:s,type:a,compressed:o}=e;const l=We(t);return s=s||l.dataFormat,a=a||l.type,o=o||l.compressed,({width:n,height:i}=this._deduceImageSize(r,n,i)),{dataFormat:s,type:a,compressed:o,width:n,height:i,format:t,data:r}}_deduceImageSize(t,r,n){let i;return i="undefined"!=typeof ImageData&&t instanceof ImageData?{width:t.width,height:t.height}:"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement?{width:t.naturalWidth,height:t.naturalHeight}:"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?{width:t.width,height:t.height}:"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t?{width:r,height:n}:{width:r>=0?r:1,height:n>=0?n:1},e(i,"Could not deduced texture size"),e(void 0===r||i.width===r,"Deduced texture width does not match supplied width"),e(void 0===n||i.height===n,"Deduced texture height does not match supplied height"),i}async setCubeMapImageData(e){const{gl:t}=this,{width:r,height:n,pixels:i,data:a,format:o=6408,type:l=5121}=e,c=i||a,u=await Promise.all(nt.FACES.map((e=>{const t=c[e];return Promise.all(Array.isArray(t)?t:[t])})));this.bind(),nt.FACES.forEach(((e,i)=>{u[i].length>1&&!1!==this.props.mipmaps&&s.warn(`${this.id} has mipmap and multiple LODs.`)(),u[i].forEach(((i,s)=>{r&&n?t.texImage2D(e,s,o,r,n,0,o,l,i):t.texImage2D(e,s,o,o,l,i)}))})),this.unbind()}setImageDataForFace(e){const{face:t,width:r,height:n,pixels:i,data:s,format:a=6408,type:o=5121}=e,{gl:l}=this,c=i||s;return this.bind(),c instanceof Promise?c.then((r=>this.setImageDataForFace(Object.assign({},e,{face:t,data:r,pixels:r})))):this.width||this.height?l.texImage2D(t,0,a,r,n,0,a,o,c):l.texImage2D(t,0,a,a,o,c),this}setImageData3D(e){const{level:t=0,dataFormat:r,format:n,type:i,width:s,height:a,depth:o=1,offset:l=0,data:c,parameters:u={}}=e;this.trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle);const h=We(n);if($e(this.gl,u,(()=>{ArrayBuffer.isView(c)&&this.gl.texImage3D(this.target,t,h.format,s,a,o,0,h.dataFormat,h.type,c),c instanceof Ze&&(this.gl.bindBuffer(35052,c.handle),this.gl.texImage3D(this.target,t,r,s,a,o,0,n,i,l))})),c&&c.byteLength)this.trackAllocatedMemory(c.byteLength,"Texture");else{const e=Ie(this.props.format);this.trackAllocatedMemory(this.width*this.height*this.depth*e,"Texture")}return this.loaded=!0,this}_setSamplerParameters(e){if(!i(e)){!function(e){s.log(1,"texture sampler parameters",e)()}(e),this.gl.bindTexture(this.target,this.handle);for(const[t,r]of Object.entries(e)){const e=Number(t),n=r;switch(e){case 33082:case 33083:this.gl.texParameterf(this.target,e,n);break;default:this.gl.texParameteri(this.target,e,n)}}this.gl.bindTexture(this.target,null)}}}class it extends h{device;gl;handle;get texture(){return this.colorAttachments[0]}constructor(e,t){super(e,t);const r=null===t.handle;if(this.device=e,this.gl=e.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),!r){e.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures();const r=this.gl.bindFramebuffer(36160,this.handle);for(let e=0;e<this.colorAttachments.length;++e){const t=this.colorAttachments[e],r=36064+e;t&&this._attachOne(r,t)}if(this.depthStencilAttachment&&this._attachOne(function(e){const t=Pe[e];if(!t?.attachment)throw new Error(`${e} is not a depth stencil format`);return t.attachment}(this.depthStencilAttachment.props.format),this.depthStencilAttachment),!1!==t.check){const e=this.gl.checkFramebufferStatus(36160);if(36053!==e)throw new Error(`Framebuffer ${function(e){switch(e){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${e}`}}(e)}`)}this.gl.bindFramebuffer(36160,r)}}destroy(){super.destroy(),this.destroyed||null===this.handle||this.gl.deleteFramebuffer(this.handle)}createDepthStencilTexture(e){return new nt(this.device,{id:`${this.id}-depth-stencil`,format:e,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(e,t){if(null===this.handle)return this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;void 0===e&&(e=this.gl.drawingBufferWidth),void 0===t&&(t=this.gl.drawingBufferHeight);for(const r of this.colorAttachments)r.texture.resize({width:e,height:t});return this.depthStencilAttachment&&this.depthStencilAttachment.texture.resize({width:e,height:t}),this}_attachOne(e,t){if(Array.isArray(t)){const[r,n=0,i=0]=t;return this._attachTexture(e,r,n,i),r}if(t instanceof nt)return this._attachTexture(e,t,0,0),t;if(t instanceof tt){const r=t;return this._attachTexture(e,r.texture,r.props.baseMipLevel,r.props.baseArrayLayer),t.texture}throw new Error("attach")}_attachTexture(t,r,n,i){const{gl:s}=this.device;switch(s.bindTexture(r.target,r.handle),r.target){case 35866:case 32879:s.framebufferTextureLayer(36160,t,r.target,i,n);break;case 34067:const a=function(e){return e<34069?e+34069:e}(n);s.framebufferTexture2D(36160,t,a,r.handle,i);break;case 3553:s.framebufferTexture2D(36160,t,3553,r.handle,i);break;default:e(!1,"Illegal texture type")}s.bindTexture(r.target,null)}}class st extends d{device;presentationSize;_framebuffer=null;constructor(e,t){super(t),this.device=e,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new it(this.device,{handle:null}),this._framebuffer}update(){const e=this.getPixelSize();(e[0]!==this.presentationSize[0]||e[1]!==this.presentationSize[1])&&(this.presentationSize=e,this.resize())}resize(e){if(this.device.gl)if(this.canvas){const t=this.getDevicePixelRatio(e?.useDevicePixels);this.setDevicePixelRatio(t,e)}else;}commit(){}}const at={spector:s.get("spector")||s.get("inspect")};let ot=null,lt=!1;function ct(e){return e.luma=e.luma||{},e.luma}function ut(e,t={}){return e?t.debug?function(e,t){if(!globalThis.WebGLDebugUtils)return s.warn("webgl-debug not loaded")(),e;const r=ct(e);if(r.debugContext)return r.debugContext;globalThis.WebGLDebugUtils.init({...C,...e});const n=globalThis.WebGLDebugUtils.makeDebugContext(e,dt.bind(null,t),ft.bind(null,t));for(const e in C)e in n||"number"!=typeof C[e]||(n[e]=C[e]);class i{}Object.setPrototypeOf(n,Object.getPrototypeOf(e)),Object.setPrototypeOf(i,n);const a=Object.create(i);return r.realContext=e,r.debugContext=a,a.debug=!0,a}(e,t):function(e){const t=ct(e);return t.realContext?t.realContext:e}(e):null}function ht(e,t){t=Array.from(t).map((e=>void 0===e?"undefined":e));let r=globalThis.WebGLDebugUtils.glFunctionArgsToString(e,t);return r=`${r.slice(0,100)}${r.length>100?"...":""}`,`gl.${e}(${r})`}function dt(e,t,r,n){n=Array.from(n).map((e=>void 0===e?"undefined":e));const i=`${globalThis.WebGLDebugUtils.glEnumToString(t)} in gl.${r}(${globalThis.WebGLDebugUtils.glFunctionArgsToString(r,n)})`;if(s.error(i)(),e.throwOnError)throw new Error(i)}function ft(e,t,r){let n="";if(s.level>=1&&(n=ht(t,r),s.log(1,n)()),e.break&&e.break.length>0){n=n||ht(t,r);e.break.every((e=>-1!==n.indexOf(e)))}for(const i of r)if(void 0===i){if(n=n||ht(t,r),e.throwOnError)throw new Error(`Undefined argument: ${n}`);s.error(`Undefined argument: ${n}`)()}}function gt(e){const t=e.toLowerCase();return["warning","error","info"].includes(t)?t:"info"}class pt extends g{device;handle;constructor(e,t){switch(super(e,t),this.device=e,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){return function(e){const t=e.split(/\r?\n/),r=[];for(const e of t){if(e.length<=1)continue;const t=e.split(":");if(2===t.length){const[e,n]=t;r.push({message:n.trim(),type:gt(e),lineNum:0,linePos:0});continue}const[n,i,s,...a]=t;let o=parseInt(s,10);isNaN(o)&&(o=0);let l=parseInt(i,10);isNaN(l)&&(l=0),r.push({message:a.join(":").trim(),type:gt(n),lineNum:o,linePos:l})}return r}(this.device.gl.getShaderInfoLog(this.handle))}getTranslatedSource(){const e=this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders;return e?.getTranslatedShaderSource(this.handle)}async _compile(e){e=(e=>e.startsWith("#version ")?e:`#version 100\n${e}`)(e);const{gl:t}=this.device;if(t.shaderSource(this.handle,e),t.compileShader(this.handle),0!==s.level){if(this.device.features.has("compilation-status-async-webgl"))s.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),s.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader();else if(this._getCompilationStatus(),this.debugShader(),"error"===this.compilationStatus)throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`)}else this.compilationStatus="pending"}async _waitForCompilationComplete(){const e=async e=>await new Promise((t=>setTimeout(t,e)));if(!this.device.features.has("compilation-status-async-webgl"))return void await e(10);const{gl:t}=this.device;for(;;){if(t.getShaderParameter(this.handle,37297))return;await e(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}const mt=6144,bt=[1,2,4,8];class yt extends p{device;glParameters;constructor(e,t){super(e,t),this.device=e,re(this.device.gl),this.setParameters(this.props.parameters),this.clear()}end(){ne(this.device.gl)}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}setParameters(e={}){const t={...this.glParameters};this.props.framebuffer&&(t.framebuffer=this.props.framebuffer),this.props.depthReadOnly&&(t.depthMask=!this.props.depthReadOnly),t.stencilMask=this.props.stencilReadOnly?0:1,t[35977]=this.props.discard,e.viewport&&(e.viewport.length>=6?(t.viewport=e.viewport.slice(0,4),t.depthRange=[e.viewport[4],e.viewport[5]]):t.viewport=e.viewport),e.scissorRect&&(t.scissorTest=!0,t.scissor=e.scissorRect),e.blendConstant&&(t.blendColor=e.blendConstant),e.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),e[2967]=e.stencilReference),e.colorMask&&(t.colorMask=bt.map((t=>Boolean(t&e.colorMask)))),this.glParameters=t,X(this.device.gl,t)}beginOcclusionQuery(e){const t=this.props.occlusionQuerySet;t?.beginOcclusionQuery()}endOcclusionQuery(){const e=this.props.occlusionQuerySet;e?.endOcclusionQuery()}clear(){const e={...this.glParameters};let t=0;!1!==this.props.clearColor&&(t|=16384,e.clearColor=this.props.clearColor),!1!==this.props.clearDepth&&(t|=256,e.clearDepth=this.props.clearDepth),!1!==this.props.clearStencil&&(t|=1024,e.clearStencil=this.props.clearStencil),0!==t&&$e(this.device.gl,e,(()=>{this.device.gl.clear(t)}))}clearColorBuffer(e=0,t=[0,0,0,0]){$e(this.device.gl,{framebuffer:this.props.framebuffer},(()=>{switch(t.constructor){case Int32Array:this.device.gl.clearBufferiv(mt,e,t);break;case Uint32Array:this.device.gl.clearBufferuiv(mt,e,t);break;case Float32Array:default:this.device.gl.clearBufferfv(mt,e,t)}}))}}const vt="Failed to deduce GL constant from typed array";function xt(e,t){const{clamped:r=!0}=t||{};switch(e){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return r?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}const wt={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},_t={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class St{offset;stride;type;size;divisor;normalized;integer;buffer;index;static getBytesPerElement(e){return xt(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(t){e(t.size);return xt(t.type||5126).BYTES_PER_ELEMENT*t.size}static resolve(...e){return new St(...[wt,...e])}constructor(...e){e.forEach((e=>this._assign(e))),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return St.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return St.getBytesPerVertex(this)}_assign(e={}){return void 0!==(e=m("Accessor",e,_t)).type&&(this.type=e.type,5124!==e.type&&5125!==e.type||(this.integer=!0)),void 0!==e.size&&(this.size=e.size),void 0!==e.offset&&(this.offset=e.offset),void 0!==e.stride&&(this.stride=e.stride),void 0!==e.normalize&&(this.normalized=e.normalize),void 0!==e.normalized&&(this.normalized=e.normalized),void 0!==e.integer&&(this.integer=e.integer),void 0!==e.divisor&&(this.divisor=e.divisor),void 0!==e.buffer&&(this.buffer=e.buffer),void 0!==e.index&&("boolean"==typeof e.index?this.index=e.index?1:0:this.index=e.index),void 0!==e.instanced&&(this.divisor=e.instanced?1:0),void 0!==e.isInstanced&&(this.divisor=e.isInstanced?1:0),void 0===this.offset&&delete this.offset,void 0===this.stride&&delete this.stride,void 0===this.type&&delete this.type,void 0===this.size&&delete this.size,void 0===this.divisor&&delete this.divisor,void 0===this.normalized&&delete this.normalized,void 0===this.integer&&delete this.integer,void 0===this.buffer&&delete this.buffer,void 0===this.index&&delete this.index,this}}const Ft=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],Et={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function Tt(e){const t=Et[e];if(!t)throw new Error("uniform");const[r,n,,i]=t;return{format:i,components:n,glType:r}}function At(e){const t=Et[e];if(!t)throw new Error("attribute");const[,r,,n,i]=t;return{attributeType:n,vertexFormat:i,components:r}}function Lt(e,t){const r={attributes:[],bindings:[]};r.attributes=function(e,t){const r=[],n=e.getProgramParameter(t,35721);for(let i=0;i<n;i++){const n=e.getActiveAttrib(t,i);if(!n)throw new Error("activeInfo");const{name:s,type:a}=n,o=e.getAttribLocation(t,s);if(o>=0){const{attributeType:e}=At(a),t=/instance/i.test(s)?"instance":"vertex";r.push({name:s,location:o,stepMode:t,type:e})}}return r.sort(((e,t)=>e.location-t.location)),r}(e,t);const n=function(e,t){const r=(r,n)=>e.getActiveUniformBlockParameter(t,r,n),n=[],i=e.getProgramParameter(t,35382);for(let s=0;s<i;s++){const i={name:e.getActiveUniformBlockName(t,s)||"",location:r(s,35391),byteLength:r(s,35392),vertex:r(s,35396),fragment:r(s,35398),uniformCount:r(s,35394),uniforms:[]},a=r(s,35395)||[],o=e.getActiveUniforms(t,a,35383),l=e.getActiveUniforms(t,a,35384),c=e.getActiveUniforms(t,a,35387),u=e.getActiveUniforms(t,a,35388);for(let r=0;r<i.uniformCount;++r){const n=e.getActiveUniform(t,a[r]);if(!n)throw new Error("activeInfo");i.uniforms.push({name:n.name,format:Tt(o[r]).format,type:o[r],arrayLength:l[r],byteOffset:c[r],byteStride:u[r]})}n.push(i)}return n.sort(((e,t)=>e.location-t.location)),n}(e,t);for(const e of n){const t=e.uniforms.map((e=>({name:e.name,format:e.format,byteOffset:e.byteOffset,byteStride:e.byteStride,arrayLength:e.arrayLength})));r.bindings.push({type:"uniform",name:e.name,location:e.location,visibility:(e.vertex?1:0)&(e.fragment?2:0),minBindingSize:e.byteLength,uniforms:t})}const i=function(e,t){const r=[],n=e.getProgramParameter(t,35718);for(let i=0;i<n;i++){const n=e.getActiveUniform(t,i);if(!n)throw new Error("activeInfo");const{name:s,size:a,type:o}=n,{name:l,isArray:c}=kt(s);let u=e.getUniformLocation(t,l);const h={location:u,name:l,size:a,type:o,isArray:c};if(r.push(h),h.size>1)for(let n=0;n<h.size;n++){const i=`${l}[${n}]`;u=e.getUniformLocation(t,i);const s={...h,name:i,location:u};r.push(s)}}return r}(e,t);let s=0;for(const e of i)if(a=e.type,Ft.includes(a)){const{viewDimension:t,sampleType:n}=Pt(e.type);r.bindings.push({type:"texture",name:e.name,location:s,viewDimension:t,sampleType:n}),e.textureUnit=s,s+=1}var a;i.length&&(r.uniforms=i);const o=function(e,t){const r=[],n=e.getProgramParameter(t,35971);for(let i=0;i<n;i++){const n=e.getTransformFeedbackVarying(t,i);if(!n)throw new Error("activeInfo");const{name:s,type:a,size:o}=n,{glType:l,components:c}=Tt(a),u={location:i,name:s,accessor:new St({type:l,size:o*c})};r.push(u)}return r.sort(((e,t)=>e.location-t.location)),r}(e,t);return o?.length&&(r.varyings=o),r}const Bt={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function Pt(e){const t=Bt[e];if(!t)throw new Error("sampler");const[r,n]=t;return{viewDimension:r,sampleType:n}}function kt(e){if("]"!==e[e.length-1])return{name:e,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(e);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${e}`);return{name:t[1],length:t[2]?1:0,isArray:Boolean(t[2])}}function Ct(e,t,r,n){const i=e;let s=n;!0===s&&(s=1),!1===s&&(s=0);const a="number"==typeof s?[s]:s;switch(r){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if("number"!=typeof n)throw new Error("samplers must be set to integers");return e.uniform1i(t,n);case 5126:return e.uniform1fv(t,a);case 35664:return e.uniform2fv(t,a);case 35665:return e.uniform3fv(t,a);case 35666:return e.uniform4fv(t,a);case 5124:case 35670:return e.uniform1iv(t,a);case 35667:case 35671:return e.uniform2iv(t,a);case 35668:case 35672:return e.uniform3iv(t,a);case 35669:case 35673:return e.uniform4iv(t,a);case 5125:return i.uniform1uiv(t,a,1);case 36294:return i.uniform2uiv(t,a,2);case 36295:return i.uniform3uiv(t,a,3);case 36296:return i.uniform4uiv(t,a,4);case 35674:return e.uniformMatrix2fv(t,!1,a);case 35675:return e.uniformMatrix3fv(t,!1,a);case 35676:return e.uniformMatrix4fv(t,!1,a);case 35685:return i.uniformMatrix2x3fv(t,!1,a);case 35686:return i.uniformMatrix2x4fv(t,!1,a);case 35687:return i.uniformMatrix3x2fv(t,!1,a);case 35688:return i.uniformMatrix3x4fv(t,!1,a);case 35689:return i.uniformMatrix4x2fv(t,!1,a);case 35690:return i.uniformMatrix4x3fv(t,!1,a)}throw new Error("Illegal uniform")}class Dt extends b{device;handle;vs;fs;introspectedLayout;uniforms={};bindings={};varyings=null;_uniformCount=0;_uniformSetters={};constructor(e,t){super(e,t),this.device=e,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=y(t.vs),this.fs=y(t.fs);const{varyings:r,bufferMode:n=35981}=t;switch(r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,n)),this._linkShaders(),s.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=Lt(this.device.gl,this.handle),s.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=v(this.introspectedLayout,t.shaderLayout),this.props.topology){case"triangle-fan-webgl":case"line-loop-webgl":s.warn(`Primitive topology ${this.props.topology} is deprecated and will be removed in v9.1`)}}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(e,t){for(const[r,n]of Object.entries(e)){const e=this.shaderLayout.bindings.find((e=>e.name===r))||this.shaderLayout.bindings.find((e=>e.name===`${r}Uniforms`));if(e){switch(n||s.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),e.type){case"uniform":if(!(n instanceof Ze||n.buffer instanceof Ze))throw new Error("buffer value");break;case"texture":if(!(n instanceof tt||n instanceof nt||n instanceof it))throw new Error("texture value");break;case"sampler":s.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(e.type)}this.bindings[r]=n}else{const e=this.shaderLayout.bindings.map((e=>`"${e.name}"`)).join(", ");t?.disableWarnings||s.warn(`Unknown binding "${r}" in render pipeline "${this.id}", expected one of ${e}`)()}}}draw(e){const{renderPass:t,parameters:r=this.props.parameters,topology:n=this.props.topology,vertexArray:a,vertexCount:o,instanceCount:l,firstVertex:c=0,transformFeedback:u}=e,h=function(e){switch(e){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"line-loop-webgl":return 2;case"triangle-list":return 4;case"triangle-strip":return 5;case"triangle-fan-webgl":return 6;default:throw new Error(e)}}(n),d=Boolean(a.indexBuffer),f=a.indexBuffer?.glIndexType,g=Number(l)>0;if("success"!==this.linkStatus)return s.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable()||0===o)return s.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;if(0===o)return s.info(2,`RenderPipeline:${this.id}.draw() aborted - no vertices to draw`)(),!0;this.device.gl.useProgram(this.handle),a.bindBeforeRender(t),u&&u.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const p=t;return function(e,t,r,n){if(i(t))return n(e);const s=e;re(s.gl);try{return Ne(e,t),X(s.gl,r),n(e)}finally{ne(s.gl)}}(this.device,r,p.glParameters,(()=>{d&&g?this.device.gl.drawElementsInstanced(h,o||0,f,c,l||0):d?this.device.gl.drawElements(h,o||0,f,c):g?this.device.gl.drawArraysInstanced(h,c,o||0,l||0):this.device.gl.drawArrays(h,c,o||0),u&&u.end()})),a.unbindAfterRender(t),!0}setUniformsWebGL(e){const{bindings:t}=x(e);Object.keys(t).forEach((e=>{s.warn(`Unsupported value "${JSON.stringify(t[e])}" used in setUniforms() for key ${e}. Use setBindings() instead?`)()})),Object.assign(this.uniforms,e)}async _linkShaders(){const{gl:e}=this.device;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),s.time(4,`linkProgram for ${this.id}`)(),e.linkProgram(this.handle),s.timeEnd(4,`linkProgram for ${this.id}`)(),s.level,!this.device.features.has("compilation-status-async-webgl")){const e=this._getLinkStatus();return void this._reportLinkStatus(e)}s.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),s.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const t=this._getLinkStatus();this._reportLinkStatus(t)}_reportLinkStatus(e){if("success"!==e){if("error"===this.vs.compilationStatus)throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);if("error"===this.fs?.compilationStatus)throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);throw new Error(`Error during ${e}: ${this.device.gl.getProgramInfoLog(this.handle)}`)}}_getLinkStatus(){const{gl:e}=this.device;if(!e.getProgramParameter(this.handle,35714))return this.linkStatus="error","linking";e.validateProgram(this.handle);return e.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")}async _waitForLinkComplete(){const e=async e=>await new Promise((t=>setTimeout(t,e)));if(!this.device.features.has("compilation-status-async-webgl"))return void await e(10);const{gl:t}=this.device;for(;;){if(t.getProgramParameter(this.handle,37297))return;await e(10)}}_areTexturesRenderable(){let e=!0;for(const[,t]of Object.entries(this.bindings))t instanceof nt&&(t.update(),e=e&&t.loaded);return e}_applyBindings(){if("success"!==this.linkStatus)return;const{gl:e}=this.device;e.useProgram(this.handle);let t=0,r=0;for(const n of this.shaderLayout.bindings){const i=this.bindings[n.name]||this.bindings[n.name.replace(/Uniforms$/,"")];if(!i)throw new Error(`No value for binding ${n.name} in ${this.id}`);switch(n.type){case"uniform":const{name:a}=n,o=e.getUniformBlockIndex(this.handle,a);if(4294967295===o)throw new Error(`Invalid uniform block name ${a}`);e.uniformBlockBinding(this.handle,r,o),i instanceof Ze?e.bindBufferBase(35345,r,i.handle):e.bindBufferRange(35345,r,i.buffer.handle,i.offset||0,i.size||i.buffer.byteLength-i.offset),r+=1;break;case"texture":if(!(i instanceof tt||i instanceof nt||i instanceof it))throw new Error("texture");let l;if(i instanceof tt)l=i.texture;else if(i instanceof nt)l=i;else{if(!(i instanceof it&&i.colorAttachments[0]instanceof tt))throw new Error("No texture");s.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),l=i.colorAttachments[0].texture}e.activeTexture(33984+t),e.bindTexture(l.target,l.handle),t+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${n.type}' not supported in WebGL`)}}}_applyUniforms(){for(const e of this.shaderLayout.uniforms||[]){const{name:t,location:r,type:n,textureUnit:i}=e,s=this.uniforms[t]??i;void 0!==s&&Ct(this.device.gl,r,n,s)}}}class Ot extends w{device;commands=[];constructor(e){super(e,{}),this.device=e}submitCommands(e=this.commands){for(const t of e)switch(t.name){case"copy-buffer-to-buffer":Mt(this.device,t.options);break;case"copy-buffer-to-texture":Wt(this.device,t.options);break;case"copy-texture-to-buffer":It(this.device,t.options);break;case"copy-texture-to-texture":Rt(this.device,t.options)}}}function Mt(e,t){const r=t.source,n=t.destination;e.gl.bindBuffer(36662,r.handle),e.gl.bindBuffer(36663,n.handle),e.gl.copyBufferSubData(36662,36663,t.sourceOffset??0,t.destinationOffset??0,t.size),e.gl.bindBuffer(36662,null),e.gl.bindBuffer(36663,null)}function Wt(e,t){throw new Error("Not implemented")}function It(e,t){const{source:r,mipLevel:n=0,aspect:i="all",width:s=t.source.width,height:a=t.source.height,depthOrArrayLayers:o=0,origin:l=[0,0],destination:c,byteOffset:u=0,bytesPerRow:h,rowsPerImage:d}=t;if("all"!==i)throw new Error("not supported");if(0!==n||0!==o||h||d)throw new Error("not implemented");const{framebuffer:f,destroyFramebuffer:g}=Ut(r);let p;try{const t=c,r=s||f.width,n=a||f.height,i=We(f.texture.props.format),o=i.dataFormat,h=i.type;e.gl.bindBuffer(35051,t.handle),p=e.gl.bindFramebuffer(36160,f.handle),e.gl.readPixels(l[0],l[1],r,n,o,h,u)}finally{e.gl.bindBuffer(35051,null),void 0!==p&&e.gl.bindFramebuffer(36160,p),g&&f.destroy()}}function Rt(e,t){const{source:r,destinationMipLevel:n=0,origin:i=[0,0],destinationOrigin:s=[0,0],destination:a}=t;let{width:o=t.destination.width,height:l=t.destination.height}=t;const{framebuffer:c,destroyFramebuffer:u}=Ut(r),[h,d]=i,[f,g,p]=s,m=e.gl.bindFramebuffer(36160,c.handle);let b,y=null;if(!(a instanceof nt))throw new Error("invalid destination");switch(y=a,o=Number.isFinite(o)?o:y.width,l=Number.isFinite(l)?l:y.height,y.bind(0),b=y.target,b){case 3553:case 34067:e.gl.copyTexSubImage2D(b,n,f,g,h,d,o,l);break;case 35866:case 32879:e.gl.copyTexSubImage3D(b,n,f,g,p,h,d,o,l)}y&&y.unbind(),e.gl.bindFramebuffer(36160,m),u&&c.destroy()}function Ut(e){if(e instanceof c){const{width:t,height:r,id:n}=e;return{framebuffer:e.device.createFramebuffer({id:`framebuffer-for-${n}`,width:t,height:r,colorAttachments:[e]}),destroyFramebuffer:!0}}return{framebuffer:e,destroyFramebuffer:!1}}class Gt extends _{device;commandBuffer;constructor(e,t){super(e,t),this.device=e,this.commandBuffer=new Ot(e)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(e){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:e})}copyBufferToTexture(e){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:e})}copyTextureToBuffer(e){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:e})}copyTextureToTexture(e){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:e})}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}resolveQuerySet(e,t,r){}}class zt extends S{get[Symbol.toStringTag](){return"VertexArray"}device;handle;buffer=null;bufferValue=null;static isConstantAttributeZeroSupported(e){return"Chrome"===O()}constructor(e,t){super(e,t),this.device=e,this.handle=this.device.gl.createVertexArray()}destroy(){super.destroy(),this.buffer&&this.buffer?.destroy(),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(e){const t=e;if(t&&34963!==t.glTarget)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,t?t.handle:null),this.indexBuffer=t,this.device.gl.bindVertexArray(null)}setBuffer(e,t){const r=t;if(34963===r.glTarget)throw new Error("Use .setIndexBuffer()");const{size:n,type:i,stride:s,offset:a,normalized:o,integer:l,divisor:c}=this._getAccessor(e);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),l?this.device.gl.vertexAttribIPointer(e,n,i,s,a):this.device.gl.vertexAttribPointer(e,n,i,o,s,a),this.device.gl.enableVertexAttribArray(e),this.device.gl.vertexAttribDivisor(e,c||0),this.attributes[e]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(e,t){this._enable(e,!1),this.attributes[e]=t}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let e=0;e<this.maxVertexAttributes;++e){const t=this.attributes[e];ArrayBuffer.isView(t)&&this.device.setConstantAttributeWebGL(e,t)}}_getAccessor(e){const t=this.attributeInfos[e];if(!t)throw new Error(`Unknown attribute location ${e}`);const r=ue(t.bufferDataType);return{size:t.bufferComponents,type:r,stride:t.byteStride,offset:t.byteOffset,normalized:t.normalized,integer:t.integer,divisor:"instance"===t.stepMode?1:0}}_enable(e,t=!0){const r=zt.isConstantAttributeZeroSupported(this.device);(t||(r||0!==e))&&(e=Number(e),this.device.gl.bindVertexArray(this.handle),t?this.device.gl.enableVertexAttribArray(e):this.device.gl.disableVertexAttribArray(e),this.device.gl.bindVertexArray(null))}getConstantBuffer(e,t){const r=function(e){if(Array.isArray(e))return new Float32Array(e);return e}(t),n=r.byteLength*e,i=r.length*e;if(this.buffer&&n!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${n} !== ${this.buffer.byteLength}.`);let s=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:n}),s=s||!function(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}(r,this.bufferValue),s){const e=F(t.constructor,i);E({target:e,source:r,start:0,count:i}),this.buffer.write(e),this.bufferValue=t}return this.buffer}}class $t extends T{device;gl;handle;layout;buffers={};unusedBuffers={};bindOnUse=!0;_bound=!1;constructor(e,t){super(e,t),this.device=e,this.gl=e.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,t.buffers&&this.setBuffers(t.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(e="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(function(e){switch(e){case"point-list":return 0;case"line-list":case"line-strip":case"line-loop-webgl":return 1;case"triangle-list":case"triangle-strip":case"triangle-fan-webgl":return 4;default:throw new Error(e)}}(e))}end(){this.gl.endTransformFeedback(),this.bindOnUse||this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(e){this.buffers={},this.unusedBuffers={},this.bind((()=>{for(const t in e)this.setBuffer(t,e[t])}))}setBuffer(e,t){const r=this._getVaryingIndex(e),{buffer:n,byteLength:i,byteOffset:a}=this._getBufferRange(t);if(r<0)return this.unusedBuffers[e]=n,void s.warn(`${this.id} unusedBuffers varying buffer ${e}`)();this.buffers[r]={buffer:n,byteLength:i,byteOffset:a},this.bindOnUse||this._bindBuffer(r,n,a,i)}getBuffer(e){if(Vt(e))return this.buffers[e]||null;const t=this._getVaryingIndex(e);return t>=0?this.buffers[t]:null}bind(e=this.handle){if("function"!=typeof e)return this.gl.bindTransformFeedback(36386,e),this;let t;return this._bound?t=e():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,t=e(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),t}unbind(){this.bind(null)}_getBufferRange(e){if(e instanceof Ze)return{buffer:e,byteOffset:0,byteLength:e.byteLength};const{buffer:t,byteOffset:r=0,byteLength:n=e.buffer.byteLength}=e;return{buffer:t,byteOffset:r,byteLength:n}}_getVaryingIndex(e){if(Vt(e))return Number(e);for(const t of this.layout.varyings)if(e===t.name)return t.location;return-1}_bindBuffers(){for(const e in this.buffers){const{buffer:t,byteLength:r,byteOffset:n}=this._getBufferRange(this.buffers[e]);this._bindBuffer(Number(e),t,n,r)}}_unbindBuffers(){for(const e in this.buffers)this.gl.bindBufferBase(35982,Number(e),null)}_bindBuffer(e,t,r=0,n){const i=t&&t.handle;i&&void 0!==n?this.gl.bindBufferRange(35982,e,i,r,n):this.gl.bindBufferBase(35982,e,i)}}function Vt(e){return"number"==typeof e?Number.isInteger(e):/^\d+$/.test(e)}class Nt extends A{device;handle;target=null;_queryPending=!1;_pollingPromise=null;get[Symbol.toStringTag](){return"Query"}constructor(e,t){if(super(e,t),this.device=e,t.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(e){return this._begin(e?.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(e){this._queryPending||(this.target=e,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.device.gl.getQueryParameter(this.handle,34919);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise(((r,n)=>{const i=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):t++>e?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(i)};requestAnimationFrame(i)})),this._pollingPromise}}function jt(t){switch(t){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return e(!1),0}}function Ht(t,r){const{sourceX:n=0,sourceY:i=0,sourceFormat:s=6408,sourceAttachment:a=36064}=r||{};let{target:o=null,sourceWidth:l,sourceHeight:c,sourceType:u}=r||{};const{framebuffer:h,deleteFramebuffer:d}=qt(t);e(h);const{gl:f,handle:g}=h;l=l||h.width,c=c||h.height;const p=a-36064;u=u||h.colorAttachments[p]?.texture?.type||5121,o=function(e,t,r,n,i){if(e)return e;const s=xt(t=t||5121,{clamped:!1}),a=jt(r);return new s(n*i*a)}(o,u,s,l,c),u=u||function(e){switch(ArrayBuffer.isView(e)?e.constructor:e){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(vt)}}(o);const m=f.bindFramebuffer(36160,g);return f.readPixels(n,i,l,c,s,u,o),f.bindFramebuffer(36160,m||null),d&&h.destroy(),o}function Qt(t,r){const{target:n,sourceX:i=0,sourceY:s=0,sourceFormat:a=6408,targetByteOffset:o=0}=r||{};let{sourceWidth:l,sourceHeight:c,sourceType:u}=r||{};const{framebuffer:h,deleteFramebuffer:d}=qt(t);e(h),l=l||h.width,c=c||h.height;const f=h;u=u||5121;let g=n;if(!g){const t=o+l*c*jt(a)*function(t){switch(t){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return e(!1),0}}(u);g=f.device.createBuffer({byteLength:t})}const p=t.device.createCommandEncoder();return p.copyTextureToBuffer({source:t,width:l,height:c,origin:[i,s],destination:g,byteOffset:o}),p.destroy(),d&&h.destroy(),g}function qt(e){return e instanceof h?{framebuffer:e,deleteFramebuffer:!1}:{framebuffer:Xt(e),deleteFramebuffer:!0}}function Xt(e,t){const{device:r,width:n,height:i,id:s}=e;return r.createFramebuffer({...t,id:`framebuffer-for-${s}`,width:n,height:i,colorAttachments:[e]})}class Yt extends L{static type="webgl";type="webgl";handle;features;limits;info;canvasContext;lost;_resolveContextLost;static isSupported(){return"undefined"!=typeof WebGL2RenderingContext}static attach(e){if(e instanceof Yt)return e;if(e?.device instanceof L)return e.device;if(!function(e){if("undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext)return!0;return Boolean(e&&Number.isFinite(e._version))}(e))throw new Error("Invalid WebGL2RenderingContext");return new Yt({gl:e})}static async create(e={}){s.groupCollapsed(1,"WebGLDevice created")();const t=[];e.debug&&t.push(async function(){D()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await f("https://unpkg.com/webgl-debug@2.0.1/index.js"))}()),e.spector&&t.push(async function(e){if(!globalThis.SPECTOR)try{await f("https://spectorcdn.babylonjs.com/spector.bundle.js")}catch(e){s.warn(String(e))}}()),"string"==typeof e.canvas&&t.push(d.pageLoaded);const r=await Promise.allSettled(t);for(const e of r)"rejected"===e.status&&s.error(`Failed to initialize debug libraries ${e.reason}`)();if(s.probe(2,"DOM is loaded")(),e.gl?.device)return s.warn("reattaching existing device")(),Yt.attach(e.gl);const n=new Yt(e),i=`Created ${n.type}${n.debug?" debug":""} context: ${n.info.vendor}, ${n.info.renderer} for canvas: ${n.canvasContext.id}`;return s.probe(1,i)(),s.table(1,n.info)(),s.groupEnd(1)(),n}constructor(e){super({...e,id:e.id||B("webgl-device")});const t=e.gl?.device;if(t)throw new Error(`WebGL context already attached to device ${t.id}`);const r=e.gl?.canvas||e.canvas;this.canvasContext=new st(this,{...e,canvas:r}),this.lost=new Promise((e=>{this._resolveContextLost=e}));let n=e.gl||null;if(n||=function(e,t){t={...ae,...t};let r=null;const n=e=>r=e.statusMessage||r;e.addEventListener("webglcontextcreationerror",n,!1);let i=null;if(i||=e.getContext("webgl2",t),e.removeEventListener("webglcontextcreationerror",n,!1),!i)throw new Error(`Failed to create WebGL context: ${r||"Unknown error"}`);if(t.onContextLost){const{onContextLost:r}=t;e.addEventListener("webglcontextlost",(e=>r(e)),!1)}if(t.onContextRestored){const{onContextRestored:r}=t;e.addEventListener("webglcontextrestored",(e=>r(e)),!1)}return i}(this.canvasContext.canvas,{...e,onContextLost:e=>this._resolveContextLost?.({reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."})}),!n)throw new Error("WebGL context creation failed");this.handle=n,this.gl=n,this.gl.device=this,this.gl._version=2,this.info=le(this.gl,this._extensions),this.limits=new ze(this.gl),this.features=new Ge(this.gl,this._extensions,this.props.disabledFeatures),this.props.initalizeFeatures&&this.features.initializeFeatures(),this.canvasContext.resize();const{enable:i=!0,copyState:a=!1}=e;te(this.gl,{enable:i,copyState:a,log:(...e)=>s.log(1,...e)()}),e.debug&&(this.gl=ut(this.gl,{...e,throwOnError:!0}),this.debug=!0,s.level=Math.max(s.level,1),s.warn("WebGL debug mode activated. Performance reduced.")()),e.spector&&(this.spectorJS=function(e){if(e={...at,...e},!e?.spector)return null;if(!ot&&globalThis.SPECTOR&&(s.probe(1,"SPECTOR found and initialized")(),ot=new globalThis.SPECTOR.Spector,globalThis.luma&&(globalThis.luma.spector=ot)),!ot)return null;if(lt||(lt=!0,ot.spyCanvases(),ot?.onCaptureStarted.add((e=>s.info("Spector capture started:",e)())),ot?.onCapture.add((e=>{s.info("Spector capture complete:",e)(),ot?.getResultUI(),ot?.resultView.display(),ot?.resultView.addCapture(e)}))),e?.canvas){if("string"==typeof e.spector&&e.spector!==e.canvas.id)return ot;ot?.startCapture(e?.canvas,500),new Promise((e=>setTimeout(e,2e3))).then((e=>{s.info("Spector capture stopped after 2 seconds")(),ot?.stopCapture()}))}return ot}({...this.props,canvas:this.handle.canvas}))}destroy(){}get isLost(){return this.gl.isContextLost()}getSize(){return[this.gl.drawingBufferWidth,this.gl.drawingBufferHeight]}isTextureFormatSupported(e){return De(this.gl,e,this._extensions)}isTextureFormatFilterable(e){return function(e,r,n){if(!De(e,r,n))return!1;if(r.startsWith("depth")||r.startsWith("stencil"))return!1;try{if(t(r).signed)return!1}catch{return!1}return r.endsWith("32float")?Boolean(oe(e,"OES_texture_float_linear, extensions",n)):!r.endsWith("16float")||Boolean(oe(e,"OES_texture_half_float_linear, extensions",n))}(this.gl,e,this._extensions)}isTextureFormatRenderable(e){return function(e,t,r){return!!De(e,t,r)&&"number"!=typeof t}(this.gl,e,this._extensions)}createCanvasContext(e){throw new Error("WebGL only supports a single canvas")}createBuffer(e){const t=this._getBufferProps(e);return new Ze(this,t)}_createTexture(e){return new nt(this,e)}createExternalTexture(e){throw new Error("createExternalTexture() not implemented")}createSampler(e){return new et(this,e)}createShader(e){return new pt(this,e)}createFramebuffer(e){return new it(this,e)}createVertexArray(e){return new zt(this,e)}createTransformFeedback(e){return new $t(this,e)}createQuerySet(e){return new Nt(this,e)}createRenderPipeline(e){return new Dt(this,e)}beginRenderPass(e){return new yt(this,e)}createComputePipeline(e){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(e){throw new Error("ComputePass not supported in WebGL")}renderPass=null;createCommandEncoder(e){return new Gt(this,e)}submit(){this.renderPass?.end(),this.renderPass=null}readPixelsToArrayWebGL(e,t){return Ht(e,t)}readPixelsToBufferWebGL(e,t){return Qt(e,t)}setParametersWebGL(e){X(this.gl,e)}getParametersWebGL(e){return Y(this.gl,e)}withParametersWebGL(e,t){return $e(this.gl,e,t)}clearWebGL(t){!function(t,r){const{framebuffer:n=null,color:i=null,depth:s=null,stencil:a=null}=r||{},o={};n&&(o.framebuffer=n);let l=0;i&&(l|=16384,!0!==i&&(o.clearColor=i)),s&&(l|=256,!0!==s&&(o.clearDepth=s)),a&&(l|=1024,!0!==s&&(o.clearStencil=s)),e(0!==l,"clear: bad arguments");const c=t.gl;$e(c,o,(()=>{c.clear(l)}))}(this,t)}resetWebGL(){s.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),J(this.gl)}gl;debug=!1;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};_extensions={};_polyfilled=!1;spectorJS;loseDevice(){let e=!1;const t=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return t&&(e=!0,t.loseContext()),this._resolveContextLost?.({reason:"destroyed",message:"Application triggered context loss"}),e}pushState(){re(this.gl)}popState(){ne(this.gl)}setSpectorMetadata(e,t){e.__SPECTOR_Metadata=t}getGLKey(e,t){t=t||this.gl2||this.gl;const r=Number(e);for(const e in t)if(t[e]===r)return`GL.${e}`;return String(e)}_constants;setConstantAttributeWebGL(t,r){const n=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(n).fill(null);const i=this._constants[t];switch(i&&function(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}(i,r)&&s.info(1,`setConstantAttributeWebGL(${t}) could have been skipped, value unchanged`)(),this._constants[t]=r,r.constructor){case Float32Array:!function(t,r,n){switch(n.length){case 1:t.gl.vertexAttrib1fv(r,n);break;case 2:t.gl.vertexAttrib2fv(r,n);break;case 3:t.gl.vertexAttrib3fv(r,n);break;case 4:t.gl.vertexAttrib4fv(r,n);break;default:e(!1)}}(this,t,r);break;case Int32Array:!function(e,t,r){e.gl.vertexAttribI4iv(t,r)}(this,t,r);break;case Uint32Array:!function(e,t,r){e.gl.vertexAttribI4uiv(t,r)}(this,t,r);break;default:e(!1)}}getExtension(e){return oe(this.gl,e,this._extensions),this._extensions}}const Jt="Resource subclass must define virtual methods";class Kt extends P{device;gl;gl2;_handle;_bound=!1;byteLength=0;constructor(e,t,r){super(e,t,r),this.device=e;const n=this.device.gl,{id:i}=t||{};this.gl=n,this.gl2=n,this.id=i||B(this.constructor.name),this._handle=t?.handle,void 0===this._handle&&(this._handle=this._createHandle()),this.byteLength=0}toString(){return`${this.constructor.name}(${this.id})`}get handle(){return this._handle}delete({deleteChildren:e=!1}={}){const t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this.removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach((e=>e.destroy())),this}bind(e=this.handle){if("function"!=typeof e)return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}stubRemovedMethods(e,t,r){return k(this,e,t,r)}initialize(e){}_createHandle(){throw new Error(Jt)}_deleteHandle(){throw new Error(Jt)}_bindHandle(e){throw new Error(Jt)}_getOptsFromHandle(){throw new Error(Jt)}_getParameter(e,t){throw new Error(Jt)}_setParameter(e,t){throw new Error(Jt)}}class Zt extends Kt{static defaultProps={id:void 0,handle:void 0,userData:void 0,format:void 0,width:1,height:1,samples:0};get[Symbol.toStringTag](){return"Renderbuffer"}get width(){return this.props.width}get height(){return this.props.height}get format(){return this.props.format}get samples(){return this.props.samples}get attachment(){}glFormat;static isTextureFormatSupported(e,t){return function(e,t,r){return De(e,t,r)&&Pe[t]?.rb}(e.gl,t,e._extensions)}constructor(e,t){if("number"==typeof t.format)throw new Error("Renderbuffer");super(e,t,Zt.defaultProps),this.glFormat=Me(this.props.format),this._initialize(this.props)}resize(e){e.width===this.width&&e.height===this.height||(Object.assign(this.props,{...e,format:this.format,samples:this.samples}),this._initialize(this.props))}_initialize(t){const{format:r,width:n,height:i,samples:s}=t;e(r,"Needs format"),this.trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),0!==s?this.gl.renderbufferStorageMultisample(36161,s,this.glFormat,n,i):this.gl.renderbufferStorage(36161,this.glFormat,n,i),this.gl.bindRenderbuffer(36161,null),this.trackAllocatedMemory(n*i*(s||1)*Ie(this.format))}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this.trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}}export{St as Accessor,Ze as WEBGLBuffer,Gt as WEBGLCommandEncoder,it as WEBGLFramebuffer,yt as WEBGLRenderPass,Dt as WEBGLRenderPipeline,Kt as WEBGLResource,et as WEBGLSampler,pt as WEBGLShader,nt as WEBGLTexture,$t as WEBGLTransformFeedback,zt as WEBGLVertexArray,st as WebGLCanvasContext,Yt as WebGLDevice,Kt as WebGLResource,Pe as _TEXTURE_FORMATS,Zt as _WEBGLRenderbuffer,Oe as convertGLToTextureFormat,Y as getGLParameters,Lt as getShaderLayout,ne as popContextState,re as pushContextState,J as resetGLParameters,Ne as setDeviceParameters,X as setGLParameters,te as trackContextState,Ve as withDeviceParameters,$e as withGLParameters};export default null;
