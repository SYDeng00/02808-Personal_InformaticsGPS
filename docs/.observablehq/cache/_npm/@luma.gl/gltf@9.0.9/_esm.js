/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@luma.gl/gltf@9.0.9/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{log as e,assert as t}from"../core@9.0.9/_esm.js";import{loadImageTexture as n}from"../../@loaders.gl/textures@4.2.0/_esm.js";import{Model as r,ModelNode as a,GroupNode as i,Geometry as s}from"../engine@9.0.9/_esm.js";import{Matrix4 as o,Quaternion as l}from"../../@math.gl/core@4.0.1/_esm.js";import{pbr as m}from"../shadertools@9.0.9/_esm.js";var c;function u(t,n,r,a){const i={defines:{MANUAL_SRGB:1,SRGB_FAST_APPROXIMATION:1},bindings:{},uniforms:{u_Camera:[0,0,0],u_MetallicRoughnessValues:[1,1]},parameters:{},glParameters:{},generatedTextures:[]};i.defines.USE_TEX_LOD=1;const{imageBasedLightingEnvironment:s}=a;return s&&(i.bindings.u_DiffuseEnvSampler=s.diffuseEnvSampler,i.bindings.u_SpecularEnvSampler=s.specularEnvSampler,i.bindings.u_brdfLUT=s.brdfLutTexture,i.uniforms.u_ScaleIBLAmbient=[1,1]),a?.pbrDebug&&(i.defines.PBR_DEBUG=1,i.uniforms.u_ScaleDiffBaseMR=[0,0,0,0],i.uniforms.u_ScaleFGDSpec=[0,0,0,0]),r.NORMAL&&(i.defines.HAS_NORMALS=1),r.TANGENT&&a?.useTangents&&(i.defines.HAS_TANGENTS=1),r.TEXCOORD_0&&(i.defines.HAS_UV=1),a?.imageBasedLightingEnvironment&&(i.defines.USE_IBL=1),a?.lights&&(i.defines.USE_LIGHTS=1),n&&function(t,n,r){r.uniforms.pbr_uUnlit=Boolean(n.unlit),n.pbrMetallicRoughness&&function(e,t,n){t.baseColorTexture&&f(e,t.baseColorTexture,"u_BaseColorSampler","HAS_BASECOLORMAP",n);n.uniforms.u_BaseColorFactor=t.baseColorFactor||[1,1,1,1],t.metallicRoughnessTexture&&f(e,t.metallicRoughnessTexture,"u_MetallicRoughnessSampler","HAS_METALROUGHNESSMAP",n);const{metallicFactor:r=1,roughnessFactor:a=1}=t;n.uniforms.u_MetallicRoughnessValues=[r,a]}(t,n.pbrMetallicRoughness,r);if(n.normalTexture){f(t,n.normalTexture,"u_NormalSampler","HAS_NORMALMAP",r);const{scale:e=1}=n.normalTexture;r.uniforms.u_NormalScale=e}if(n.occlusionTexture){f(t,n.occlusionTexture,"u_OcclusionSampler","HAS_OCCLUSIONMAP",r);const{strength:e=1}=n.occlusionTexture;r.uniforms.u_OcclusionStrength=e}n.emissiveTexture&&(f(t,n.emissiveTexture,"u_EmissiveSampler","HAS_EMISSIVEMAP",r),r.uniforms.u_EmissiveFactor=n.emissiveFactor||[0,0,0]);switch(n.alphaMode){case"MASK":const{alphaCutoff:t=.5}=n;r.defines.ALPHA_CUTOFF=1,r.uniforms.u_AlphaCutoff=t;break;case"BLEND":e.warn("glTF BLEND alphaMode might not work well because it requires mesh sorting")(),r.parameters.blendColorOperation="add",r.parameters.blendColorSrcFactor="src-alpha",r.parameters.blendColorDstFactor="one-minus-src-alpha",r.parameters.blendAlphaOperation="add",r.parameters.blendAlphaSrcFactor="one",r.parameters.blendAlphaDstFactor="one-minus-src-alpha",r.glParameters.blend=!0,r.glParameters.blendEquation=c.FUNC_ADD,r.glParameters.blendFunc=[c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA,c.ONE,c.ONE_MINUS_SRC_ALPHA]}}(t,n,i),i}function f(e,t,n,r=null,a){const i=t?.texture?.sampler?.parameters||{},s=t.texture.source.image;let o,l={};s.compressed?(o=s,l={[c.TEXTURE_MIN_FILTER]:s.data.length>1?c.LINEAR_MIPMAP_NEAREST:c.LINEAR}):o={data:s};const m=e.createTexture({id:t.uniformName||t.id,parameters:{...i,...l},pixelStore:{[c.UNPACK_FLIP_Y_WEBGL]:!1},...o});a.bindings[n]=m,r&&(a.defines[r]=1),a.generatedTextures.push(m)}function p(e,t){return{brdfLutTexture:e.createTexture({id:"brdfLUT",sampler:{wrapS:"clamp-to-edge",wrapT:"clamp-to-edge",minFilter:"linear",maxFilter:"linear"},data:n(t.brdfLutUrl)}),diffuseEnvSampler:_(e,{id:"DiffuseEnvSampler",getTextureForFace:e=>n(t.getTexUrl("diffuse",e,0)),sampler:{wrapS:"clamp-to-edge",wrapT:"clamp-to-edge",minFilter:"linear",maxFilter:"linear"}}),specularEnvSampler:_(e,{id:"SpecularEnvSampler",getTextureForFace:e=>{const r=[];for(let a=0;a<=t.specularMipLevels-1;a++)r.push(n(t.getTexUrl("specular",e,a)));return r},sampler:{wrapS:"clamp-to-edge",wrapT:"clamp-to-edge",minFilter:"linear",maxFilter:"linear"}})}}!function(e){e[e.FUNC_ADD=32774]="FUNC_ADD",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",e[e.LINEAR=9729]="LINEAR",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL"}(c||(c={}));const d=[0,1,2,3,4,5];function _(e,{id:t,getTextureForFace:n,sampler:r}){const a={};return d.forEach((e=>{a[String(e)]=n(e)})),e.createTexture({id:t,dimension:"cube",mipmaps:!1,sampler:r,data:a})}const A={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},g={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};class h{name;startTime=0;playing=!0;speed=1;channels=[];constructor(e){Object.assign(this,e)}animate(n){if(!this.playing)return;const r=(n/1e3-this.startTime)*this.speed;this.channels.forEach((({sampler:n,target:a,path:i})=>{!function(n,{input:r,interpolation:a,output:i},s,o){const l=r[r.length-1],m=n%l,c=r.findIndex((e=>e>=m)),u=Math.max(0,c-1);if(!Array.isArray(s[o]))switch(o){case"translation":s[o]=[0,0,0];break;case"rotation":s[o]=[0,0,0,1];break;case"scale":s[o]=[1,1,1];break;default:e.warn(`Bad animation path ${o}`)()}t(s[o].length===i[u].length);const f=r[u],p=r[c];switch(a){case"STEP":!function(e,t,n){for(let r=0;r<n.length;r++)e[t][r]=n[r]}(s,o,i[u]);break;case"LINEAR":if(p>f){const e=(m-f)/(p-f);!function(e,t,n,r,a){if("rotation"===t){N.slerp({start:n,target:r,ratio:a});for(let n=0;n<N.length;n++)e[t][n]=N[n]}else for(let i=0;i<n.length;i++)e[t][i]=a*r[i]+(1-a)*n[i]}(s,o,i[u],i[c],e)}break;case"CUBICSPLINE":if(p>f){const e=(m-f)/(p-f),t=p-f;!function(e,t,{p0:n,outTangent0:r,inTangent1:a,p1:i,tDiff:s,ratio:o}){for(let l=0;l<e[t].length;l++){const m=r[l]*s,c=a[l]*s;e[t][l]=(2*Math.pow(o,3)-3*Math.pow(o,2)+1)*n[l]+(Math.pow(o,3)-2*Math.pow(o,2)+o)*m+(-2*Math.pow(o,3)+3*Math.pow(o,2))*i[l]+(Math.pow(o,3)-Math.pow(o,2))*c}}(s,o,{p0:i[3*u+1],outTangent0:i[3*u+2],inTangent1:i[3*c+0],p1:i[3*c+1],tDiff:t,ratio:e})}break;default:e.warn(`Interpolation ${a} not supported`)()}}(r,n,a,i),function(e,t){t.matrix.identity(),e.translation&&t.matrix.translate(e.translation);if(e.rotation){const n=S.fromQuaternion(e.rotation);t.matrix.multiplyRight(n)}e.scale&&t.matrix.scale(e.scale)}(a,a._node)}))}}class T{animations;constructor(e){this.animations=e.animations.map(((t,n)=>{const r=t.name||`Animation-${n}`,a=t.samplers.map((({input:t,interpolation:n="LINEAR",output:r})=>({input:E(e.accessors[t]),interpolation:n,output:E(e.accessors[r])}))),i=t.channels.map((({sampler:t,target:n})=>({sampler:a[t],target:e.nodes[n.node],path:n.path})));return new h({name:r,channels:i})}))}animate(e){this.setTime(e)}setTime(e){this.animations.forEach((t=>t.animate(e)))}getAnimations(){return this.animations}}function E(e){if(!e._animation){const t=g[e.componentType],n=A[e.type],r=n*e.count,{buffer:a,byteOffset:i}=e.bufferView.data,s=new t(a,i+(e.byteOffset||0),r);if(1===n)e._animation=Array.from(s);else{const t=[];for(let e=0;e<s.length;e+=n)t.push(Array.from(s.slice(e,e+n)));e._animation=t}}return e._animation}const S=new o;const N=new l;function L(e,t){return`#version 300 es\n${t}`}const I={modelOptions:{},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1};class R{device;options;gltf;constructor(e,t={}){this.device=e,this.options={...I,...t}}instantiate(e){this.gltf=e;return(e.scenes||[]).map((e=>this.createScene(e)))}createAnimator(){return Array.isArray(this.gltf.animations)?new T(this.gltf):null}createScene(e){const t=(e.nodes||[]).map((e=>this.createNode(e)));return new i({id:e.name||e.id,children:t})}createNode(e){if(!e._node){const t=(e.children||[]).map((e=>this.createNode(e)));e.mesh&&t.push(this.createMesh(e.mesh));const n=new i({id:e.name||e.id,children:t});if(e.matrix)n.setMatrix(e.matrix);else{if(n.matrix.identity(),e.translation&&n.matrix.translate(e.translation),e.rotation){const t=(new o).fromQuaternion(e.rotation);n.matrix.multiplyRight(t)}e.scale&&n.matrix.scale(e.scale)}e._node=n}return e._node}createMesh(e){if(!e._mesh){const t=(e.primitives||[]).map(((t,n)=>this.createPrimitive(t,n,e))),n=new i({id:e.name||e.id,children:t});e._mesh=n}return e._mesh}createPrimitive(t,n,i){const s=t.name||`${i.name||i.id}-primitive-${n}`,o=function(e){switch(e){case O.POINTS:return"point-list";case O.LINES:return"line-list";case O.LINE_STRIP:return"line-strip";case O.LINE_LOOP:return"line-loop-webgl";case O.TRIANGLES:return"triangle-list";case O.TRIANGLE_STRIP:return"triangle-strip";case O.TRIANGLE_FAN:return"triangle-fan-webgl";default:throw new Error(e)}}(t.mode||4),l=t.indices?t.indices.count:this.getVertexCount(t.attributes),c=function(t,n){const{id:i,geometry:s,material:o,vertexCount:l,materialOptions:c,modelOptions:f}=n,p=u(t,o,s.attributes,c);e.info(4,"createGLTFModel defines: ",p.defines)();const d={id:i,geometry:s,topology:s.topology,vertexCount:l,modules:[m],vs:L(0,"\n#pragma vscode_glsllint_stage: vert\n#if (__VERSION__ < 300)\n  #define _attr attribute\n#else\n  #define _attr in\n#endif\n\n  // _attr vec4 POSITION;\n  _attr vec4 positions;\n\n  #ifdef HAS_NORMALS\n    // _attr vec4 NORMAL;\n    _attr vec4 normals;\n  #endif\n\n  #ifdef HAS_TANGENTS\n    _attr vec4 TANGENT;\n  #endif\n\n  #ifdef HAS_UV\n    // _attr vec2 TEXCOORD_0;\n    _attr vec2 texCoords;\n  #endif\n\n  void main(void) {\n    vec4 _NORMAL = vec4(0.);\n    vec4 _TANGENT = vec4(0.);\n    vec2 _TEXCOORD_0 = vec2(0.);\n\n    #ifdef HAS_NORMALS\n      _NORMAL = normals;\n    #endif\n\n    #ifdef HAS_TANGENTS\n      _TANGENT = TANGENT;\n    #endif\n\n    #ifdef HAS_UV\n      _TEXCOORD_0 = texCoords;\n    #endif\n\n    pbr_setPositionNormalTangentUV(positions, _NORMAL, _TANGENT, _TEXCOORD_0);\n    gl_Position = u_MVPMatrix * positions;\n  }\n"),fs:L(0,"\n#pragma vscode_glsllint_stage: frag\n#if (__VERSION__ < 300)\n  #define fragmentColor gl_FragColor\n#else\n  out vec4 fragmentColor;\n#endif\n\n  void main(void) {\n    vec3 pos = pbr_vPosition;\n    fragmentColor = pbr_filterColor(vec4(1.0));\n  }\n"),...f,bindings:{...p.bindings,...f.bindings},defines:{...p.defines,...f.defines},parameters:{depthWriteEnabled:!0,depthCompare:"less",depthFormat:"depth24plus",cullMode:"back",...p.parameters,...f.parameters},uniforms:{...p.uniforms,...f.uniforms}},_=new r(t,d);return new a({managedResources:[],model:_})}(this.device,{id:s,geometry:this.createGeometry(s,t,o),material:t.material,materialOptions:this.options,modelOptions:this.options.modelOptions,vertexCount:l});return c.bounds=[t.attributes.POSITION.min,t.attributes.POSITION.max],c}getVertexCount(e){throw new Error("getVertexCount not implemented")}createGeometry(e,t,n){const r={};for(const[e,n]of Object.entries(t.attributes)){const{components:t,size:a,value:i}=n;r[e]={size:a??t,value:i}}return new s({id:e,topology:n,indices:t.indices.value,attributes:r})}createBuffer(e,t){e.bufferView||(e.bufferView={});const{bufferView:n}=e;return n.lumaBuffers||(n.lumaBuffers={}),n.lumaBuffers[t]||(n.lumaBuffers[t]=this.device.createBuffer({id:`from-${n.id}`,data:n.data||e.value})),n.lumaBuffers[t]}createSampler(e){return e}needsPOT(){return!1}}var O;function b(e,t,n){const r=new R(e,n);return{scenes:r.instantiate(t),animator:r.createAnimator()}}!function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(O||(O={}));export{T as GLTFAnimator,b as createScenegraphsFromGLTF,p as loadPBREnvironment,u as parsePBRMaterial};export default null;
