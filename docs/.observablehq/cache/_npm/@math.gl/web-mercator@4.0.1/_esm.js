/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@math.gl/web-mercator@4.0.1/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{vec4 as t,mat4 as i,vec3 as e,vec2 as n}from"../core/_esm.js";function r(i,e){const n=t.transformMat4([],e,i);return t.scale(n,n,1/n[3]),n}function o(t,i){const e=t%i;return e<0?i+e:e}function s(t,i,e){return t<i?i:t>e?e:t}const a=Math.log2||function(t){return Math.log(t)*Math.LOG2E};function h(t,i){if(!t)throw new Error(i||"@math.gl/web-mercator: assertion failed.")}const u=Math.PI,c=u/4,l=u/180,M=180/u,d=512,g=4003e4,p=85.051129,m=1.5;function f(t){return Math.pow(2,t)}function b(t){return a(t)}function x(t){const[i,e]=t;h(Number.isFinite(i)),h(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");const n=e*l;return[d*(i*l+u)/(2*u),d*(u+Math.log(Math.tan(c+.5*n)))/(2*u)]}function w(t){const[i,e]=t,n=i/d*(2*u)-u,r=2*(Math.atan(Math.exp(e/d*(2*u)-u))-c);return[n*M,r*M]}function P(t){const{latitude:i}=t;h(Number.isFinite(i));const e=Math.cos(i*l);return b(g*e)-9}function j(t){const i=Math.cos(t*l);return d/g/i}function F(t){const{latitude:i,longitude:e,highPrecision:n=!1}=t;h(Number.isFinite(i)&&Number.isFinite(e));const r=d,o=Math.cos(i*l),s=r/360,a=s/o,u=r/g/o,c={unitsPerMeter:[u,u,u],metersPerUnit:[1/u,1/u,1/u],unitsPerDegree:[s,a,u],degreesPerUnit:[1/s,1/a,1/u]};if(n){const t=l*Math.tan(i*l)/o,e=s*t/2,n=r/g*t,h=n/a*u;c.unitsPerDegree2=[0,e,n],c.unitsPerMeter2=[h,0,h]}return c}function v(t,i){const[e,n,r]=t,[o,s,a]=i,{unitsPerMeter:h,unitsPerMeter2:u}=F({longitude:e,latitude:n,highPrecision:!0}),c=x(t);c[0]+=o*(h[0]+u[0]*s),c[1]+=s*(h[1]+u[1]*s);const l=w(c),M=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[l[0],l[1],M]:l}function N(t){const{height:n,pitch:r,bearing:o,altitude:s,scale:a,center:h}=t,u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];i.translate(u,u,[0,0,-s]),i.rotateX(u,u,-r*l),i.rotateZ(u,u,o*l);const c=a/n;return i.scale(u,u,[c,c,c]),h&&i.translate(u,u,e.negate([],h)),u}function z(t){const{width:i,height:e,altitude:n,pitch:r=0,offset:o,center:a,scale:h,nearZMultiplier:u=1,farZMultiplier:c=1}=t;let{fovy:M=Z(m)}=t;void 0!==n&&(M=Z(n));const d=M*l,g=r*l,p=L(M);let f=p;a&&(f+=a[2]*h/Math.cos(g)/e);const b=d*(.5+(o?o[1]:0)/e),x=Math.sin(b)*f/Math.sin(s(Math.PI/2-g-b,.01,Math.PI-.01)),w=Math.sin(g)*x+f,P=10*f;return{fov:d,aspect:i/e,focalDistance:p,near:u,far:Math.min(w*c,P)}}function y(t){const{fov:e,aspect:n,near:r,far:o}=z(t);return i.perspective([],e,n,r,o)}function Z(t){return 2*Math.atan(.5/t)*M}function L(t){return.5/Math.tan(.5*t*l)}function S(t,i){const[e,n,o=0]=t;return h(Number.isFinite(e)&&Number.isFinite(n)&&Number.isFinite(o)),r(i,[e,n,o,1])}function U(t,i,e=0){const[o,s,a]=t;if(h(Number.isFinite(o)&&Number.isFinite(s),"invalid pixel coordinate"),Number.isFinite(a)){return r(i,[o,s,a,1])}const u=r(i,[o,s,0,1]),c=r(i,[o,s,1,1]),l=u[2],M=c[2],d=l===M?0:((e||0)-l)/(M-l);return n.lerp([],u,c,d)}function B(t){const{width:i,height:e,bounds:n,minExtent:r=0,maxZoom:o=24,offset:u=[0,0]}=t,[[c,l],[M,d]]=n,g=function(t=0){if("number"==typeof t)return{top:t,bottom:t,left:t,right:t};return h(Number.isFinite(t.top)&&Number.isFinite(t.bottom)&&Number.isFinite(t.left)&&Number.isFinite(t.right)),t}(t.padding),m=x([c,s(d,-85.051129,p)]),f=x([M,s(l,-85.051129,p)]),b=[Math.max(Math.abs(f[0]-m[0]),r),Math.max(Math.abs(f[1]-m[1]),r)],P=[i-g.left-g.right-2*Math.abs(u[0]),e-g.top-g.bottom-2*Math.abs(u[1])];h(P[0]>0&&P[1]>0);const j=P[0]/b[0],F=P[1]/b[1],v=(g.right-g.left)/2/j,N=(g.top-g.bottom)/2/F,z=w([(f[0]+m[0])/2+v,(f[1]+m[1])/2+N]),y=Math.min(o,a(Math.abs(Math.min(j,F))));return h(Number.isFinite(y)),{longitude:z[0],latitude:z[1],zoom:y}}const D=Math.PI/180;function q(t,i=0){const{width:e,height:n,unproject:r}=t,o={targetZ:i},s=r([0,n],o),a=r([e,n],o);let h,u;return(t.fovy?.5*t.fovy*D:Math.atan(.5/t.altitude))>(90-t.pitch)*D-.01?(h=O(t,0,i),u=O(t,e,i)):(h=r([0,0],o),u=r([e,0],o)),[s,a,u,h]}function O(t,i,e){const{pixelUnprojectionMatrix:o}=t,s=r(o,[i,0,1,1]),a=r(o,[i,t.height,1,1]),h=(e*t.distanceScales.unitsPerMeter[2]-s[2])/(a[2]-s[2]),u=w(n.lerp([],s,a,h));return u.push(e),u}class C{constructor(t={width:1,height:1}){this.equals=t=>t instanceof C&&(t.width===this.width&&t.height===this.height&&i.equals(t.projectionMatrix,this.projectionMatrix)&&i.equals(t.viewMatrix,this.viewMatrix)),this.project=(t,i={})=>{const{topLeft:e=!0}=i,n=S(this.projectPosition(t),this.pixelProjectionMatrix),[r,o]=n,s=e?o:this.height-o;return 2===t.length?[r,s]:[r,s,n[2]]},this.unproject=(t,i={})=>{const{topLeft:e=!0,targetZ:n}=i,[r,o,s]=t,a=e?o:this.height-o,h=n&&n*this.distanceScales.unitsPerMeter[2],u=U([r,a,s],this.pixelUnprojectionMatrix,h),[c,l,M]=this.unprojectPosition(u);return Number.isFinite(s)?[c,l,M]:Number.isFinite(n)?[c,l,n]:[c,l]},this.projectPosition=t=>{const[i,e]=x(t);return[i,e,(t[2]||0)*this.distanceScales.unitsPerMeter[2]]},this.unprojectPosition=t=>{const[i,e]=w(t);return[i,e,(t[2]||0)*this.distanceScales.metersPerUnit[2]]};let{width:n,height:r,altitude:o=null,fovy:s=null}=t;const{latitude:a=0,longitude:h=0,zoom:u=0,pitch:c=0,bearing:l=0,position:M=null,nearZMultiplier:d=.02,farZMultiplier:g=1.01}=t;n=n||1,r=r||1,null===s&&null===o?(o=m,s=Z(o)):null===s?s=Z(o):null===o&&(o=L(s));const p=f(u);o=Math.max(.75,o);const b=F({longitude:h,latitude:a}),P=x([h,a]);P.push(0),M&&e.add(P,P,e.mul([],M,b.unitsPerMeter)),this.projectionMatrix=y({width:n,height:r,scale:p,center:P,pitch:c,fovy:s,nearZMultiplier:d,farZMultiplier:g}),this.viewMatrix=N({height:r,scale:p,center:P,pitch:c,bearing:l,altitude:o}),this.width=n,this.height=r,this.scale=p,this.latitude=a,this.longitude=h,this.zoom=u,this.pitch=c,this.bearing=l,this.altitude=o,this.fovy=s,this.center=P,this.meterOffset=M||[0,0,0],this.distanceScales=b,this._initMatrices(),Object.freeze(this)}_initMatrices(){const{width:t,height:e,projectionMatrix:n,viewMatrix:r}=this,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];i.multiply(o,o,n),i.multiply(o,o,r),this.viewProjectionMatrix=o;const s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];i.scale(s,s,[t/2,-e/2,1]),i.translate(s,s,[1,-1,0]),i.multiply(s,s,o);const a=i.invert([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s);if(!a)throw new Error("Pixel project matrix not invertible");this.pixelProjectionMatrix=s,this.pixelUnprojectionMatrix=a}projectFlat(t){return x(t)}unprojectFlat(t){return w(t)}getMapCenterByLngLatPosition({lngLat:t,pos:i}){const e=U(i,this.pixelUnprojectionMatrix),r=x(t),o=n.add([],r,n.negate([],e));return w(n.add([],this.center,o))}fitBounds(t,i={}){const{width:e,height:n}=this,{longitude:r,latitude:o,zoom:s}=B(Object.assign({width:e,height:n,bounds:t},i));return new C({width:e,height:n,longitude:r,latitude:o,zoom:s})}getBounds(t){const i=this.getBoundingRegion(t),e=Math.min(...i.map((t=>t[0]))),n=Math.max(...i.map((t=>t[0])));return[[e,Math.min(...i.map((t=>t[1])))],[n,Math.max(...i.map((t=>t[1])))]]}getBoundingRegion(t={}){return q(this,t.z||0)}getLocationAtPoint({lngLat:t,pos:i}){return this.getMapCenterByLngLatPosition({lngLat:t,pos:i})}}function E(t){const{width:i,height:e,pitch:n=0}=t;let{longitude:r,latitude:s,zoom:h,bearing:u=0}=t;(r<-180||r>180)&&(r=o(r+180,360)-180),(u<-180||u>180)&&(u=o(u+180,360)-180);const c=a(e/512);if(h<=c)h=c,s=0;else{const t=e/2/Math.pow(2,h),i=w([0,t])[1];if(s<i)s=i;else{const i=w([0,512-t])[1];s>i&&(s=i)}}return{width:i,height:e,longitude:r,latitude:s,zoom:h,pitch:n,bearing:u}}const I=.01,X=["longitude","latitude","zoom"],R={curve:1.414,speed:1.2};function Y(t,i,e,r){const{startZoom:o,startCenterXY:s,uDelta:a,w0:h,u1:u,S:c,rho:l,rho2:M,r0:d}=A(t,i,r);if(u<I){const n={};for(const r of X){const o=t[r],s=i[r];n[r]=(g=e)*s+(1-g)*o}return n}var g;const p=e*c,m=Math.cosh(d)/Math.cosh(d+l*p),f=h*((Math.cosh(d)*Math.tanh(d+l*p)-Math.sinh(d))/M)/u,x=o+b(1/m),P=n.scale([],a,f);n.add(P,P,s);const j=w(P);return{longitude:j[0],latitude:j[1],zoom:x}}function _(t,i,e){const n={...R,...e},{screenSpeed:r,speed:o,maxDuration:s}=n,{S:a,rho:h}=A(t,i,n),u=1e3*a;let c;return c=Number.isFinite(r)?u/(r/h):u/o,Number.isFinite(s)&&c>s?0:c}function A(t,i,e){const r=(e=Object.assign({},R,e)).curve,o=t.zoom,s=[t.longitude,t.latitude],a=f(o),h=i.zoom,u=[i.longitude,i.latitude],c=f(h-o),l=x(s),M=x(u),d=n.sub([],M,l),g=Math.max(t.width,t.height),p=g/c,m=n.length(d)*a,b=Math.max(m,I),w=r*r,P=(p*p-g*g+w*w*b*b)/(2*g*w*b),j=(p*p-g*g-w*w*b*b)/(2*p*w*b),F=Math.log(Math.sqrt(P*P+1)-P),v=Math.log(Math.sqrt(j*j+1)-j);return{startZoom:o,startCenterXY:l,uDelta:d,w0:g,u1:m,S:(v-F)/r,rho:r,rho2:w,r0:F,r1:v}}export{p as MAX_LATITUDE,C as WebMercatorViewport,v as addMetersToLngLat,Z as altitudeToFovy,C as default,B as fitBounds,Y as flyToViewport,L as fovyToAltitude,q as getBounds,F as getDistanceScales,_ as getFlyToDuration,P as getMeterZoom,y as getProjectionMatrix,z as getProjectionParameters,N as getViewMatrix,x as lngLatToWorld,E as normalizeViewportProps,U as pixelsToWorld,b as scaleToZoom,j as unitsPerMeter,w as worldToLngLat,S as worldToPixels,f as zoomToScale};
