/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@loaders.gl/3d-tiles@4.2.0/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{assert as t,parseFromContext as e,sliceArrayBuffer as r,path as n,DataViewFile as i,padToNBytes as s,copyPaddedStringToDataView as o,copyBinaryToDataView as a,copyStringToDataView as c,padStringToByteAlignment as l}from"../loader-utils@4.2.0/_esm.js";import{LOD_METRIC_TYPE as u,TILE_TYPE as f,TILE_REFINEMENT as h,TILESET_TYPE as p}from"../tiles@4.2.0/_esm.js";import{DracoLoader as y}from"../draco@4.2.0/_esm.js";import{GL as d,GLType as m,decodeRGB565 as b,octDecode as g}from"../math@4.2.0/_esm.js";import{Vector3 as T,Matrix3 as w,Quaternion as E,Matrix4 as O}from"../../@math.gl/core@4.0.1/_esm.js";import{GLTFLoader as A,postProcessGLTF as I,_getMemoryUsageGLTF as _}from"../gltf@4.2.0/_esm.js";import{Ellipsoid as N}from"../../@math.gl/geospatial@4.0.1/_esm.js";import{load as L,fetchFile as U}from"../core@4.2.0/_esm.js";import P from"../../@probe.gl/log@4.0.9/_esm.js";import S from"../../long@5.2.3/_esm.js";import{makeOrientedBoundingBoxFromPoints as B}from"../../@math.gl/culling@4.0.1/_esm.js";import{IndexedArchive as C,parseZipLocalFileHeader as D,searchFromTheEnd as R,CD_HEADER_SIGNATURE as x,parseZipCDFileHeader as M,makeHashTableFromZipHeaders as v,parseHashTable as G}from"../zip@4.2.0/_esm.js";import{MD5Hash as z}from"../crypto@4.2.0/_esm.js";import{NoCompression as H,DeflateCompression as F}from"../compression@4.2.0/_esm.js";const V="4.2.0-beta.2",$={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GEOMETRY:"geom",VECTOR:"vect",GLTF:"glTF"},k={BATCHED_MODEL:[98,51,100,109],INSTANCED_MODEL:[105,51,100,109],POINT_CLOUD:[112,110,116,115],COMPOSITE:[99,109,112,116]};function q(e,r,n){t(e instanceof ArrayBuffer);const i=new TextDecoder("utf8"),s=new Uint8Array(e,r,n);return i.decode(s)}class J{json;buffer;featuresLength=0;_cachedTypedArrays={};constructor(t,e){this.json=t,this.buffer=e}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return Boolean(this.json[t])}getGlobalProperty(t,e=d.UNSIGNED_INT,r=1){const n=this.json[t];return n&&Number.isFinite(n.byteOffset)?this._getTypedArrayFromBinary(t,e,r,1,n.byteOffset):n}getPropertyArray(t,e,r){const n=this.json[t];return n&&Number.isFinite(n.byteOffset)?("componentType"in n&&(e=m.fromName(n.componentType)),this._getTypedArrayFromBinary(t,e,r,this.featuresLength,n.byteOffset)):this._getTypedArrayFromArray(t,e,n)}getProperty(t,e,r,n,i){const s=this.json[t];if(!s)return s;const o=this.getPropertyArray(t,e,r);if(1===r)return o[n];for(let t=0;t<r;++t)i[t]=o[r*n+t];return i}_getTypedArrayFromBinary(t,e,r,n,i){const s=this._cachedTypedArrays;let o=s[t];return o||(o=m.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+i,n*r),s[t]=o),o}_getTypedArrayFromArray(t,e,r){const n=this._cachedTypedArrays;let i=n[t];return i||(i=m.createTypedArray(e,r),n[t]=i),i}}const j={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Q={SCALAR:(t,e)=>t[e],VEC2:(t,e)=>[t[2*e+0],t[2*e+1]],VEC3:(t,e)=>[t[3*e+0],t[3*e+1],t[3*e+2]],VEC4:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT2:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT3:(t,e)=>[t[9*e+0],t[9*e+1],t[9*e+2],t[9*e+3],t[9*e+4],t[9*e+5],t[9*e+6],t[9*e+7],t[9*e+8]],MAT4:(t,e)=>[t[16*e+0],t[16*e+1],t[16*e+2],t[16*e+3],t[16*e+4],t[16*e+5],t[16*e+6],t[16*e+7],t[16*e+8],t[16*e+9],t[16*e+10],t[16*e+11],t[16*e+12],t[16*e+13],t[16*e+14],t[16*e+15]]},Z={SCALAR:(t,e,r)=>{e[r]=t},VEC2:(t,e,r)=>{e[2*r+0]=t[0],e[2*r+1]=t[1]},VEC3:(t,e,r)=>{e[3*r+0]=t[0],e[3*r+1]=t[1],e[3*r+2]=t[2]},VEC4:(t,e,r)=>{e[4*r+0]=t[0],e[4*r+1]=t[1],e[4*r+2]=t[2],e[4*r+3]=t[3]},MAT2:(t,e,r)=>{e[4*r+0]=t[0],e[4*r+1]=t[1],e[4*r+2]=t[2],e[4*r+3]=t[3]},MAT3:(t,e,r)=>{e[9*r+0]=t[0],e[9*r+1]=t[1],e[9*r+2]=t[2],e[9*r+3]=t[3],e[9*r+4]=t[4],e[9*r+5]=t[5],e[9*r+6]=t[6],e[9*r+7]=t[7],e[9*r+8]=t[8],e[9*r+9]=t[9]},MAT4:(t,e,r)=>{e[16*r+0]=t[0],e[16*r+1]=t[1],e[16*r+2]=t[2],e[16*r+3]=t[3],e[16*r+4]=t[4],e[16*r+5]=t[5],e[16*r+6]=t[6],e[16*r+7]=t[7],e[16*r+8]=t[8],e[16*r+9]=t[9],e[16*r+10]=t[10],e[16*r+11]=t[11],e[16*r+12]=t[12],e[16*r+13]=t[13],e[16*r+14]=t[14],e[16*r+15]=t[15]}};const Y=t=>void 0!==t;function W(t,e,r){if(!e)return null;let n=t.getExtension("3DTILES_batch_table_hierarchy");const i=e.HIERARCHY;return i&&(console.warn("3D Tile Parser: HIERARCHY is deprecated. Use 3DTILES_batch_table_hierarchy."),e.extensions=e.extensions||{},e.extensions["3DTILES_batch_table_hierarchy"]=i,n=i),n?function(t,e){let r,n,i;const s=t.instancesLength,o=t.classes;let a,c=t.classIds,l=t.parentCounts,u=t.parentIds,f=s;Y(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,i=getBinaryAccessor(c),c=i.createArrayBufferView(e.buffer,e.byteOffset+c.byteOffset,s));if(Y(l))for(Y(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,i=getBinaryAccessor(l),l=i.createArrayBufferView(e.buffer,e.byteOffset+l.byteOffset,s)),a=new Uint16Array(s),f=0,r=0;r<s;++r)a[r]=f,f+=l[r];Y(u)&&Y(u.byteOffset)&&(u.componentType=defaultValue(u.componentType,GL.UNSIGNED_SHORT),u.type=AttributeType.SCALAR,i=getBinaryAccessor(u),u=i.createArrayBufferView(e.buffer,e.byteOffset+u.byteOffset,f));const h=o.length;for(r=0;r<h;++r){const t=o[r].length,n=o[r].instances,i=getBinaryProperties(t,n,e);o[r].instances=combine(i,n)}const p=new Array(h).fill(0),y=new Uint16Array(s);for(r=0;r<s;++r)n=c[r],y[r]=p[n],++p[n];const d={classes:o,classIds:c,classIndexes:y,parentCounts:l,parentIndexes:a,parentIds:u};return function(t){const e=t.classIds,r=e.length;for(let e=0;e<r;++e)K(t,e,stack)}(d),d}(n,r):null}function X(t,e,r){if(!t)return;const n=t.parentCounts;return t.parentIds?r(t,e):n>0?function(t,e,r){const n=t.classIds,i=t.parentCounts,s=t.parentIds,o=t.parentIndexes,a=n.length,c=scratchVisited;c.length=Math.max(c.length,a);const l=++marker,u=scratchStack;u.length=0,u.push(e);for(;u.length>0;){if(c[e=u.pop()]===l)continue;c[e]=l;const n=r(t,e);if(Y(n))return n;const a=i[e],f=o[e];for(let t=0;t<a;++t){const r=s[f+t];r!==e&&u.push(r)}}return null}(t,e,r):function(t,e,r){let n=!0;for(;n;){const i=r(t,e);if(Y(i))return i;const s=t.parentIds[e];n=s!==e,e=s}throw new Error("traverseHierarchySingleParent")}(t,e,r)}function K(t,e,r){const n=t.parentCounts,i=t.parentIds,s=t.parentIndexes,o=t.classIds.length;if(!Y(i))return;assert(e<o,`Parent index ${e} exceeds the total number of instances: ${o}`),assert(-1===r.indexOf(e),"Circular dependency detected in the batch table hierarchy."),r.push(e);const a=Y(n)?n[e]:1,c=Y(n)?s[e]:e;for(let n=0;n<a;++n){const s=i[c+n];s!==e&&K(t,s,r)}r.pop(e)}function tt(t){return null!=t}const et=(t,e)=>t,rt={HIERARCHY:!0,extensions:!0,extras:!0};class nt{json;binary;featureCount;_extensions;_properties;_binaryProperties;_hierarchy;constructor(e,r,n,i={}){t(n>=0),this.json=e||{},this.binary=r,this.featureCount=n,this._extensions=this.json?.extensions||{},this._properties={};for(const t in this.json)rt[t]||(this._properties[t]=this.json[t]);this._binaryProperties=this._initializeBinaryProperties(),i["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=W(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(e,r){if(this._checkBatchId(e),t("string"==typeof r,r),this._hierarchy){return tt(X(this._hierarchy,e,((t,e)=>{const n=t.classIds[e];return t.classes[n].name===r})))}return!1}isExactClass(e,r){return t("string"==typeof r,r),this.getExactClassName(e)===r}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){const e=this._hierarchy.classIds[t];return this._hierarchy.classes[e].name}}hasProperty(e,r){return this._checkBatchId(e),t("string"==typeof r,r),tt(this._properties[r])||this._hasPropertyInHierarchy(e,r)}getPropertyNames(t,e){this._checkBatchId(t),(e=tt(e)?e:[]).length=0;const r=Object.keys(this._properties);return e.push(...r),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(e,r){if(this._checkBatchId(e),t("string"==typeof r,r),this._binaryProperties){const t=this._binaryProperties[r];if(tt(t))return this._getBinaryProperty(t,e)}const n=this._properties[r];if(tt(n))return et(n[e]);if(this._hierarchy){const t=this._getHierarchyProperty(e,r);if(tt(t))return t}}setProperty(e,r,n){const i=this.featureCount;if(this._checkBatchId(e),t("string"==typeof r,r),this._binaryProperties){const t=this._binaryProperties[r];if(t)return void this._setBinaryProperty(t,e,n)}if(this._hierarchy&&this._setHierarchyProperty(this,e,r,n))return;let s=this._properties[r];tt(s)||(this._properties[r]=new Array(i),s=this._properties[r]),s[e]=et(n)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,r){t.pack(r,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const r=this._properties[e],n=this._initializeBinaryProperty(e,r);n&&(t=t||{},t[e]=n)}return t}_initializeBinaryProperty(e,r){if("byteOffset"in r){const n=r;t(this.binary,`Property ${e} requires a batch table binary.`),t(n.type,`Property ${e} requires a type.`);const i=function(e,r,n,i){const{componentType:s}=e;t(e.componentType);const o="string"==typeof s?m.fromName(s):s,a=j[e.type],c=Q[e.type],l=Z[e.type];return n+=e.byteOffset,{values:m.createTypedArray(o,r,n,a*i),type:o,size:a,unpacker:c,packer:l}}(n,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:i.values,componentCount:i.size,unpack:i.unpacker,pack:i.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const r=X(this._hierarchy,t,((t,r)=>{const n=t.classIds[r];return tt(t.classes[n].instances[e])}));return tt(r)}_getPropertyNamesInHierarchy(t,e){X(this._hierarchy,t,((t,r)=>{const n=t.classIds[r],i=t.classes[n].instances;for(const t in i)i.hasOwnProperty(t)&&-1===e.indexOf(t)&&e.push(t)}))}_getHierarchyProperty(t,e){return X(this._hierarchy,t,((t,r)=>{const n=t.classIds[r],i=t.classes[n],s=t.classIndexes[r],o=i.instances[e];return tt(o)?tt(o.typedArray)?this._getBinaryProperty(o,s):et(o[s]):null}))}_setHierarchyProperty(e,r,n,i){const s=X(this._hierarchy,r,((e,s)=>{const o=e.classIds[s],a=e.classes[o],c=e.classIndexes[s],l=a.instances[n];return!!tt(l)&&(t(s===r,`Inherited property "${n}" is read-only.`),tt(l.typedArray)?this._setBinaryProperty(l,c,i):l[c]=et(i),!0)}));return tt(s)}}const it=4;function st(t,e,r=0){const n=new DataView(e);if(t.magic=n.getUint32(r,!0),r+=it,t.version=n.getUint32(r,!0),r+=it,t.byteLength=n.getUint32(r,!0),r+=it,1!==t.version)throw new Error(`3D Tile Version ${t.version} not supported`);return r}const ot=4,at="b3dm tile in legacy format.";function ct(t,e,r){const n=new DataView(e);let i;t.header=t.header||{};let s=n.getUint32(r,!0);r+=ot;let o=n.getUint32(r,!0);r+=ot;let a=n.getUint32(r,!0);r+=ot;let c=n.getUint32(r,!0);return r+=ot,a>=570425344?(r-=2*ot,i=s,a=o,c=0,s=0,o=0,console.warn(at)):c>=570425344&&(r-=ot,i=a,a=s,c=o,s=0,o=0,console.warn(at)),t.header.featureTableJsonByteLength=s,t.header.featureTableBinaryByteLength=o,t.header.batchTableJsonByteLength=a,t.header.batchTableBinaryByteLength=c,t.header.batchLength=i,r}function lt(t,e,r,n){return r=function(t,e,r,n){const{featureTableJsonByteLength:i,featureTableBinaryByteLength:s,batchLength:o}=t.header||{};if(t.featureTableJson={BATCH_LENGTH:o||0},i&&i>0){const n=q(e,r,i);t.featureTableJson=JSON.parse(n)}return r+=i||0,t.featureTableBinary=new Uint8Array(e,r,s),r+=s||0,r}(t,e,r),r=function(t,e,r,n){const{batchTableJsonByteLength:i,batchTableBinaryByteLength:s}=t.header||{};if(i&&i>0){const n=q(e,r,i);t.batchTableJson=JSON.parse(n),r+=i,s&&s>0&&(t.batchTableBinary=new Uint8Array(e,r,s),t.batchTableBinary=new Uint8Array(t.batchTableBinary),r+=s)}return r}(t,e,r),r}function ut(t,e,r){if(!(e||t&&t.batchIds&&r))return null;const{batchIds:n,isRGB565:i,pointCount:s=0}=t;if(n&&r){const t=new Uint8ClampedArray(3*s);for(let e=0;e<s;e++){const i=n[e],s=r.getProperty(i,"dimensions").map((t=>255*t));t[3*e]=s[0],t[3*e+1]=s[1],t[3*e+2]=s[2]}return{type:d.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}if(e&&i){const t=new Uint8ClampedArray(3*s);for(let r=0;r<s;r++){const n=b(e[r]);t[3*r]=n[0],t[3*r+1]=n[1],t[3*r+2]=n[2]}return{type:d.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}return e&&e.length===3*s?{type:d.UNSIGNED_BYTE,value:e,size:3,normalized:!0}:{type:d.UNSIGNED_BYTE,value:e||new Uint8ClampedArray,size:4,normalized:!0}}const ft=new T;function ht(t,e,r){return t.isQuantized?r["3d-tiles"]&&r["3d-tiles"].decodeQuantizedPositions?(t.isQuantized=!1,function(t,e){const r=new T,n=new Float32Array(3*t.pointCount);for(let i=0;i<t.pointCount;i++)r.set(e[3*i],e[3*i+1],e[3*i+2]).scale(1/t.quantizedRange).multiply(t.quantizedVolumeScale).add(t.quantizedVolumeOffset).toArray(n,3*i);return n}(t,e)):{type:d.UNSIGNED_SHORT,value:e,size:3,normalized:!0}:e}async function pt(t,r,n,i,s){n=lt(t,r,n=ct(t,r,n=st(t,r,n))),function(t){t.attributes={positions:null,colors:null,normals:null,batchIds:null},t.isQuantized=!1,t.isTranslucent=!1,t.isRGB565=!1,t.isOctEncoded16P=!1}(t);const{featureTable:o,batchTable:a}=function(t){const e=new J(t.featureTableJson,t.featureTableBinary),r=e.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(r))throw new Error("POINTS_LENGTH must be defined");e.featuresLength=r,t.featuresLength=r,t.pointsLength=r,t.pointCount=r,t.rtcCenter=e.getGlobalProperty("RTC_CENTER",d.FLOAT,3);const n=function(t,e){let r=null;if(!t.batchIds&&e.hasProperty("BATCH_ID")&&(t.batchIds=e.getPropertyArray("BATCH_ID",d.UNSIGNED_SHORT,1),t.batchIds)){const n=e.getGlobalProperty("BATCH_LENGTH");if(!n)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:i,batchTableBinary:s}=t;r=new nt(i,s,n)}return r}(t,e);return{featureTable:e,batchTable:n}}(t);return await async function(t,r,n,i,s){let o,a,c;const l=t.batchTableJson&&t.batchTableJson.extensions&&t.batchTableJson.extensions["3DTILES_draco_point_compression"];l&&(c=l.properties);const u=r.getExtension("3DTILES_draco_point_compression");if(u){a=u.properties;const e=u.byteOffset,r=u.byteLength;if(!a||!Number.isFinite(e)||!r)throw new Error("Draco properties, byteOffset, and byteLength must be defined");o=(t.featureTableBinary||[]).slice(e,e+r),t.hasPositions=Number.isFinite(a.POSITION),t.hasColors=Number.isFinite(a.RGB)||Number.isFinite(a.RGBA),t.hasNormals=Number.isFinite(a.NORMAL),t.hasBatchIds=Number.isFinite(a.BATCH_ID),t.isTranslucent=Number.isFinite(a.RGBA)}if(!o)return!0;const f={buffer:o,properties:{...a,...c},featureTableProperties:a,batchTableProperties:c,dequantizeInShader:!1};return await async function(t,r,n,i){if(!i)return;const s={...n,draco:{...n?.draco,extraAttributes:r.batchTableProperties||{}}};delete s["3d-tiles"];const o=await e(r.buffer,y,s,i),a=o.attributes.POSITION&&o.attributes.POSITION.value,c=o.attributes.COLOR_0&&o.attributes.COLOR_0.value,l=o.attributes.NORMAL&&o.attributes.NORMAL.value,u=o.attributes.BATCH_ID&&o.attributes.BATCH_ID.value,f=a&&o.attributes.POSITION.value.quantization,h=l&&o.attributes.NORMAL.value.quantization;if(f){const e=o.POSITION.data.quantization,r=e.range;t.quantizedVolumeScale=new T(r,r,r),t.quantizedVolumeOffset=new T(e.minValues),t.quantizedRange=(1<<e.quantizationBits)-1,t.isQuantizedDraco=!0}h&&(t.octEncodedRange=(1<<o.NORMAL.data.quantization.quantizationBits)-1,t.isOctEncodedDraco=!0);const p={};if(r.batchTableProperties)for(const t of Object.keys(r.batchTableProperties))o.attributes[t]&&o.attributes[t].value&&(p[t.toLowerCase()]=o.attributes[t].value);t.attributes={positions:a,colors:ut(t,c,void 0),normals:l,batchIds:u,...p}}(t,f,i,s)}(t,o,0,i,s),function(t,e,r){if(t.attributes=t.attributes||{positions:null,colors:null,normals:null,batchIds:null},!t.attributes.positions)if(e.hasProperty("POSITION"))t.attributes.positions=e.getPropertyArray("POSITION",d.FLOAT,3);else if(e.hasProperty("POSITION_QUANTIZED")){const n=e.getPropertyArray("POSITION_QUANTIZED",d.UNSIGNED_SHORT,3);if(t.isQuantized=!0,t.quantizedRange=65535,t.quantizedVolumeScale=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",d.FLOAT,3),!t.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(t.quantizedVolumeOffset=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",d.FLOAT,3),!t.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");t.attributes.positions=ht(t,n,r)}if(!t.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}(t,o,i),function(t,e,r){if(t.attributes=t.attributes||{positions:null,colors:null,normals:null,batchIds:null},!t.attributes.colors){let n=null;e.hasProperty("RGBA")?(n=e.getPropertyArray("RGBA",d.UNSIGNED_BYTE,4),t.isTranslucent=!0):e.hasProperty("RGB")?n=e.getPropertyArray("RGB",d.UNSIGNED_BYTE,3):e.hasProperty("RGB565")&&(n=e.getPropertyArray("RGB565",d.UNSIGNED_SHORT,1),t.isRGB565=!0),t.attributes.colors=ut(t,n,r)}e.hasProperty("CONSTANT_RGBA")&&(t.constantRGBA=e.getGlobalProperty("CONSTANT_RGBA",d.UNSIGNED_BYTE,4))}(t,o,a),function(t,e){if(t.attributes=t.attributes||{positions:null,colors:null,normals:null,batchIds:null},!t.attributes.normals){let r=null;e.hasProperty("NORMAL")?r=e.getPropertyArray("NORMAL",d.FLOAT,3):e.hasProperty("NORMAL_OCT16P")&&(r=e.getPropertyArray("NORMAL_OCT16P",d.UNSIGNED_BYTE,2),t.isOctEncoded16P=!0),t.attributes.normals=function(t,e){if(!e)return null;if(t.isOctEncoded16P){const r=new Float32Array(3*(t.pointsLength||0));for(let n=0;n<(t.pointsLength||0);n++)g(e[2*n],e[2*n+1],ft),ft.toArray(r,3*n);return{type:d.FLOAT,size:2,value:r}}return{type:d.FLOAT,size:2,value:e}}(t,r)}}(t,o),n}const yt={URI:0,EMBEDDED:1};function dt(t,e,n,i){t.rotateYtoZ=!0;const s=(t.byteOffset||0)+(t.byteLength||0)-n;if(0===s)throw new Error("glTF byte length must be greater than 0.");return t.gltfUpAxis=i?.["3d-tiles"]&&i["3d-tiles"].assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y",t.gltfArrayBuffer=r(e,n,s),t.gltfByteOffset=0,t.gltfByteLength=s,n%4==0||console.warn(`${t.type}: embedded glb is not aligned to a 4-byte boundary.`),(t.byteOffset||0)+(t.byteLength||0)}async function mt(t,r,n,i){const s=n?.["3d-tiles"]||{};if(function(t,e,r){switch(e){case yt.URI:if(t.gltfArrayBuffer){const e=new Uint8Array(t.gltfArrayBuffer,t.gltfByteOffset),r=(new TextDecoder).decode(e);t.gltfUrl=r.replace(/[\s\0]+$/,"")}delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength;break;case yt.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}(t,r),s.loadGLTF){if(!i)return;if(t.gltfUrl){const{fetch:e}=i,r=await e(t.gltfUrl,n);t.gltfArrayBuffer=await r.arrayBuffer(),t.gltfByteOffset=0}if(t.gltfArrayBuffer){const r=await e(t.gltfArrayBuffer,A,n,i);t.gltf=I(r),t.gpuMemoryUsageInBytes=_(t.gltf),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength}}}async function bt(t,e,r,n,i){r=function(t,e,r,n,i){r=st(t,e,r),r=ct(t,e,r),r=lt(t,e,r),r=dt(t,e,r,n);const s=new J(t.featureTableJson,t.featureTableBinary);return t.rtcCenter=s.getGlobalProperty("RTC_CENTER",d.FLOAT,3),r}(t,e,r,n),await mt(t,yt.EMBEDDED,n,i);const s=t?.gltf?.extensions;return s&&s.CESIUM_RTC&&(t.rtcCenter=s.CESIUM_RTC.center),r}async function gt(t,e,r,n,i){return r=function(t,e,r,n,i){if(r=st(t,e,r),1!==t.version)throw new Error(`Instanced 3D Model version ${t.version} is not supported`);r=ct(t,e,r);const s=new DataView(e);if(t.gltfFormat=s.getUint32(r,!0),r+=4,r=lt(t,e,r),r=dt(t,e,r,n),!t?.header?.featureTableJsonByteLength||0===t.header.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new J(t.featureTableJson,t.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");t.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),t.rtcCenter=o.getGlobalProperty("RTC_CENTER",d.FLOAT,3);new nt(t.batchTableJson,t.batchTableBinary,a);return function(t,e,r,n){const i=new Array(n),s=new T;new T,new T,new T;const o=new w,a=new E,c=new T,l={},u=new O,f=[],h=[],p=[],y=[];for(let r=0;r<n;r++){let n;if(e.hasProperty("POSITION"))n=e.getProperty("POSITION",d.FLOAT,3,r,s);else if(e.hasProperty("POSITION_QUANTIZED")){n=e.getProperty("POSITION_QUANTIZED",d.UNSIGNED_SHORT,3,r,s);const t=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",d.FLOAT,3);if(!t)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const i=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",d.FLOAT,3);if(!i)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const o=65535;for(let e=0;e<3;e++)n[e]=n[e]/o*i[e]+t[e]}if(!n)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(s.copy(n),l.translation=s,t.normalUp=e.getProperty("NORMAL_UP",d.FLOAT,3,r,f),t.normalRight=e.getProperty("NORMAL_RIGHT",d.FLOAT,3,r,h),t.normalUp){if(!t.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");t.hasCustomOrientation=!0}else{if(t.octNormalUp=e.getProperty("NORMAL_UP_OCT32P",d.UNSIGNED_SHORT,2,r,f),t.octNormalRight=e.getProperty("NORMAL_RIGHT_OCT32P",d.UNSIGNED_SHORT,2,r,h),t.octNormalUp){if(!t.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}t.eastNorthUp?(N.WGS84.eastNorthUpToFixedFrame(s,u),u.getRotationMatrix3(o)):o.identity()}a.fromMatrix3(o),l.rotation=a,c.set(1,1,1);const m=e.getProperty("SCALE",d.FLOAT,1,r,p);Number.isFinite(m)&&c.multiplyByScalar(m);const b=e.getProperty("SCALE_NON_UNIFORM",d.FLOAT,3,r,f);b&&c.scale(b),l.scale=c;let g=e.getProperty("BATCH_ID",d.UNSIGNED_SHORT,1,r,y);void 0===g&&(g=r);const T=(new O).fromQuaternion(l.rotation);u.identity(),u.translate(l.translation),u.multiplyRight(T),u.scale(l.scale);const w=u.clone();i[r]={modelMatrix:w,batchId:g}}t.instances=i}(t,o,0,a),r}(t,e,r,n),await mt(t,t.gltfFormat||0,n,i),r}async function Tt(t,r=0,n,i,s={shape:"tile3d"}){switch(s.byteOffset=r,s.type=function(t,e=0){const r=new DataView(t);return`${String.fromCharCode(r.getUint8(e+0))}${String.fromCharCode(r.getUint8(e+1))}${String.fromCharCode(r.getUint8(e+2))}${String.fromCharCode(r.getUint8(e+3))}`}(t,r),s.type){case $.COMPOSITE:return await async function(t,e,r,n,i,s){r=st(t,e,r);const o=new DataView(e);for(t.tilesLength=o.getUint32(r,!0),r+=4,t.tiles=[];t.tiles.length<t.tilesLength&&(t.byteLength||0)-r>12;){const o={shape:"tile3d"};t.tiles.push(o),r=await s(e,r,n,i,o)}return r}(s,t,r,n,i,Tt);case $.BATCHED_3D_MODEL:return await bt(s,t,r,n,i);case $.GLTF:return await async function(t,r,n,i){if(t.rotateYtoZ=!0,t.gltfUpAxis=n?.["3d-tiles"]?.assetGltfUpAxis?n["3d-tiles"].assetGltfUpAxis:"Y",n?.["3d-tiles"]?.loadGLTF){if(!i)return r.byteLength;const s=await e(r,A,n,i);t.gltf=I(s),t.gpuMemoryUsageInBytes=_(t.gltf)}else t.gltfArrayBuffer=r;return r.byteLength}(s,t,n,i);case $.INSTANCED_3D_MODEL:return await gt(s,t,r,n,i);case $.POINT_CLOUD:return await pt(s,t,r,n,i);default:throw new Error(`3DTileLoader: unknown type ${s.type}`)}}async function wt(t,e,r,n){const i=Number.isFinite(e.bitstream)?e.bitstream:e.bufferView;if("number"!=typeof i)return;const s=t.bufferViews[i],o=t.buffers[s.buffer];if(!n?.baseUrl)throw new Error("Url is not provided");if(!n.fetch)throw new Error("fetch is not provided");if(o.uri){const t=`${n?.baseUrl||""}/${o.uri}`,r=await n.fetch(t),i=await r.arrayBuffer();return void(e.explicitBitstream=new Uint8Array(i,s.byteOffset,s.byteLength))}const a=t.buffers.slice(0,s.buffer).reduce(((t,e)=>t+e.byteLength),0);e.explicitBitstream=new Uint8Array(r.slice(a,a+o.byteLength),s.byteOffset,s.byteLength)}function Et(t){const e=new DataView(t);return e.getUint32(0,!0)+2**32*e.getUint32(4,!0)}const Ot={dataType:null,batchType:null,id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:V,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:async function(t,e,r){if(1952609651!==new Uint32Array(t.slice(0,4))[0])throw new Error("Wrong subtree file magic number");if(1!==new Uint32Array(t.slice(4,8))[0])throw new Error("Wrong subtree file verson, must be 1");const n=Et(t.slice(8,16)),i=new Uint8Array(t,24,n),s=new TextDecoder("utf8").decode(i),o=JSON.parse(s),a=Et(t.slice(16,24));let c=new ArrayBuffer(0);if(a&&(c=t.slice(24+n)),await wt(o,o.tileAvailability,c,r),Array.isArray(o.contentAvailability))for(const t of o.contentAvailability)await wt(o,t,c,r);else await wt(o,o.contentAvailability,c,r);return await wt(o,o.childSubtreeAvailability,c,r),o},options:{}},At=16;function It(t){"X"===t&&(t="");const e=t.padEnd(At,"0");return S.fromString(e,!0,16)}const _t=3,Nt=61,Lt=180/Math.PI;function Ut(t,e,r){const n=1<<e;return[(t[0]+r[0])/n,(t[1]+r[1])/n]}function Pt(t){return t>=.5?1/3*(4*t*t-1):1/3*(1-4*(1-t)*(1-t))}function St(t){return[Pt(t[0]),Pt(t[1])]}function Bt(t,[e,r]){switch(t){case 0:return[1,e,r];case 1:return[-e,1,r];case 2:return[-e,-r,1];case 3:return[-1,-r,-e];case 4:return[r,-1,-e];case 5:return[r,e,-1];default:throw new Error("Invalid face")}}function Ct([t,e,r]){const n=Math.atan2(r,Math.sqrt(t*t+e*e));return[Math.atan2(e,t)*Lt,n*Lt]}function Dt(t,e,r,n){if(0===n){1===r&&(e[0]=t-1-e[0],e[1]=t-1-e[1]);const n=e[0];e[0]=e[1],e[1]=n}}const Rt=100;function xt(t){const{face:e,ij:r,level:n}=t,i=[[0,0],[0,1],[1,1],[1,0],[0,0]],s=Math.max(1,Math.ceil(Rt*Math.pow(2,-n))),o=new Float64Array(4*s*2+2);let a=0,c=0;for(let t=0;t<4;t++){const l=i[t].slice(0),u=i[t+1],f=(u[0]-l[0])/s,h=(u[1]-l[1])/s;for(let t=0;t<s;t++){l[0]+=f,l[1]+=h;const t=Ct(Bt(e,St(Ut(r,n,l))));Math.abs(t[1])>89.999&&(t[0]=c);const i=t[0]-c;t[0]+=i>180?-360:i<-180?360:0,o[a++]=t[0],o[a++]=t[1],c=t[0]}}return o[a++]=o[0],o[a++]=o[1],o}function Mt(t){const e=function(t){if(t.indexOf("/")>0)return t;const e=It(t);return function(t){if(t.isZero())return"";let e=t.toString(2);for(;e.length<_t+Nt;)e="0"+e;const r=e.lastIndexOf("1"),n=e.substring(0,3),i=e.substring(3,r),s=i.length/2,o=S.fromString(n,!0,2).toString(10);let a="";if(0!==s)for(a=S.fromString(i,!0,2).toString(4);a.length<s;)a="0"+a;return`${o}/${a}`}(e)}(t);return function(t){if(0===t.length)throw new Error(`Invalid Hilbert quad key ${t}`);const e=t.split("/"),r=parseInt(e[0],10),n=e[1],i=n.length;let s=0;const o=[0,0];for(let t=i-1;t>=0;t--){s=i-t;const e=n[t];let r=0,a=0;"1"===e?a=1:"2"===e?(r=1,a=1):"3"===e&&(r=1);const c=Math.pow(2,s-1);Dt(c,o,r,a),o[0]+=c*r,o[1]+=c*a}if(r%2==1){const t=o[0];o[0]=o[1],o[1]=t}return{face:r,ij:o,level:s}}(e)}function vt(t){return function(t){const e=St(Ut(t.ij,t.level,[.5,.5]));return Ct(Bt(t.face,e))}(Mt(t))}function Gt(t){if(t.length%2!=0)throw new Error("Invalid corners");const e=[],r=[];for(let n=0;n<t.length;n+=2)e.push(t[n]),r.push(t[n+1]);return e.sort(((t,e)=>t-e)),r.sort(((t,e)=>t-e)),{west:e[0],east:e[e.length-1],north:r[r.length-1],south:r[0]}}function zt(t,e){const r=e?.minimumHeight||0,n=e?.maximumHeight||0,i=function(t){let e;if(2===t.face||5===t.face){let r=null,n=0;for(let e=0;e<4;e++){const i=xt(Mt(`${t.face}/${e}`));null==r&&(r=new Float64Array(4*i.length)),r.set(i,n),n+=i.length}e=Gt(r)}else e=Gt(xt(t));return e}(Mt(t)),s=i.west,o=i.south,a=i.east,c=i.north,l=[];return l.push(new T(s,c,r)),l.push(new T(a,c,r)),l.push(new T(a,o,r)),l.push(new T(s,o,r)),l.push(new T(s,c,n)),l.push(new T(a,c,n)),l.push(new T(a,o,n)),l.push(new T(s,o,n)),l}function Ht(t){const e=t.token,r={minimumHeight:t.minimumHeight,maximumHeight:t.maximumHeight},n=zt(e,r),i=vt(e),s=i[0],o=i[1],a=N.WGS84.cartographicToCartesian([s,o,r.maximumHeight]),c=new T(a[0],a[1],a[2]);n.push(c);const l=B(n);return[...l.center,...l.halfAxes]}const Ft={QUADTREE:4,OCTREE:8};function Vt(t,e,r){if(t?.box){const n=function(t,e){const r=function(t){return t.and(t.not().add(1))}(t).shiftRightUnsigned(2);return t.add(S.fromNumber(2*e+1-4).multiply(r))}(It(t.s2VolumeInfo.token),e),i=function(t){if(t.isZero())return"X";let e=t.countTrailingZeros();e=(e-e%4)/4;const r=e;e*=4;const n=t.shiftRightUnsigned(e).toString(16).replace(/0+$/,"");return Array(17-r-n.length).join("0")+n}(n),s={...t.s2VolumeInfo};if(s.token=i,"OCTREE"===r){const e=t.s2VolumeInfo,r=e.maximumHeight-e.minimumHeight,n=r/2,i=e.minimumHeight+r/2;e.minimumHeight=i-n,e.maximumHeight=i+n}return{box:Ht(s),s2VolumeInfo:s}}}async function $t(t){const{implicitOptions:e,parentData:r={mortonIndex:0,x:0,y:0,z:0},childIndex:n=0,s2VolumeBox:i,loaderOptions:s}=t;let{subtree:o,level:a=0,globalData:c={level:0,mortonIndex:0,x:0,y:0,z:0}}=t;const{subdivisionScheme:l,subtreeLevels:u,maximumLevel:f,contentUrlTemplate:h,subtreesUriTemplate:p,basePath:y}=e,d={children:[],lodMetricValue:0,contentUrl:""};if(!f)return P.once(`Missing 'maximumLevel' or 'availableLevels' property. The subtree ${h} won't be loaded...`),d;const m=a+c.level;if(m>f)return d;const b=Ft[l],g=Math.log2(b),T=1&n,w=n>>1&1,E=n>>2&1,O=(b**a-1)/(b-1);let A=Jt(r.mortonIndex,n,g),I=O+A,_=Jt(r.x,T,1),N=Jt(r.y,w,1),U=Jt(r.z,E,1),S=!1;a>=u&&(S=kt(o.childSubtreeAvailability,A));const B=Jt(c.x,_,a),C=Jt(c.y,N,a),D=Jt(c.z,U,a);if(S){const t=jt(`${y}/${p}`,m,B,C,D);o=await L(t,Ot,s),c={mortonIndex:A,x:_,y:N,z:U,level:a},A=0,I=0,_=0,N=0,U=0,a=0}if(!kt(o.tileAvailability,I))return d;kt(o.contentAvailability,I)&&(d.contentUrl=jt(h,m,B,C,D));const R=a+1,x={mortonIndex:A,x:_,y:N,z:U};for(let t=0;t<b;t++){const r=Vt(i,t,l),n=await $t({subtree:o,implicitOptions:e,loaderOptions:s,parentData:x,childIndex:t,level:R,globalData:{...c},s2VolumeBox:r});if(n.contentUrl||n.children.length){const t=qt(n,m+1,{childTileX:_,childTileY:N,childTileZ:U},e,i);d.children.push(t)}}return d}function kt(t,e){let r;return Array.isArray(t)?(r=t[0],t.length>1&&P.once('Not supported extension "3DTILES_multiple_contents" has been detected')):r=t,"constant"in r?Boolean(r.constant):!!r.explicitBitstream&&function(t,e){const r=Math.floor(t/8),n=t%8;return 1==(e[r]>>n&1)}(e,r.explicitBitstream)}function qt(t,e,r,n,i){const{basePath:s,refine:o,getRefine:a,lodMetricType:c,getTileType:l,rootLodMetricValue:u,rootBoundingVolume:f}=n,h=t.contentUrl&&t.contentUrl.replace(`${s}/`,""),p=u/2**e,y=function(t,e,r){if(e.region){const{childTileX:n,childTileY:i,childTileZ:s}=r,[o,a,c,l,u,f]=e.region,h=2**t,p=(c-o)/h,y=(l-a)/h,d=(f-u)/h,[m,b]=[o+p*n,o+p*(n+1)],[g,T]=[a+y*i,a+y*(i+1)],[w,E]=[u+d*s,u+d*(s+1)];return{region:[m,g,b,T,w,E]}}if(e.box)return e;throw new Error(`Unsupported bounding volume type ${JSON.stringify(e)}`)}(e,i?.box?{box:i.box}:f,r);return{children:t.children,contentUrl:t.contentUrl,content:{uri:h},id:t.contentUrl,refine:a(o),type:l(t),lodMetricType:c,lodMetricValue:p,geometricError:p,transform:t.transform,boundingVolume:y}}function Jt(t,e,r){return(t<<r)+e}function jt(t,e,r,n,i){const s=function(t){const e={};for(const r in t)e[`{${r}}`]=t[r];return e}({level:e,x:r,y:n,z:i});return t.replace(/{level}|{x}|{y}|{z}/gi,(t=>s[t]))}function Qt(t,e=""){if(!e)return f.EMPTY;const r=e.split("?")[0].split(".").pop();switch(r){case"pnts":return f.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return f.SCENEGRAPH;default:return r||f.EMPTY}}function Zt(t){switch(t){case"REPLACE":case"replace":return h.REPLACE;case"ADD":case"add":return h.ADD;default:return t}}function Yt(t,e){if(/^[a-z][0-9a-z+.-]*:/i.test(e)){const r=new URL(t,`${e}/`);return decodeURI(r.toString())}return t.startsWith("/")?t:n.resolve(e,t)}function Wt(t,e){if(!t)return null;let r;if(t.content){const n=t.content.uri||t.content?.url;void 0!==n&&(r=Yt(n,e))}return{...t,id:r,contentUrl:r,lodMetricType:u.GEOMETRIC_ERROR,lodMetricValue:t.geometricError,transformMatrix:t.transform,type:Qt(0,r),refine:Zt(t.refine)}}async function Xt(t,e,r,n,i){const{subdivisionScheme:s,maximumLevel:o,availableLevels:a,subtreeLevels:c,subtrees:{uri:l}}=n,f=Yt(jt(l,0,0,0,0),r),h=await L(f,Ot,i),p=t.content?.uri,y=p?Yt(p,r):"",d=e?.root?.refine,m=t.geometricError,b=t.boundingVolume.extensions?.["3DTILES_bounding_volume_S2"];if(b){const e={box:Ht(b),s2VolumeInfo:b};t.boundingVolume=e}const g=t.boundingVolume,T={contentUrlTemplate:y,subtreesUriTemplate:l,subdivisionScheme:s,subtreeLevels:c,maximumLevel:Number.isFinite(a)?a-1:o,refine:d,basePath:r,lodMetricType:u.GEOMETRIC_ERROR,rootLodMetricValue:m,rootBoundingVolume:g,getTileType:Qt,getRefine:Zt};return await async function(t,e,r,n,i){if(!t)return null;const{children:s,contentUrl:o}=await $t({subtree:r,implicitOptions:n,loaderOptions:i});let a,c=null;o&&(a=o,c={uri:o.replace(`${e}/`,"")});const l={...t,id:a,contentUrl:a,lodMetricType:u.GEOMETRIC_ERROR,lodMetricValue:t.geometricError,transformMatrix:t.transform,type:Qt(0,a),refine:Zt(t.refine),content:c||t.content,children:s};return l}(t,r,h,T,i)}function Kt(t){return t?.extensions?.["3DTILES_implicit_tiling"]||t?.implicitTiling}const te={dataType:null,batchType:null,id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:V,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:async function(t,e={},r){const i=e["3d-tiles"]||{};let s;s="auto"===i.isTileset?r?.url&&-1!==r.url.indexOf(".json"):i.isTileset;return s?async function(t,e,r){const i=JSON.parse((new TextDecoder).decode(t)),s=r?.url||"",o=function(t){return n.dirname(t)}(s),a=await async function(t,e,r){let n=null;const i=Kt(t.root);n=i&&t.root?await Xt(t.root,t,e,i,r):Wt(t.root,e);const s=[];for(s.push(n);s.length>0;){const n=s.pop()||{},i=n.children||[],o=[];for(const n of i){const i=Kt(n);let a;a=i?await Xt(n,t,e,i,r):Wt(n,e),a&&(o.push(a),s.push(a))}n.children=o}return n}(i,o,e||{}),c={...i,shape:"tileset3d",loader:te,url:s,queryString:r?.queryString||"",basePath:o,root:a||i.root,type:p.TILES3D,lodMetricType:u.GEOMETRIC_ERROR,lodMetricValue:i.root?.geometricError||0};return c}(t,e,r):async function(t,e,r){const n={content:{shape:"tile3d",featureIds:null}},i=0;return await Tt(t,i,e,r,n.content),n.content}(t,e,r)},options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};const ee="https://api.cesium.com/v1/assets";async function re(e,r){if(!r){const n=await async function(e){t(e);const r=ee,n={Authorization:`Bearer ${e}`},i=await U(r,{headers:n});if(!i.ok)throw new Error(i.statusText);return await i.json()}(e);for(const t of n.items)"3DTILES"===t.type&&(r=t.id)}const n=await async function(e,r){t(e,r);const n={Authorization:`Bearer ${e}`},i=`${ee}/${r}`;let s=await U(`${i}`,{headers:n});if(!s.ok)throw new Error(s.statusText);let o=await s.json();if(s=await U(`${i}/endpoint`,{headers:n}),!s.ok)throw new Error(s.statusText);const a=await s.json();return o={...o,...a},o}(e,r),{type:i,url:s}=n;return t("3DTILES"===i&&s),n.headers={Authorization:`Bearer ${n.accessToken}`},n}const ne={...te,id:"cesium-ion",name:"Cesium Ion",preload:async function(t,e={}){e=e["cesium-ion"]||{};const{accessToken:r}=e;let n=e.assetId;if(!Number.isFinite(n)){const e=t.match(/\/([0-9]+)\/tileset.json/);n=e&&e[1]}return re(r,n)},parse:async(t,e,r)=>((e={...e})["3d-tiles"]=e["cesium-ion"],e.loader=ne,te.parse(t,e,r)),options:{"cesium-ion":{...te.options["3d-tiles"],accessToken:null}}},ie={0:t=>(new H).decompress(t),8:t=>new F({raw:!0}).decompress(t)};class se extends C{hashTable;constructor(t,e,r){super(t,e,r),this.hashTable=e}async getFile(t){let e=await this.getFileBytes(t.toLocaleLowerCase());if(e||(e=await this.getFileBytes(t)),!e)throw new Error(`No such file in the archive: ${t}`);return e}async getFileBytes(t){let e;if(this.hashTable){const r=(new TextEncoder).encode(t).buffer,n=await(new z).hash(r,"hex"),i=this.hashTable[n];if(void 0===i)return null;const s=await D(i,this.fileProvider);if(!s)return null;const o=await this.fileProvider.slice(s.fileDataOffset,s.fileDataOffset+s.compressedSize),a=ie[s.compressionMethod];if(!a)throw Error("Only Deflation compression is supported");e=await a(o)}else e=await this.getFileWithoutHash(t);return e}}const oe={dataType:null,batchType:null,name:"3tz",id:"3tz",module:"3d-tiles",version:"4.2.0-beta.2",mimeTypes:["application/octet-stream","application/vnd.maxar.archive.3tz+zip"],parse:async function(t,e={}){return(await(async(t,e)=>{const r=await R(t,x),n=await M(r,t);let i;if("@3dtilesIndex1@"!==n?.fileName)i=await v(t),e?.("3tz doesnt contain hash file, hash info has been composed according to zip archive headers");else{const e=await D(n.localHeaderOffset,t);if(!e)throw new Error("corrupted 3tz zip archive");const r=e.fileDataOffset,s=await t.slice(r,r+e.compressedSize);i=G(s)}return new se(t,i)})(new i(new DataView(t)))).getFile(e["3d-tiles-archive"]?.path??"")},extensions:["3tz"],options:{}};function ae(e,r,n){if(!r)return n+12;const{magic:i,version:s=1,byteLength:o=12}=e;return t(Array.isArray(i)&&Number.isFinite(s)&&Number.isFinite(o)),r.setUint8(n+0,i[0]),r.setUint8(n+1,i[1]),r.setUint8(n+2,i[2]),r.setUint8(n+3,i[3]),r.setUint32(n+4,s,!0),r.setUint32(n+8,o,!0),n+=12}function ce(t,e,r){t&&t.setUint32(e+8,r,!0)}const le={POINTS_LENGTH:1,POSITIONS:{byteOffset:0}};function ue(e,r,n,i){switch(t("string"==typeof e.type),e.type){case $.COMPOSITE:return function(t,e,r,n,i){const s=r;r+=ae(t={magic:k.COMPOSITE,tiles:[],...t},e,r),e&&e.setUint32(r,t.tiles.length,!0),r+=4;for(let s=0;s<t.tiles.length;++s)r+=i(t.tiles[s],e,r,n);return ce(e,s,r-s),r}(e,r,n,i,ue);case $.POINT_CLOUD:return function(t,e,r,n){const{featureTableJson:i=le}=t;let s=JSON.stringify(i);s=l(s,4);const{featureTableJsonByteLength:o=s.length}=t,u=new ArrayBuffer(12),f=u.byteLength,h=r;return r+=ae(t={magic:k.POINT_CLOUD,...t},e,0),e&&(e.setUint32(r+0,o,!0),e.setUint32(r+4,f,!0),e.setUint32(r+8,0,!0),e.setUint32(r+12,0,!0)),r+=16,r+=c(e,r,s,o),ce(e,h,(r+=a(e,r,u,f))-h),r}(e,r,n);case $.BATCHED_3D_MODEL:return function(t,e,r,n){const{featuresLength:i=0,batchTable:c}=t,l={BATCH_LENGTH:i},u=JSON.stringify(l),f=c?JSON.stringify(c):"",h=s(u.length,8),p=f?s(f.length,8):0,y=r;r=ae(t={magic:k.BATCHED_MODEL,...t},e,r),e&&(e.setUint32(12,h,!0),e.setUint32(16,0,!0),e.setUint32(20,p,!0),e.setUint32(24,0,!0)),r=o(e,r+=16,u,8),c&&(r=o(e,r,f,8));const d=t.gltfEncoded;return d&&(r=a(e,r,d,d.byteLength)),ce(e,y,r-y),r}(e,r,n);case $.INSTANCED_3D_MODEL:return function(t,e,r,n){const{featuresLength:i=1,gltfFormat:s=1,gltfUri:o=""}=t,a=o.length,l={INSTANCES_LENGTH:i,POSITION:new Array(3*i).fill(0)},u=JSON.stringify(l),f=u.length,h=r;return r=ae(t={magic:k.INSTANCED_MODEL,...t},e,0),e&&(e.setUint32(12,f,!0),e.setUint32(16,0,!0),e.setUint32(20,0,!0),e.setUint32(24,0,!0),e.setUint32(28,s,!0)),r+=20,r+=c(e,r,u,f),ce(e,h,(r+=c(e,r,o,a))-h),r}(e,r,n);default:throw new Error("3D Tiles: unknown tile type")}}const fe={name:"3D Tile",id:"3d-tiles",module:"3d-tiles",version:V,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],binary:!0,options:{"3d-tiles":{}},encode:async(t,e)=>he(t,e),encodeSync:he};function he(t,e){return function(t,e){const r=ue(t,null,0,e),n=new ArrayBuffer(r);return ue(t,new DataView(n),0,e),n}(t,e)}export{ne as CesiumIonLoader,$ as TILE3D_TYPE,nt as Tile3DBatchTable,J as Tile3DFeatureTable,Ot as Tile3DSubtreeLoader,fe as Tile3DWriter,se as Tiles3DArchive,oe as Tiles3DArchiveFileLoader,te as Tiles3DLoader,re as _getIonTilesetMetadata};export default null;
