/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@loaders.gl/tiles@4.2.0/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{Matrix4 as e,Vector3 as t,Quaternion as i,Matrix3 as s,degrees as r}from"../../@math.gl/core@4.0.1/_esm.js";import{Ellipsoid as n}from"../../@math.gl/geospatial@4.0.1/_esm.js";import{Stats as o}from"../../@probe.gl/stats@4.0.9/_esm.js";import{assert as a,path as l,RequestScheduler as h}from"../loader-utils@4.2.0/_esm.js";import{CullingVolume as c,Plane as u,OrientedBoundingBox as d,BoundingSphere as p}from"../../@math.gl/culling@4.0.1/_esm.js";import{load as m}from"../core@4.2.0/_esm.js";class _{item;previous;next;constructor(e,t,i){this.item=e,this.previous=t,this.next=i}}class g{head=null;tail=null;_length=0;get length(){return this._length}add(e){const t=new _(e,this.tail,null);return this.tail?(this.tail.next=t,this.tail=t):(this.head=t,this.tail=t),++this._length,t}remove(e){e&&(e.previous&&e.next?(e.previous.next=e.next,e.next.previous=e.previous):e.previous?(e.previous.next=null,this.tail=e.previous):e.next?(e.next.previous=null,this.head=e.next):(this.head=null,this.tail=null),e.next=null,e.previous=null,--this._length)}splice(e,t){e!==t&&(this.remove(t),this._insert(e,t))}_insert(e,t){const i=e.next;e.next=t,this.tail===e?this.tail=t:i.previous=t,t.next=i,t.previous=e,++this._length}}class T{_list;_sentinel;_trimTiles;constructor(){this._list=new g,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(e){const t=e._cacheNode;t&&this._list.splice(this._sentinel,t)}add(e,t,i){t._cacheNode||(t._cacheNode=this._list.add(t),i&&i(e,t))}unloadTile(e,t,i){const s=t._cacheNode;s&&(this._list.remove(s),t._cacheNode=null,i&&i(e,t))}unloadTiles(e,t){const i=this._trimTiles;this._trimTiles=!1;const s=this._list,r=1024*e.maximumMemoryUsage*1024,n=this._sentinel;let o=s.head;for(;o!==n&&(e.gpuMemoryUsageInBytes>r||i);){const i=o.item;o=o.next,this.unloadTile(e,i,t)}}trim(){this._trimTiles=!0}}function f(i,s){a(i),a(s);const{rtcCenter:r,gltfUpAxis:o}=s,{computedTransform:l,boundingVolume:{center:h}}=i;let c=new e(l);switch(r&&c.translate(r),o){case"Z":break;case"Y":const t=(new e).rotateX(Math.PI/2);c=c.multiplyRight(t);break;case"X":const i=(new e).rotateY(-Math.PI/2);c=c.multiplyRight(i)}s.isQuantized&&c.translate(s.quantizedVolumeOffset).scale(s.quantizedVolumeScale);const u=new t(h);s.cartesianModelMatrix=c,s.cartesianOrigin=u;const d=n.WGS84.cartesianToCartographic(u,new t),p=n.WGS84.eastNorthUpToFixedFrame(u).invert();s.cartographicModelMatrix=p.multiplyRight(c),s.cartographicOrigin=d,s.coordinateSystem||(s.modelMatrix=s.cartographicModelMatrix)}const y=new t,S=new t,w=new c([new u,new u,new u,new u,new u,new u]);function b(e,i){const{cameraDirection:s,cameraUp:r,height:o}=e,{metersPerUnit:a}=e.distanceScales,l=C(e,e.center),h=n.WGS84.eastNorthUpToFixedFrame(l),c=e.unprojectPosition(e.cameraPosition),u=n.WGS84.cartographicToCartesian(c,new t),d=new t(h.transformAsVector(new t(s).scale(a))).normalize(),p=new t(h.transformAsVector(new t(r).scale(a))).normalize();!function(e){const t=e.getFrustumPlanes(),i=v(t.near,e.cameraPosition),s=C(e,i),r=C(e,e.cameraPosition,S);let n=0;w.planes[n++].fromPointNormal(s,y.copy(s).subtract(r));for(const r in t){if("near"===r)continue;const o=C(e,v(t[r],i,S),S);w.planes[n++].fromPointNormal(o,y.copy(s).subtract(o))}}(e);const m=e.constructor,{longitude:_,latitude:g,width:T,bearing:f,zoom:b}=e;return{camera:{position:u,direction:d,up:p},viewport:e,topDownViewport:new m({longitude:_,latitude:g,height:o,width:T,bearing:f,zoom:b,pitch:0}),height:o,cullingVolume:w,frameNumber:i,sseDenominator:1.15}}function v(e,i,s=new t){const r=e.normal.dot(i);return s.copy(e.normal).scale(e.distance-r).add(i),s}function C(e,i,s=new t){const r=e.unprojectPosition(i);return n.WGS84.cartographicToCartesian(r,s)}const M=6356752.314245179,E=new t;function x(e,t){if(e instanceof d){const{halfAxes:i}=e,s=function(e){e.getColumn(0,E);const t=e.getColumn(1),i=e.getColumn(2),s=E.add(t).add(i);return s.len()}(i);return Math.log2(M/(s+t[2]))}if(e instanceof p){const{radius:i}=e;return Math.log2(M/(i+t[2]))}if(e.width&&e.height){const{width:t,height:i}=e;return(Math.log2(6378137/t)+Math.log2(6378137/i))/2}return 1}function D(e,t,i){n.WGS84.cartographicToCartesian([e.xmax,e.ymax,e.zmax],E);const s=Math.sqrt(Math.pow(E[0]-i[0],2)+Math.pow(E[1]-i[1],2)+Math.pow(E[2]-i[2],2));return Math.log2(M/(s+t[2]))}const V={UNLOADED:0,LOADING:1,PROCESSING:2,READY:3,EXPIRED:4,FAILED:5};var R,U,P,A;!function(e){e[e.ADD=1]="ADD",e[e.REPLACE=2]="REPLACE"}(R||(R={})),function(e){e.EMPTY="empty",e.SCENEGRAPH="scenegraph",e.POINTCLOUD="pointcloud",e.MESH="mesh"}(U||(U={})),function(e){e.I3S="I3S",e.TILES3D="TILES3D"}(P||(P={})),function(e){e.GEOMETRIC_ERROR="geometricError",e.MAX_SCREEN_THRESHOLD="maxScreenThreshold"}(A||(A={}));const I=1;function q(e){return null!=e}const L=new t,N=new t,O=new t,z=new t,B=new t,F=new t,G=new t,k=new t;function W(i,s,o){if(a(i,"3D Tile: boundingVolume must be defined"),i.box)return H(i.box,s,o);if(i.region)return function(i){const[s,o,a,l,h,c]=i,u=n.WGS84.cartographicToCartesian([r(s),r(l),h],O),d=n.WGS84.cartographicToCartesian([r(a),r(o),c],z),p=(new t).addVectors(u,d).multiplyByScalar(.5);return n.WGS84.cartesianToCartographic(p,B),n.WGS84.cartographicToCartesian([r(a),B[1],B[2]],F),n.WGS84.cartographicToCartesian([B[0],r(l),B[2]],G),n.WGS84.cartographicToCartesian([B[0],B[1],c],k),H([...p,...F.subtract(p),...G.subtract(p),...k.subtract(p)],new e)}(i.region);if(i.sphere)return function(e,i,s){const r=new t(e[0],e[1],e[2]);i.transform(r,r);const n=i.getScale(N),o=Math.max(Math.max(n[0],n[1]),n[2]),a=e[3]*o;if(q(s))return s.center=r,s.radius=a,s;return new p(r,a)}(i.sphere,s,o);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function j(e,i){if(e.box)return function(e){const i=$(),{halfAxes:s}=e,r=new t(s.getColumn(0)),n=new t(s.getColumn(1)),o=new t(s.getColumn(2));for(let t=0;t<2;t++){for(let t=0;t<2;t++){for(let t=0;t<2;t++)L.copy(e.center),L.add(r),L.add(n),L.add(o),Z(i,L),o.negate();n.negate()}r.negate()}return i}(i);if(e.region){const[t,i,s,n,o,a]=e.region;return[[r(t),r(i),o],[r(s),r(n),a]]}if(e.sphere)return function(e){const i=$(),{center:s,radius:r}=e,o=n.WGS84.scaleToGeodeticSurface(s,L);let a;a=o?n.WGS84.geodeticSurfaceNormal(o):new t(0,0,1);let l=new t(a[2],-a[1],0);l.len()>0?l.normalize():l=new t(0,1,0);const h=l.clone().cross(a);for(const e of[l,h,a]){N.copy(e).scale(r);for(let e=0;e<2;e++)L.copy(s),L.add(N),Z(i,L),N.negate()}return i}(i);throw new Error("Unkown boundingVolume type")}function H(e,r,n){const o=new t(e[0],e[1],e[2]);r.transform(o,o);let a=[];if(10===e.length){const s=e.slice(3,6),r=new i;r.fromArray(e,6);const n=new t([1,0,0]),o=new t([0,1,0]),l=new t([0,0,1]);n.transformByQuaternion(r),n.scale(s[0]),o.transformByQuaternion(r),o.scale(s[1]),l.transformByQuaternion(r),l.scale(s[2]),a=[...n.toArray(),...o.toArray(),...l.toArray()]}else a=[...e.slice(3,6),...e.slice(6,9),...e.slice(9,12)];const l=r.transformAsVector(a.slice(0,3)),h=r.transformAsVector(a.slice(3,6)),c=r.transformAsVector(a.slice(6,9)),u=new s([l[0],l[1],l[2],h[0],h[1],h[2],c[0],c[1],c[2]]);return q(n)?(n.center=o,n.halfAxes=u,n):new d(o,u)}function $(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function Z(e,t){n.WGS84.cartesianToCartographic(t,L),e[0][0]=Math.min(e[0][0],L[0]),e[0][1]=Math.min(e[0][1],L[1]),e[0][2]=Math.min(e[0][2],L[2]),e[1][0]=Math.max(e[1][0],L[0]),e[1][1]=Math.max(e[1][1],L[1]),e[1][2]=Math.max(e[1][2],L[2])}function X(e,t){if(e.dynamicScreenSpaceError&&e.dynamicScreenSpaceErrorComputedDensity){const i=e.dynamicScreenSpaceErrorComputedDensity,s=e.dynamicScreenSpaceErrorFactor,r=function(e,t){const i=e*t;return 1-Math.exp(-i*i)}(t,i)*s;return r}return 0}new t,new t,new e,new t,new t,new t;const Y=new t,K=new t,Q=new t,J=new t,ee=new t,te=new e,ie=new e;function se(e,t){if(0===e.lodMetricValue||isNaN(e.lodMetricValue))return"DIG";const i=2*re(e,t);return i<2?"OUT":!e.header.children||i<=e.lodMetricValue?"DRAW":e.header.children?"DIG":"OUT"}function re(e,t){const{topDownViewport:i}=t,s=e.header.mbs[1],r=e.header.mbs[0],o=e.header.mbs[2],a=e.header.mbs[3],l=[...e.boundingVolume.center],h=i.unprojectPosition(i.cameraPosition);n.WGS84.cartographicToCartesian(h,Y),K.copy(Y).subtract(l).normalize(),n.WGS84.eastNorthUpToFixedFrame(l,te),ie.copy(te).invert(),Q.copy(Y).transform(ie);const c=Math.sqrt(Q[0]*Q[0]+Q[1]*Q[1]),u=c*c/Q[2];J.copy([Q[0],Q[1],u]);const d=J.transform(te).subtract(l).normalize(),p=K.cross(d).normalize().scale(a).add(l),m=n.WGS84.cartesianToCartographic(p),_=i.project([r,s,o]),g=i.project(m);return ee.copy(_).subtract(g).magnitude()}class ne{_map=new Map;_array;_length;constructor(e=0){this._array=new Array(e),this._length=e}get length(){return this._length}set length(e){this._length=e,e>this._array.length&&(this._array.length=e)}get values(){return this._array}get(e){return a(e<this._array.length),this._array[e]}set(e,t){a(e>=0),e>=this.length&&(this.length=e+1),this._map.has(this._array[e])&&this._map.delete(this._array[e]),this._array[e]=t,this._map.set(t,e)}delete(e){const t=this._map.get(e);t>=0&&(this._array.splice(t,1),this._map.delete(e),this.length--)}peek(){return this._array[this._length-1]}push(e){if(!this._map.has(e)){const t=this.length++;this._array[t]=e,this._map.set(e,t)}}pop(){const e=this._array[--this.length];return this._map.delete(e),e}reserve(e){a(e>=0),e>this._array.length&&(this._array.length=e)}resize(e){a(e>=0),this.length=e}trim(e){null==e&&(e=this.length),this._array.length=e}reset(){this._array=[],this._map=new Map,this._length=0}find(e){return this._map.has(e)}}const oe={loadSiblings:!1,skipLevelOfDetail:!1,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class ae{options;root=null;selectedTiles={};requestedTiles={};emptyTiles={};lastUpdate=(new Date).getTime();updateDebounceTime=1e3;_traversalStack=new ne;_emptyTraversalStack=new ne;_frameNumber=null;traversalFinished(e){return!0}constructor(e){this.options={...oe,...e}}traverse(e,t,i){this.root=e,this.options={...this.options,...i},this.reset(),this.updateTile(e,t),this._frameNumber=t.frameNumber,this.executeTraversal(e,t)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(e,t){const i=this._traversalStack;for(e._selectionDepth=1,i.push(e);i.length>0;){const e=i.pop();let s=!1;this.canTraverse(e,t)&&(this.updateChildTiles(e,t),s=this.updateAndPushChildren(e,t,i,e.hasRenderContent?e._selectionDepth+1:e._selectionDepth));const r=e.parent,n=Boolean(!r||r._shouldRefine),o=!s;e.hasRenderContent?e.refine===R.ADD?(this.loadTile(e,t),this.selectTile(e,t)):e.refine===R.REPLACE&&(this.loadTile(e,t),o&&this.selectTile(e,t)):(this.emptyTiles[e.id]=e,this.loadTile(e,t),o&&this.selectTile(e,t)),this.touchTile(e,t),e._shouldRefine=s&&n}const s=(new Date).getTime();(this.traversalFinished(t)||s-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=s,this.options.onTraversalEnd(t))}updateChildTiles(e,t){const i=e.children;for(const e of i)this.updateTile(e,t)}updateAndPushChildren(e,t,i,s){const{loadSiblings:r,skipLevelOfDetail:n}=this.options,o=e.children;o.sort(this.compareDistanceToCamera.bind(this));const a=e.refine===R.REPLACE&&e.hasRenderContent&&!n;let l=!1,h=!0;for(const e of o)if(e._selectionDepth=s,e.isVisibleAndInRequestVolume?(i.find(e)&&i.delete(e),i.push(e),l=!0):(a||r)&&(this.loadTile(e,t),this.touchTile(e,t)),a){let i;if(i=!!e._inRequestVolume&&(e.hasRenderContent?e.contentAvailable:this.executeEmptyTraversal(e,t)),h=h&&i,!h)return!1}return l||(h=!1),h}updateTile(e,t){this.updateTileVisibility(e,t)}selectTile(e,t){this.shouldSelectTile(e)&&(e._selectedFrame=t.frameNumber,this.selectedTiles[e.id]=e)}loadTile(e,t){this.shouldLoadTile(e)&&(e._requestedFrame=t.frameNumber,e._priority=e._getPriority(),this.requestedTiles[e.id]=e)}touchTile(e,t){e.tileset._cache.touch(e),e._touchedFrame=t.frameNumber}canTraverse(e,t,i=!1,s=!1){return!!e.hasChildren&&(e.hasTilesetContent?!e.contentExpired:!(!s&&!e.isVisibleAndInRequestVolume)&&this.shouldRefine(e,t,i))}shouldLoadTile(e){return e.hasUnloadedContent||e.contentExpired}shouldSelectTile(e){return e.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(e,t,i=!1){let s=e._screenSpaceError;return i&&(s=e.getScreenSpaceError(t,!0)),s>e.tileset.memoryAdjustedScreenSpaceError}updateTileVisibility(e,t){const i=[];if(this.options.viewportTraversersMap)for(const e in this.options.viewportTraversersMap){this.options.viewportTraversersMap[e]===t.viewport.id&&i.push(e)}else i.push(t.viewport.id);e.updateVisibility(t,i)}compareDistanceToCamera(e,t){return e._distanceToCamera-t._distanceToCamera}anyChildrenVisible(e,t){let i=!1;for(const s of e.children)s.updateVisibility(t),i=i||s.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(e,t){let i=!0;const s=this._emptyTraversalStack;for(s.push(e);s.length>0;){const e=s.pop(),r=!e.hasRenderContent&&this.canTraverse(e,t,!1,!1),n=!e.hasRenderContent&&0===e.children.length;if(r||e.contentAvailable||n||(i=!1),this.updateTile(e,t),e.isVisibleAndInRequestVolume||(this.loadTile(e,t),this.touchTile(e,t)),r){const t=e.children;for(const e of t)s.push(e)}}return i}}const le=new t;class he{tileset;header;id;url;parent;refine;type;contentUrl;lodMetricType="geometricError";lodMetricValue=0;boundingVolume=null;content=null;contentState=V.UNLOADED;gpuMemoryUsageInBytes=0;children=[];depth=0;viewportIds=[];transform=new e;extensions=null;implicitTiling=null;userData={};computedTransform;hasEmptyContent=!1;hasTilesetContent=!1;traverser=new ae({});_cacheNode=null;_frameNumber=null;_expireDate=null;_expiredContent=null;_boundingBox=void 0;_distanceToCamera=0;_screenSpaceError=0;_visibilityPlaneMask;_visible=void 0;_contentBoundingVolume;_viewerRequestVolume;_initialTransform=new e;_priority=0;_selectedFrame=0;_requestedFrame=0;_selectionDepth=0;_touchedFrame=0;_centerZDepth=0;_shouldRefine=!1;_stackLength=0;_visitedFrame=0;_inRequestVolume=!1;_lodJudge=null;constructor(e,t,i,s=""){this.header=t,this.tileset=e,this.id=s||t.id,this.url=t.url,this.parent=i,this.refine=this._getRefine(t.refine),this.type=t.type,this.contentUrl=t.contentUrl,this._initializeLodMetric(t),this._initializeTransforms(t),this._initializeBoundingVolumes(t),this._initializeContent(t),this._initializeRenderingState(t),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===V.READY||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===V.UNLOADED}get contentExpired(){return this.contentState===V.EXPIRED}get contentFailed(){return this.contentState===V.FAILED}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=j(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(e,t){switch(this.tileset.type){case P.I3S:return re(this,e);case P.TILES3D:return function(e,t,i){const s=e.tileset,r=e.parent&&e.parent.lodMetricValue||e.lodMetricValue,n=i?r:e.lodMetricValue;if(0===n)return 0;const o=Math.max(e._distanceToCamera,1e-7),{height:a,sseDenominator:l}=t,{viewDistanceScale:h}=s.options;let c=n*a*(h||1)/(o*l);return c-=X(s,o),c}(this,e,t);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const e=this.tileset._traverser,{skipLevelOfDetail:t}=e.options,i=this.refine===R.ADD||t;if(i&&!this.isVisible&&void 0!==this._visible)return-1;if(this.tileset._frameNumber-this._touchedFrame>=1)return-1;if(this.contentState===V.UNLOADED)return-1;const s=this.parent,r=s&&(!i||0===this._screenSpaceError||s.hasTilesetContent)?s._screenSpaceError:this._screenSpaceError,n=e.root?e.root._screenSpaceError:0;return Math.max(n-r,0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=V.LOADING;const e=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!e)return this.contentState=V.UNLOADED,!1;try{const e=this.tileset.getTileUrl(this.contentUrl),t=this.tileset.loader,i={...this.tileset.loadOptions,[t.id]:{...this.tileset.loadOptions[t.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(t.id)}};return this.content=await m(e,t,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=V.READY,this._onContentLoaded(),!0}catch(e){throw this.contentState=V.FAILED,e}finally{e.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=V.UNLOADED,!0}updateVisibility(e,t){if(this._frameNumber===e.frameNumber)return;const i=this.parent,s=i?i._visibilityPlaneMask:c.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){const e=i?i.computedTransform:this.tileset.modelMatrix;this._updateTransform(e)}this._distanceToCamera=this.distanceToTile(e),this._screenSpaceError=this.getScreenSpaceError(e,!1),this._visibilityPlaneMask=this.visibility(e,s),this._visible=this._visibilityPlaneMask!==c.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(e),this._frameNumber=e.frameNumber,this.viewportIds=t}visibility(e,t){const{cullingVolume:i}=e,{boundingVolume:s}=this;return i.computeVisibilityWithPlaneMask(s,t)}contentVisibility(){return!0}distanceToTile(e){const t=this.boundingVolume;return Math.sqrt(Math.max(t.distanceSquaredTo(e.camera.position),0))}cameraSpaceZDepth({camera:e}){const t=this.boundingVolume;return le.subVectors(t.center,e.position),e.direction.dot(le)}insideViewerRequestVolume(e){const t=this._viewerRequestVolume;return!t||t.distanceSquaredTo(e.camera.position)<=0}updateExpiration(){if(null!=this._expireDate&&this.contentReady&&!this.hasEmptyContent){const e=Date.now();Date.lessThan(this._expireDate,e)&&(this.contentState=V.EXPIRED,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(e){"lodMetricType"in e?this.lodMetricType=e.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType")),"lodMetricValue"in e?this.lodMetricValue=e.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}_initializeTransforms(t){this.transform=t.transform?new e(t.transform):new e;const i=this.parent,s=this.tileset,r=i&&i.computedTransform?i.computedTransform.clone():s.modelMatrix.clone();this.computedTransform=new e(r).multiplyRight(this.transform);const n=i&&i._initialTransform?i._initialTransform.clone():new e;this._initialTransform=new e(n).multiplyRight(this.transform)}_initializeBoundingVolumes(e){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(e)}_initializeContent(e){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=V.UNLOADED,this.hasTilesetContent=!1,e.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(e){this.depth=e.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=c.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(e){return e||this.parent&&this.parent.refine||R.REPLACE}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(e){this.boundingVolume=W(e.boundingVolume,this.computedTransform,this.boundingVolume);const t=e.content;t&&(t.boundingVolume&&(this._contentBoundingVolume=W(t.boundingVolume,this.computedTransform,this._contentBoundingVolume)),e.viewerRequestVolume&&(this._viewerRequestVolume=W(e.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(t=new e){const i=t.clone().multiplyRight(this.transform);!i.equals(this.computedTransform)&&(this.computedTransform=i,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(e){return"i3s"===e?{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1}:{assetGltfUpAxis:(t=this.tileset.tileset).asset&&t.asset.gltfUpAxis||"Y"};var t}}class ce extends ae{compareDistanceToCamera(e,t){return 0===t._distanceToCamera&&0===e._distanceToCamera?t._centerZDepth-e._centerZDepth:t._distanceToCamera-e._distanceToCamera}updateTileVisibility(e,t){if(super.updateTileVisibility(e,t),!e.isVisibleAndInRequestVolume)return;const i=e.children.length>0;if(e.hasTilesetContent&&i){const i=e.children[0];return this.updateTileVisibility(i,t),void(e._visible=i._visible)}if(this.meetsScreenSpaceErrorEarly(e,t))return void(e._visible=!1);const s=e.refine===R.REPLACE,r=e._optimChildrenWithinParent===I;s&&r&&i&&!this.anyChildrenVisible(e,t)&&(e._visible=!1)}meetsScreenSpaceErrorEarly(e,t){const{parent:i}=e;return!(!i||i.hasTilesetContent||i.refine!==R.ADD)&&!this.shouldRefine(e,t,!0)}}class ue{frameNumberMap=new Map;register(e,t){const i=this.frameNumberMap.get(e)||new Map,s=i.get(t)||0;i.set(t,s+1),this.frameNumberMap.set(e,i)}deregister(e,t){const i=this.frameNumberMap.get(e);if(!i)return;const s=i.get(t)||1;i.set(t,s-1)}isZero(e,t){return 0===(this.frameNumberMap.get(e)?.get(t)||0)}}const de="REQUESTED",pe="COMPLETED",me="ERROR";class _e{_statusMap;pendingTilesRegister=new ue;constructor(){this._statusMap={}}add(e,t,i,s){if(!this._statusMap[t]){const{frameNumber:r,viewport:{id:n}}=s;this._statusMap[t]={request:e,callback:i,key:t,frameState:s,status:de},this.pendingTilesRegister.register(n,r),e().then((e=>{this._statusMap[t].status=pe;const{frameNumber:i,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,i),this._statusMap[t].callback(e,s)})).catch((e=>{this._statusMap[t].status=me;const{frameNumber:s,viewport:{id:r}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(r,s),i(e)}))}}update(e,t){if(this._statusMap[e]){const{frameNumber:i,viewport:{id:s}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(s,i);const{frameNumber:r,viewport:{id:n}}=t;this.pendingTilesRegister.register(n,r),this._statusMap[e].frameState=t}}find(e){return this._statusMap[e]}hasPendingTiles(e,t){return!this.pendingTilesRegister.isZero(e,t)}}class ge extends ae{_tileManager;constructor(e){super(e),this._tileManager=new _e}traversalFinished(e){return!this._tileManager.hasPendingTiles(e.viewport.id,this._frameNumber||0)}shouldRefine(e,t){return e._lodJudge=se(e,t),"DIG"===e._lodJudge}updateChildTiles(e,t){const i=e.header.children||[],s=e.children,r=e.tileset;for(const n of i){const i=`${n.id}-${t.viewport.id}`,o=s&&s.find((e=>e.id===i));if(o)o&&this.updateTile(o,t);else{let s=()=>this._loadTile(n.id,r);this._tileManager.find(i)?this._tileManager.update(i,t):(r.tileset.nodePages&&(s=()=>r.tileset.nodePagesTile.formTileFromNodePages(n.id)),this._tileManager.add(s,i,(t=>this._onTileLoad(t,e,i)),t))}}return!1}async _loadTile(e,t){const{loader:i}=t,s=t.getTileUrl(`${t.url}/nodes/${e}`),r={...t.loadOptions,i3s:{...t.loadOptions.i3s,isTileHeader:!0}};return await m(s,i,r)}_onTileLoad(e,t,i){const s=new he(t.tileset,e,t,i);t.children.push(s);const r=this._tileManager.find(s.id).frameState;this.updateTile(s,r),this._frameNumber===r.frameNumber&&(this.traversalFinished(r)||(new Date).getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(s,r)}}const Te={description:"",ellipsoid:n.WGS84,modelMatrix:new e,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,memoryCacheOverflow:1,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:e=>e,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,memoryAdjustedScreenSpaceError:!1,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},fe="Tiles In Tileset(s)",ye="Tiles In Memory",Se="Tiles In View",we="Tiles To Render",be="Tiles Loaded",ve="Tiles Loading",Ce="Tiles Unloaded",Me="Failed Tile Loads",Ee="Points/Vertices",xe="Tile Memory Use",De="Maximum Screen Space Error";class Ve{options;loadOptions;type;tileset;loader;url;basePath;modelMatrix;ellipsoid;lodMetricType;lodMetricValue;refine;root=null;roots={};asset={};description="";properties;extras=null;attributions={};credits={};stats;contentFormats={draco:!1,meshopt:!1,dds:!1,ktx2:!1};cartographicCenter=null;cartesianCenter=null;zoom=1;boundingVolume=null;dynamicScreenSpaceErrorComputedDensity=0;maximumMemoryUsage=32;gpuMemoryUsageInBytes=0;memoryAdjustedScreenSpaceError=0;_cacheBytes=0;_cacheOverflowBytes=0;_frameNumber=0;_queryParams={};_extensionsUsed=[];_tiles={};_pendingCount=0;selectedTiles=[];traverseCounter=0;geometricError=0;lastUpdatedVieports=null;_requestedTiles=[];_emptyTiles=[];frameStateData={};_traverser;_cache=new T;_requestScheduler;updatePromise=null;tilesetInitializationPromise;constructor(e,t){this.options={...Te,...t},this.tileset=e,this.loader=e.loader,this.type=e.type,this.url=e.url,this.basePath=e.basePath||l.dirname(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=e.lodMetricType,this.lodMetricValue=e.lodMetricValue,this.refine=e.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new h({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.memoryAdjustedScreenSpaceError=this.options.maximumScreenSpaceError,this._cacheBytes=1024*this.options.maximumMemoryUsage*1024,this._cacheOverflowBytes=1024*this.options.memoryCacheOverflow*1024,this.stats=new o({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(e)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber&&0===this._requestedTiles.length}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(e){this.options={...this.options,...e}}getTileUrl(e){if(e.startsWith("data:"))return e;let t=e;return this.queryParams.length&&(t=`${e}${e.includes("?")?"&":"?"}${this.queryParams}`),t}hasExtension(e){return Boolean(this._extensionsUsed.indexOf(e)>-1)}update(e=null){this.tilesetInitializationPromise.then((()=>{!e&&this.lastUpdatedVieports?e=this.lastUpdatedVieports:this.lastUpdatedVieports=e,e&&this.doUpdate(e)}))}async selectTiles(e=null){return await this.tilesetInitializationPromise,e&&(this.lastUpdatedVieports=e),this.updatePromise||(this.updatePromise=new Promise((e=>{setTimeout((()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),e(this._frameNumber),this.updatePromise=null}),this.options.debounceTime)}))),this.updatePromise}adjustScreenSpaceError(){this.gpuMemoryUsageInBytes<this._cacheBytes?this.memoryAdjustedScreenSpaceError=Math.max(this.memoryAdjustedScreenSpaceError/1.02,this.options.maximumScreenSpaceError):this.gpuMemoryUsageInBytes>this._cacheBytes+this._cacheOverflowBytes&&(this.memoryAdjustedScreenSpaceError*=1.02)}doUpdate(e){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;const t=e instanceof Array?e:[e];this._cache.reset(),this._frameNumber++,this.traverseCounter=t.length;const i=[];for(const e of t){const t=e.id;this._needTraverse(t)?i.push(t):this.traverseCounter--}for(const e of t){const t=e.id;if(this.roots[t]||(this.roots[t]=this._initializeTileHeaders(this.tileset,null)),!i.includes(t))continue;const s=b(e,this._frameNumber);this._traverser.traverse(this.roots[t],s,this.options)}}_needTraverse(e){let t=e;return this.options.viewportTraversersMap&&(t=this.options.viewportTraversersMap[e]),t===e}_onTraversalEnd(e){const t=e.viewport.id;this.frameStateData[t]||(this.frameStateData[t]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[t],s=Object.values(this._traverser.selectedTiles),[r,n]=function(e,t,i){if(0===i||e.length<=i)return[e,[]];const s=[],{longitude:r,latitude:n}=t.viewport;for(const[t,i]of e.entries()){const[e,o]=i.header.mbs,a=Math.abs(r-e),l=Math.abs(n-o),h=Math.sqrt(l*l+a*a);s.push([t,h])}const o=s.sort(((e,t)=>e[1]-t[1])),a=[];for(let t=0;t<i;t++)a.push(e[o[t][0]]);const l=[];for(let t=i;t<o.length;t++)l.push(e[o[t][0]]);return[a,l]}(s,e,this.options.maximumTilesSelected);i.selectedTiles=r;for(const e of n)e.unselect();i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const e in this.frameStateData){const t=this.frameStateData[e];this.selectedTiles=this.selectedTiles.concat(t.selectedTiles),this._requestedTiles=this._requestedTiles.concat(t._requestedTiles),this._emptyTiles=this._emptyTiles.concat(t._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const e of this.selectedTiles)this._tiles[e.id]=e;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(e,t){if(e.length!==t.length)return!0;const i=new Set(e.map((e=>e.id))),s=new Set(t.map((e=>e.id)));let r=e.filter((e=>!s.has(e.id))).length>0;return r=r||t.filter((e=>!i.has(e.id))).length>0,r}_loadTiles(){for(const e of this._requestedTiles)e.contentUnloaded&&this._loadTile(e)}_unloadTiles(){this._cache.unloadTiles(this,((e,t)=>e._unloadTile(t)))}_updateStats(){let e=0,t=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(e++,i.content.pointCount?t+=i.content.pointCount:t+=i.content.vertexCount);this.stats.get(Se).count=this.selectedTiles.length,this.stats.get(we).count=e,this.stats.get(Ee).count=t,this.stats.get(De).count=this.memoryAdjustedScreenSpaceError}async _initializeTileSet(e){this.type===P.I3S&&(this.calculateViewPropsI3S(),e.root=await e.root),this.root=this._initializeTileHeaders(e,null),this.type===P.TILES3D&&(this._initializeTiles3DTileset(e),this.calculateViewPropsTiles3D()),this.type===P.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){const e=this.tileset.fullExtent;if(e){const{xmin:i,xmax:s,ymin:r,ymax:o,zmin:a,zmax:l}=e;return this.cartographicCenter=new t(i+(s-i)/2,r+(o-r)/2,a+(l-a)/2),this.cartesianCenter=new t,n.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),void(this.zoom=D(e,this.cartographicCenter,this.cartesianCenter))}const i=this.tileset.store?.extent;if(i){const[e,s,r,o]=i;return this.cartographicCenter=new t(e+(r-e)/2,s+(o-s)/2,0),this.cartesianCenter=new t,n.WGS84.cartographicToCartesian(this.cartographicCenter,this.cartesianCenter),void(this.zoom=function(e,t,i){const[s,r,n,o]=e;return D({xmin:s,xmax:n,ymin:r,ymax:o,zmin:0,zmax:0},t,i)}(i,this.cartographicCenter,this.cartesianCenter))}console.warn("Extent is not defined in the tileset header"),this.cartographicCenter=new t,this.zoom=1}calculateViewPropsTiles3D(){const e=this.root,{center:i}=e.boundingVolume;if(!i)return console.warn("center was not pre-calculated for the root tile"),this.cartographicCenter=new t,void(this.zoom=1);0!==i[0]||0!==i[1]||0!==i[2]?(this.cartographicCenter=new t,n.WGS84.cartesianToCartographic(i,this.cartographicCenter)):this.cartographicCenter=new t(0,0,-n.WGS84.radii[0]),this.cartesianCenter=i,this.zoom=x(e.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(fe),this.stats.get(ve),this.stats.get(ye),this.stats.get(Se),this.stats.get(we),this.stats.get(be),this.stats.get(Ce),this.stats.get(Me),this.stats.get(Ee),this.stats.get(xe,"memory"),this.stats.get(De)}_initializeTileHeaders(e,t){const i=new he(this,e.root,t);if(t&&(t.children.push(i),i.depth=t.depth+1),this.type===P.TILES3D){const e=[];for(e.push(i);e.length>0;){const t=e.pop();this.stats.get(fe).incrementCount();const i=t.header.children||[];for(const s of i){const i=new he(this,s,t);if(i.contentUrl?.includes("?session=")){const e=new URL(i.contentUrl).searchParams.get("session");e&&(this._queryParams.session=e)}t.children.push(i),i.depth=t.depth+1,e.push(i)}}}return i}_initializeTraverser(){let e;switch(this.type){case P.TILES3D:e=ce;break;case P.I3S:e=ge;break;default:e=ae}return new e({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(e){this._destroySubtree(e)}async _loadTile(e){let t;try{this._onStartTileLoading(),t=await e.loadContent()}catch(t){this._onTileLoadError(e,t instanceof Error?t:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(e,t)}}_onTileLoadError(e,t){this.stats.get(Me).incrementCount();const i=t.message||t.toString(),s=e.url;console.error(`A 3D tile failed to load: ${e.url} ${i}`),this.options.onTileError(e,i,s)}_onTileLoad(e,t){if(t){if(this.type===P.I3S){const e=this.tileset?.nodePagesTile?.nodesInNodePages||0;this.stats.get(fe).reset(),this.stats.get(fe).addCount(e)}e&&e.content&&f(e,e.content),this.updateContentTypes(e),this._addTileToCache(e),this.options.onTileLoad(e)}}updateContentTypes(e){if(this.type===P.I3S)switch(e.header.isDracoGeometry&&(this.contentFormats.draco=!0),e.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0}else if(this.type===P.TILES3D){const{extensionsRemoved:t=[]}=e.content?.gltf||{};t.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),t.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),t.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(ve).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(ve).decrementCount()}_addTileToCache(e){this._cache.add(this,e,(t=>t._updateCacheStats(e)))}_updateCacheStats(e){this.stats.get(be).incrementCount(),this.stats.get(ye).incrementCount(),this.gpuMemoryUsageInBytes+=e.gpuMemoryUsageInBytes||0,this.stats.get(xe).count=this.gpuMemoryUsageInBytes,this.options.memoryAdjustedScreenSpaceError&&this.adjustScreenSpaceError()}_unloadTile(e){this.gpuMemoryUsageInBytes-=e.gpuMemoryUsageInBytes||0,this.stats.get(ye).decrementCount(),this.stats.get(Ce).incrementCount(),this.stats.get(xe).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(e),e.unloadContent()}_destroy(){const e=[];for(this.root&&e.push(this.root);e.length>0;){const t=e.pop();for(const i of t.children)e.push(i);this._destroyTile(t)}this.root=null}_destroySubtree(e){const t=e,i=[];for(i.push(t);i.length>0;){e=i.pop();for(const t of e.children)i.push(t);e!==t&&this._destroyTile(e)}t.children=[]}_destroyTile(e){this._cache.unloadTile(this,e),this._unloadTile(e),e.destroy()}_initializeTiles3DTileset(e){if(e.queryString){const t=new URLSearchParams(e.queryString),i=Object.fromEntries(t.entries());this._queryParams={...this._queryParams,...i}}if(this.asset=e.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version&&"1.1"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version either 0.0 or 1.0 or 1.1.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=e.properties,this.geometricError=e.geometricError,this._extensionsUsed=e.extensionsUsed||[],this.extras=e.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}export{A as LOD_METRIC_TYPE,P as TILESET_TYPE,V as TILE_CONTENT_STATE,R as TILE_REFINEMENT,U as TILE_TYPE,he as Tile3D,Ve as Tileset3D,T as TilesetCache,ae as TilesetTraverser,f as calculateTransformProps,W as createBoundingVolume,b as getFrameState,se as getLodStatus};export default null;
