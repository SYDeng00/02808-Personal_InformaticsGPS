/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@loaders.gl/worker-utils@4.2.0/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
const e="latest";const r=(globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.2.0-beta.2"),globalThis._loadersgl_.version);function t(e,r){if(!e)throw new Error(r||"loaders.gl assertion failed.")}var o="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}var i=s,a=n;function c(e){if(i===setTimeout)return setTimeout(e,0);if((i===s||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(r){try{return i.call(null,e,0)}catch(r){return i.call(this,e,0)}}}"function"==typeof o.setTimeout&&(i=setTimeout),"function"==typeof o.clearTimeout&&(a=clearTimeout);var u,l=[],h=!1,d=-1;function p(){h&&u&&(h=!1,u.length?l=u.concat(l):d=-1,l.length&&f())}function f(){if(!h){var e=c(p);h=!0;for(var r=l.length;r;){for(u=l,l=[];++d<r;)u&&u[d].run();d=-1,r=l.length}u=null,h=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===n||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{return a(e)}catch(r){try{return a.call(null,e)}catch(r){return a.call(this,e)}}}(e)}}function m(e,r){this.fun=e,this.array=r}m.prototype.run=function(){this.fun.apply(null,this.array)};function g(){}var w=g,y=g,b=g,v=g,k=g,_=g,T=g;var E=o.performance||{},M=E.now||E.mozNow||E.msNow||E.oNow||E.webkitNow||function(){return(new Date).getTime()};var P=new Date;var $={nextTick:function(e){var r=new Array(arguments.length-1);if(arguments.length>1)for(var t=1;t<arguments.length;t++)r[t-1]=arguments[t];l.push(new m(e,r)),1!==l.length||h||c(f)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:w,addListener:y,once:b,off:v,removeListener:k,removeAllListeners:_,emit:T,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var r=.001*M.call(E),t=Math.floor(r),o=Math.floor(r%1*1e9);return e&&(t-=e[0],(o-=e[1])<0&&(t--,o+=1e9)),[t,o]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-P)/1e3}};const x="object"!=typeof $||"[object process]"!==String($)||$.browser,W="function"==typeof importScripts,C="undefined"!=typeof window&&void 0!==window.orientation,S=void 0!==$&&$.version&&/v([0-9]*)/.exec($.version);S&&parseFloat(S[1]);class j{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,r){this.name=e,this.workerThread=r,this.result=new Promise(((e,r)=>{this._resolve=e,this._reject=r}))}postMessage(e,r){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:r})}done(e){t(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){t(this.isRunning),this.isRunning=!1,this._reject(e)}}class L{terminate(){}}const D=new Map;function N(e){t(e.source&&!e.url||!e.source&&e.url);let r=D.get(e.source||e.url);return r||(e.url&&(r=function(e){if(!e.startsWith("http"))return e;return F((r=e,`try {\n  importScripts('${r}');\n} catch (error) {\n  console.error(error);\n  throw error;\n}`));var r}(e.url),D.set(e.url,r)),e.source&&(r=F(e.source),D.set(e.source,r))),t(r),r}function F(e){const r=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(r)}function Q(e,r=!0,t){const o=t||new Set;if(e){if(A(e))o.add(e);else if(A(e.buffer))o.add(e.buffer);else if(ArrayBuffer.isView(e));else if(r&&"object"==typeof e)for(const t in e)Q(e[t],r,o)}else;return void 0===t?Array.from(o):[]}function A(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}function B(e){if(null===e)return{};const r=Object.assign({},e);return Object.keys(r).forEach((t=>{"object"!=typeof e[t]||ArrayBuffer.isView(e[t])||e[t]instanceof Array?"function"==typeof r[t]||r[t]instanceof RegExp?r[t]={}:r[t]=e[t]:r[t]=B(e[t])})),r}const R=()=>{};class I{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return"undefined"!=typeof Worker&&x||void 0!==L&&!x}constructor(e){const{name:r,source:o,url:s}=e;t(o||s),this.name=r,this.source=o,this.url=s,this.onMessage=R,this.onError=e=>console.log(e),this.worker=x?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=R,this.onError=R,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,r){r=r||Q(e),this.worker.postMessage(e,r)}_getErrorFromErrorEvent(e){let r="Failed to load ";return r+=`worker ${this.name} from ${this.url}. `,e.message&&(r+=`${e.message} in `),e.lineno&&(r+=`:${e.lineno}:${e.colno}`),new Error(r)}_createBrowserWorker(){this._loadableURL=N({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>console.error(e),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new L(r,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new L(this.source,{eval:!0})}return e.on("message",(e=>{this.onMessage(e)})),e.on("error",(e=>{this.onError(e)})),e.on("exit",(e=>{})),e}}class U{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return I.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,r=((e,r,t)=>e.done(t)),t=((e,r)=>e.error(r))){const o=new Promise((o=>(this.jobQueue.push({name:e,onMessage:r,onError:t,onStart:o}),this)));return this._startQueuedJob(),await o}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const r=this.jobQueue.shift();if(r){this.onDebug({message:"Starting job",name:r.name,workerThread:e,backlog:this.jobQueue.length});const t=new j(r.name,e);e.onMessage=e=>r.onMessage(t,e.type,e.payload),e.onError=e=>r.onError(t,e),r.onStart(t);try{await t.result}catch(e){console.error(`Worker exception: ${e}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!x||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new I({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return C?this.maxMobileConcurrency:this.maxConcurrency}}const J={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class O{props;workerPools=new Map;static _workerFarm;static isSupported(){return I.isSupported()}static getWorkerFarm(e={}){return O._workerFarm=O._workerFarm||new O({}),O._workerFarm.setProps(e),O._workerFarm}constructor(e){this.props={...J},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:r,source:t,url:o}=e;let s=this.workerPools.get(r);return s||(s=new U({name:r,source:t,url:o}),s.setProps(this._getWorkerPoolProps()),this.workerPools.set(r,s)),s}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}async function q(){return null}const V=new Map;class z{static async inWorkerThread(){return"undefined"!=typeof self||Boolean(await q())}static set onmessage(e){async function r(r){const t=await q(),{type:o,payload:s}=t?r:r.data;e(o,s)}q().then((e=>{e?(e.on("message",(e=>{r(e)})),e.on("exit",(()=>console.debug("Node worker closing")))):globalThis.onmessage=r}))}static async addEventListener(e){let r=V.get(e);r||(r=async r=>{if(!function(e){const{type:r,data:t}=e;return"message"===r&&t&&"string"==typeof t.source&&t.source.startsWith("loaders.gl")}(r))return;const t=await q(),{type:o,payload:s}=t?r:r.data;e(o,s)});await q()?console.error("not implemented"):globalThis.addEventListener("message",r)}static async removeEventListener(e){const r=V.get(e);V.delete(e);await q()?console.error("not implemented"):globalThis.removeEventListener("message",r)}static async postMessage(e,r){const t={source:"loaders.gl",type:e,payload:r},o=Q(r),s=await q();s?s.postMessage(t,o):globalThis.postMessage(t,o)}}function G(r,o={}){const s=o[r.id]||{},n=x?`${r.id}-worker.js`:`${r.id}-worker-node.js`;let i=s.workerUrl;if(i||"compression"!==r.id||(i=o.workerUrl),"test"===o._workerType&&(i=x?`modules/${r.module}/dist/${n}`:`modules/${r.module}/src/workers/${r.id}-worker-node.ts`),!i){let t=r.version;"latest"===t&&(t=e);const o=t?`@${t}`:"";i=`https://unpkg.com/@loaders.gl/${r.module}${o}/dist/${n}`}return t(i),i}function H(e,r){return!!O.isSupported()&&(e.worker&&r?.worker)}async function K(e,t,o={},s={}){const n=function(e){const t=e.version!==r?` (worker-utils@${r})`:"";return`${e.name}@${e.version}${t}`}(e),i=O.getWorkerFarm(o),{source:a}=o,c={name:n,source:a};a||(c.url=G(e,o));const u=i.getWorkerPool(c),l=o.jobName||e.name,h=await u.startJob(l,X.bind(null,s)),d=B(o);h.postMessage("process",{input:t,options:d});return(await h.result).result}async function X(e,r,t,o){switch(t){case"done":r.done(o);break;case"error":r.error(new Error(o.error));break;case"process":const{id:s,input:n,options:i}=o;try{if(!e.process)return void r.postMessage("error",{id:s,error:"Worker not set up to process on main thread"});const t=await e.process(n,i);r.postMessage("done",{id:s,result:t})}catch(e){const t=e instanceof Error?e.message:"unknown error";r.postMessage("error",{id:s,error:t})}break;default:console.warn(`process-on-worker: unknown message ${t}`)}}class Y{_values;_settlers;_closed;constructor(){this._values=[],this._settlers=[],this._closed=!1}[Symbol.asyncIterator](){return this}push(e){return this.enqueue(e)}enqueue(e){if(this._closed)throw new Error("Closed");if(this._settlers.length>0){if(this._values.length>0)throw new Error("Illegal internal state");const r=this._settlers.shift();e instanceof Error?r.reject(e):r.resolve({value:e})}else this._values.push(e)}close(){for(;this._settlers.length>0;){this._settlers.shift().resolve({done:!0})}this._closed=!0}next(){if(this._values.length>0){const e=this._values.shift();return e instanceof Error?Promise.reject(e):Promise.resolve({done:!1,value:e})}if(this._closed){if(this._settlers.length>0)throw new Error("Illegal internal state");return Promise.resolve({done:!0,value:void 0})}return new Promise(((e,r)=>{this._settlers.push({resolve:e,reject:r})}))}}let Z,ee,re=0;async function te(e,r){if(!await z.inWorkerThread())return;const t={process:oe};z.onmessage=async(o,s)=>{try{switch(o){case"process":if(!e)throw new Error("Worker does not support atomic processing");const o=await e(s.input,s.options||{},t);z.postMessage("done",{result:o});break;case"process-in-batches":if(!r)throw new Error("Worker does not support batched processing");Z=new Y,ee=s.options||{};const n=r(Z,ee,t);for await(const e of n)z.postMessage("output-batch",{result:e});z.postMessage("done",{});break;case"input-batch":Z.push(s.input);break;case"input-done":Z.close()}}catch(e){const r=e instanceof Error?e.message:"";z.postMessage("error",{error:r})}}}function oe(e,r={}){return new Promise(((t,o)=>{const s=re++,n=(e,r)=>{if(r.id===s)switch(e){case"done":z.removeEventListener(n),t(r.result);break;case"error":z.removeEventListener(n),o(r.error)}};z.addEventListener(n);const i={id:s,input:e,options:r};z.postMessage("process",i)}))}function se(e,o=r){t(e,"no worker provided");const s=e.version;return!(!o||!s)}const ne={};async function ie(e,r=null,t={},o=null){return r&&(e=ae(e,r,t,o)),ne[e]=ne[e]||async function(e){if(e.endsWith("wasm"))return await async function(e){const{readFileAsArrayBuffer:r}=globalThis.loaders||{};if(x||!r||e.startsWith("http")){const r=await fetch(e);return await r.arrayBuffer()}return await r(e)}(e);if(!x)try{const{requireFromFile:r}=globalThis.loaders||{};return await(r?.(e))}catch(e){return console.error(e),null}if(W)return importScripts(e);const r=await async function(e){const{readFileAsText:r}=globalThis.loaders||{};if(x||!r||e.startsWith("http")){const r=await fetch(e);return await r.text()}return await r(e)}(e);return function(e,r){if(!x){const{requireFromString:t}=globalThis.loaders||{};return t?.(e,r)}if(W)return eval.call(globalThis,e),null;const t=document.createElement("script");t.id=r;try{t.appendChild(document.createTextNode(e))}catch(r){t.text=e}return document.body.appendChild(t),null}(r,e)}(e),await ne[e]}function ae(e,o,s={},n=null){if(!s.useLocalLibraries&&e.startsWith("http"))return e;n=n||e;const i=s.modules||{};return i[n]?i[n]:x?s.CDN?(t(s.CDN.startsWith("http")),`${s.CDN}/${o}@${r}/dist/libs/${n}`):W?`../src/libs/${n}`:`modules/${o}/src/libs/${n}`:`modules/${o}/dist/libs/${n}`}var ce={};const ue={command:"",arguments:[],port:5e3,autoPort:!0,wait:2e3,onSuccess:e=>{console.log(`Started ${e.props.command}`)}};class le{id;props={...ue};childProcess=null;port=0;successTimer;constructor({id:e="browser-driver"}={}){this.id=e}async start(e){e={...ue,...e},this.props=e;const r=[...e.arguments];return this.port=Number(e.port),e.portArg&&(e.autoPort&&(this.port=await function(e=3e3){return new Promise((r=>{ce.exec("lsof -i -P -n | grep LISTEN",((t,o)=>{if(t)return void r(e);const s=[],n=/:(\d+) \(LISTEN\)/;o.split("\n").forEach((e=>{const r=n.exec(e);r&&s.push(Number(r[1]))}));let i=e;for(;s.includes(i);)i++;r(i)}))}))}(e.port)),r.push(e.portArg,String(this.port))),await new Promise(((t,o)=>{try{this._setTimeout((()=>{e.onSuccess&&e.onSuccess(this),t({})})),console.log(`Spawning ${e.command} ${e.arguments.join(" ")}`);const s=ce.spawn(e.command,r,e.spawn);this.childProcess=s,s.stdout.on("data",(e=>{console.log(e.toString())})),s.stderr.on("data",(r=>{console.log(`Child process wrote to stderr: "${r}".`),e.ignoreStderr||(this._clearTimeout(),o(new Error(r)))})),s.on("error",(e=>{console.log(`Child process errored with ${e}`),this._clearTimeout(),o(e)})),s.on("close",(e=>{console.log(`Child process exited with ${e}`),this.childProcess=null,this._clearTimeout(),t({})}))}catch(e){o(e)}}))}async stop(){this.childProcess&&(this.childProcess.kill(),this.childProcess=null)}async exit(e=0){try{await this.stop(),$.exit(e)}catch(e){console.error(e.message||e),$.exit(1)}}_setTimeout(e){Number(this.props.wait)>0&&(this.successTimer=setTimeout(e,this.props.wait))}_clearTimeout(){this.successTimer&&clearTimeout(this.successTimer)}}const he={id:"null",name:"null",module:"worker-utils",version:r,options:{null:{}}};export{Y as AsyncQueue,le as ChildProcessProxy,he as NullWorker,z as WorkerBody,O as WorkerFarm,j as WorkerJob,U as WorkerPool,I as WorkerThread,t as assert,H as canProcessOnWorker,te as createWorker,ae as getLibraryUrl,Q as getTransferList,B as getTransferListForWriter,G as getWorkerURL,x as isBrowser,W as isWorker,ie as loadLibrary,K as processOnWorker,se as validateWorkerVersion};export default null;
