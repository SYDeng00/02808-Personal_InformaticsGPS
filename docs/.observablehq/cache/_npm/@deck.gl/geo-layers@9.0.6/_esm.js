/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/@deck.gl/geo-layers@9.0.6/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{CompositeLayer as e,_deepEqual as t,COORDINATE_SYSTEM as i,_GlobeViewport as s,WebMercatorViewport as o,_flatten as r,createIterable as n,log as a}from"../core@9.0.6/_esm.js";import{BitmapLayer as l,ArcLayer as c,PolygonLayer as d,GeoJsonLayer as h,PathLayer as u,ColumnLayer as p,PointCloudLayer as g}from"../layers@9.0.6/_esm.js";import{ImageSource as m,createImageSource as f}from"../../@loaders.gl/wms@4.2.0/_esm.js";import{lngLatToWorld as y,worldToLngLat as x}from"../../@math.gl/web-mercator@4.0.1/_esm.js";import _ from"../../long@3.2.0/_esm.js";import{RequestScheduler as v}from"../../@loaders.gl/loader-utils@4.2.0/_esm.js";import{Matrix4 as b,equals as T,lerp as S}from"../../@math.gl/core@4.0.1/_esm.js";import{Plane as L,CullingVolume as M,makeOrientedBoundingBoxFromPoints as C,AxisAlignedBoundingBox as w}from"../../@math.gl/culling@4.0.1/_esm.js";import{cellToLatLng as P,cellToBoundary as z,getResolution as I,isPentagon as R,getHexagonEdgeLengthAvg as O,latLngToCell as F,gridDistance as E,cellsToMultiPolygon as A}from"../../h3-js@4.1.0/_esm.js";import{Model as N,Geometry as D}from"../../@luma.gl/engine@9.0.9/_esm.js";import{SimpleMeshLayer as k,ScenegraphLayer as j}from"../mesh-layers@9.0.6/_esm.js";import{parsePBRMaterial as B}from"../../@luma.gl/gltf@9.0.9/_esm.js";import{pbr as U}from"../../@luma.gl/shadertools@9.0.9/_esm.js";import{load as V}from"../../@loaders.gl/core@4.2.0/_esm.js";import{Tileset3D as H,TILE_TYPE as q}from"../../@loaders.gl/tiles@4.2.0/_esm.js";import{Tiles3DLoader as Z}from"../../@loaders.gl/3d-tiles@4.2.0/_esm.js";import{TerrainWorkerLoader as W}from"../../@loaders.gl/terrain@4.2.0/_esm.js";import{ClipExtension as G}from"../extensions@9.0.6/_esm.js";import{MVTWorkerLoader as $}from"../../@loaders.gl/mvt@4.2.0/_esm.js";import{binaryToGeojson as J}from"../../@loaders.gl/gis@4.2.0/_esm.js";const K=6378137*Math.PI;function X(e){const t=y(e);return t[0]=(t[0]/256-1)*K,t[1]=(t[1]/256-1)*K,t}const Y={id:"imagery-layer",data:"",serviceType:"auto",srs:"auto",layers:{type:"array",compare:!0,value:[]},onMetadataLoad:{type:"function",value:()=>{}},onMetadataLoadError:{type:"function",value:console.error},onImageLoadStart:{type:"function",value:()=>{}},onImageLoad:{type:"function",value:()=>{}},onImageLoadError:{type:"function",compare:!1,value:(e,t)=>console.error(t,e)}};class Q extends e{static{this.layerName="WMSLayer"}static{this.defaultProps=Y}get isLoaded(){return 0===this.state?.loadCounter&&super.isLoaded}shouldUpdateState(){return!0}initializeState(){this.state._nextRequestId=0,this.state.lastRequestId=-1,this.state.loadCounter=0}updateState({changeFlags:e,props:i,oldProps:s}){const{viewport:o}=this.context;e.dataChanged||i.serviceType!==s.serviceType?(this.state.imageSource=this._createImageSource(i),this._loadMetadata(),this.debounce((()=>this.loadImage(o,"image source changed")),0)):t(i.layers,s.layers,1)?e.viewportChanged&&this.debounce((()=>this.loadImage(o,"viewport changed"))):this.debounce((()=>this.loadImage(o,"layers changed")),0)}finalizeState(){}renderLayers(){const{bounds:e,image:t,lastRequestParameters:s}=this.state;return t&&new l({...this.getSubLayerProps({id:"bitmap"}),_imageCoordinateSystem:"EPSG:4326"===s.srs?i.LNGLAT:i.CARTESIAN,bounds:e,image:t})}async getFeatureInfoText(e,t){const{lastRequestParameters:i}=this.state;if(i){return await(this.state.imageSource.getFeatureInfoText?.({...i,query_layers:i.layers,x:e,y:t,info_format:"application/vnd.ogc.gml"}))}return""}_createImageSource(e){if(e.data instanceof m)return e.data;if("string"==typeof e.data)return f({url:e.data,loadOptions:e.loadOptions,type:e.serviceType});throw new Error("invalid image source in props.data")}async _loadMetadata(){const{imageSource:e}=this.state;try{this.state.loadCounter++;const t=await e.getMetadata();this.state.imageSource===e&&this.getCurrentLayer()?.props.onMetadataLoad(t)}catch(e){this.getCurrentLayer()?.props.onMetadataLoadError(e)}finally{this.state.loadCounter--}}async loadImage(e,t){const{layers:i,serviceType:s}=this.props;if("wms"===s&&0===i.length)return;const o=e.getBounds(),{width:r,height:n}=e,a=this.getRequestId();let{srs:l}=this.props;"auto"===l&&(l=e.resolution?"EPSG:4326":"EPSG:3857");const c={width:r,height:n,boundingBox:[[o[0],o[1]],[o[2],o[3]]],layers:i,crs:l};if("EPSG:3857"===l){const e=X([o[0],o[1]]),t=X([o[2],o[3]]);c.boundingBox=[e,t]}try{this.state.loadCounter++,this.props.onImageLoadStart(a);const e=await this.state.imageSource.getImage(c);this.state.lastRequestId<a&&(this.getCurrentLayer()?.props.onImageLoad(a),this.setState({image:e,bounds:o,lastRequestParameters:c,lastRequestId:a}))}catch(e){this.raiseError(e,"Load image"),this.getCurrentLayer()?.props.onImageLoadError(a,e)}finally{this.state.loadCounter--}}getRequestId(){return this.state._nextRequestId++}debounce(e,t=500){clearTimeout(this.state._timeoutId),this.state._timeoutId=setTimeout((()=>e()),t)}}const ee={getHeight:{type:"accessor",value:0},greatCircle:!0};class te extends c{static{this.layerName="GreatCircleLayer"}static{this.defaultProps=ee}}const ie={...d.defaultProps};class se extends e{static{this.layerName="GeoCellLayer"}static{this.defaultProps=ie}indexToBounds(){return null}renderLayers(){const{elevationScale:e,extruded:t,wireframe:i,filled:s,stroked:o,lineWidthUnits:r,lineWidthScale:n,lineWidthMinPixels:a,lineWidthMaxPixels:l,lineJointRounded:c,lineMiterLimit:h,lineDashJustified:u,getElevation:p,getFillColor:g,getLineColor:m,getLineWidth:f}=this.props,{updateTriggers:y,material:x,transitions:_}=this.props,v=this.getSubLayerClass("cell",d),{updateTriggers:b,...T}=this.indexToBounds()||{};return new v({filled:s,wireframe:i,extruded:t,elevationScale:e,stroked:o,lineWidthUnits:r,lineWidthScale:n,lineWidthMinPixels:a,lineWidthMaxPixels:l,lineJointRounded:c,lineMiterLimit:h,lineDashJustified:u,material:x,transitions:_,getElevation:p,getFillColor:g,getLineColor:m,getLineWidth:f},this.getSubLayerProps({id:"cell",updateTriggers:y&&{...b,getElevation:y.getElevation,getFillColor:y.getFillColor,getLineColor:y.getLineColor,getLineWidth:y.getLineWidth}}),T)}}const oe=3,re=61,ne=180/Math.PI;function ae(e,t,i){const s=1<<t;return[(e[0]+i[0])/s,(e[1]+i[1])/s]}function le(e){return e>=.5?1/3*(4*e*e-1):1/3*(1-4*(1-e)*(1-e))}function ce(e){return[le(e[0]),le(e[1])]}function de(e,[t,i]){switch(e){case 0:return[1,t,i];case 1:return[-t,1,i];case 2:return[-t,-i,1];case 3:return[-1,-i,-t];case 4:return[i,-1,-t];case 5:return[i,t,-1];default:throw new Error("Invalid face")}}function he([e,t,i]){const s=Math.atan2(i,Math.sqrt(e*e+t*t));return[Math.atan2(t,e)*ne,s*ne]}function ue(e,t,i,s){if(0===s){1===i&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);const s=t[0];t[0]=t[1],t[1]=s}}const pe=100;function ge(e){if("string"==typeof e){if(e.indexOf("/")>0)return e;e=function(e){const t=e.padEnd(16,"0");return _.fromString(t,16)}(e)}return function(e){let t=_.fromString(e,!0,10).toString(2);for(;t.length<oe+re;)t="0"+t;const i=t.lastIndexOf("1"),s=t.substring(0,3),o=t.substring(3,i),r=o.length/2,n=_.fromString(s,!0,2).toString(10);let a=_.fromString(o,!0,2).toString(4);for(;a.length<r;)a="0"+a;return`${n}/${a}`}(e.toString())}function me(e){return function({face:e,ij:t,level:i}){const s=[[0,0],[0,1],[1,1],[1,0],[0,0]],o=Math.max(1,Math.ceil(pe*Math.pow(2,-i))),r=new Float64Array(4*o*2+2);let n=0,a=0;for(let l=0;l<4;l++){const c=s[l].slice(0),d=s[l+1],h=(d[0]-c[0])/o,u=(d[1]-c[1])/o;for(let s=0;s<o;s++){c[0]+=h,c[1]+=u;const s=he(de(e,ce(ae(t,i,c))));Math.abs(s[1])>89.999&&(s[0]=a);const o=s[0]-a;s[0]+=o>180?-360:o<-180?360:0,r[n++]=s[0],r[n++]=s[1],a=s[0]}}return r[n++]=r[0],r[n++]=r[1],r}(function(e){const t=e.split("/"),i=parseInt(t[0],10),s=t[1],o=s.length,r=[0,0];let n;for(let e=o-1;e>=0;e--){n=o-e;const t=s[e];let i=0,a=0;"1"===t?a=1:"2"===t?(i=1,a=1):"3"===t&&(i=1);const l=Math.pow(2,n-1);ue(l,r,i,a),r[0]+=l*i,r[1]+=l*a}if(i%2==1){const e=r[0];r[0]=r[1],r[1]=e}return{face:i,ij:r,level:n}}(ge(e)))}const fe={getS2Token:{type:"accessor",value:e=>e.token}};class ye extends se{static{this.layerName="S2Layer"}static{this.defaultProps=fe}indexToBounds(){const{data:e,getS2Token:t}=this.props;return{data:e,_normalize:!1,positionFormat:"XY",getPolygon:(e,i)=>me(t(e,i))}}}const xe=512;function _e(e,t=1){const[i,s]=function(e,t){let i=0,s=0,o=1<<e.length;const r=o/xe;for(let t=0;t<e.length;t++){o>>=1;const r=parseInt(e[t]);r%2&&(i|=o),r>1&&(s|=o)}return[[i/r,xe-s/r],[(i+t)/r,xe-(s+t)/r]]}(e,t),[o,r]=x(i),[n,a]=x(s);return[n,r,n,a,o,a,o,r,n,r]}const ve={getQuadkey:{type:"accessor",value:e=>e.quadkey}};class be extends se{static{this.layerName="QuadkeyLayer"}static{this.defaultProps=ve}indexToBounds(){const{data:e,extruded:t,getQuadkey:i}=this.props,s=t?.99:1;return{data:e,_normalize:!1,positionFormat:"XY",getPolygon:(e,t)=>_e(i(e,t),s),updateTriggers:{getPolygon:s}}}}class Te{constructor(e){this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get bbox(){return this._bbox}set bbox(e){this._bbox||(this._bbox=e,this.boundingBox="west"in e?[[e.west,e.south],[e.east,e.north]]:[[e.left,e.top],[e.right,e.bottom]])}get data(){return this.isLoading&&this._loader?this._loader.then((()=>this.data)):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return Boolean(this._loader)&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){const e=this.content?this.content.byteLength:0;return Number.isFinite(e)||console.error("byteLength not defined in tile data"),e}async _loadData({getData:e,requestScheduler:t,onLoad:i,onError:s}){const{index:o,id:r,bbox:n,userData:a,zoom:l}=this,c=this._loaderId;this._abortController=new AbortController;const{signal:d}=this._abortController,h=await t.scheduleRequest(this,(e=>e.isSelected?1:-1));if(!h)return void(this._isCancelled=!0);if(this._isCancelled)return void h.done();let u,p=null;try{p=await e({index:o,id:r,bbox:n,userData:a,zoom:l,signal:d})}catch(e){u=e||!0}finally{h.done()}c===this._loaderId&&(this._loader=void 0,this.content=p,!this._isCancelled||p?(this._isLoaded=!0,this._isCancelled=!1,u?s(u,this):i(this)):this._isLoaded=!1)}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){this.isLoaded||(this._isCancelled=!0,this._abortController?.abort())}}const Se=512,Le=3,Me=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],Ce=Me.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),we=Ce.concat([[.25,.5],[.75,.5]]);class Pe{constructor(e,t,i){this.x=e,this.y=t,this.z=i}get children(){if(!this._children){const e=2*this.x,t=2*this.y,i=this.z+1;this._children=[new Pe(e,t,i),new Pe(e,t+1,i),new Pe(e+1,t,i),new Pe(e+1,t+1,i)]}return this._children}update(e){const{viewport:t,cullingVolume:i,elevationBounds:s,minZ:o,maxZ:r,bounds:n,offset:a,project:l}=e,c=this.getBoundingVolume(s,a,l);if(n&&!this.insideBounds(n))return!1;if(i.computeVisibility(c)<0)return!1;if(!this.childVisible){let{z:e}=this;if(e<r&&e>=o){const i=c.distanceTo(t.cameraPosition)*t.scale/t.height;e+=Math.floor(Math.log2(i))}if(e>=r)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(const t of this.children)t.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(const t of this._children)t.getSelected(e);return e}insideBounds([e,t,i,s]){const o=Math.pow(2,this.z),r=Se/o;return this.x*r<i&&this.y*r<s&&(this.x+1)*r>e&&(this.y+1)*r>t}getBoundingVolume(e,t,i){if(i){const t=this.z<1?we:this.z<2?Ce:Me,s=[];for(const o of t){const t=De(this.x+o[0],this.y+o[1],this.z);t[2]=e[0],s.push(i(t)),e[0]!==e[1]&&(t[2]=e[1],s.push(i(t)))}return C(s)}const s=Math.pow(2,this.z),o=Se/s,r=this.x*o+t*Se,n=Se-(this.y+1)*o;return new w([r,n,e[0]],[r+o,n+o,e[1]])}}const ze=512,Ie=[-1/0,-1/0,1/0,1/0],Re={type:"object",value:null,validate:(e,t)=>t.optional&&null===e||"string"==typeof e||Array.isArray(e)&&e.every((e=>"string"==typeof e)),equal:(e,t)=>{if(e===t)return!0;if(!Array.isArray(e)||!Array.isArray(t))return!1;const i=e.length;if(i!==t.length)return!1;for(let s=0;s<i;s++)if(e[s]!==t[s])return!1;return!0}};function Oe(e,t){const i=[t.transformAsPoint([e[0],e[1]]),t.transformAsPoint([e[2],e[1]]),t.transformAsPoint([e[0],e[3]]),t.transformAsPoint([e[2],e[3]])];return[Math.min(...i.map((e=>e[0]))),Math.min(...i.map((e=>e[1]))),Math.max(...i.map((e=>e[0]))),Math.max(...i.map((e=>e[1])))]}function Fe(e,t){if(!e||!e.length)return null;const{index:i,id:s}=t;if(Array.isArray(e)){e=e[(o=s,Math.abs(o.split("").reduce(((e,t)=>(e<<5)-e+t.charCodeAt(0)|0),0))%e.length)]}var o;let r=e;for(const e of Object.keys(i)){const t=new RegExp(`{${e}}`,"g");r=r.replace(t,String(i[e]))}return Number.isInteger(i.y)&&Number.isInteger(i.z)&&(r=r.replace(/\{-y\}/g,String(Math.pow(2,i.z)-i.y-1))),r}function Ee({viewport:e,z:t,cullRect:i}){return(e.subViewports||[e]).map((e=>Ae(e,t||0,i)))}function Ae(e,t,i){if(!Array.isArray(t)){const s=i.x-e.x,o=i.y-e.y,{width:r,height:n}=i,a={targetZ:t},l=e.unproject([s,o],a),c=e.unproject([s+r,o],a),d=e.unproject([s,o+n],a),h=e.unproject([s+r,o+n],a);return[Math.min(l[0],c[0],d[0],h[0]),Math.min(l[1],c[1],d[1],h[1]),Math.max(l[0],c[0],d[0],h[0]),Math.max(l[1],c[1],d[1],h[1])]}const s=Ae(e,t[0],i),o=Ae(e,t[1],i);return[Math.min(s[0],o[0]),Math.min(s[1],o[1]),Math.max(s[2],o[2]),Math.max(s[3],o[3])]}function Ne(e,t){return Math.pow(2,e)*ze/t}function De(e,t,i){const s=Ne(i,ze),o=e/s*360-180,r=Math.PI-2*Math.PI*t/s;return[o,180/Math.PI*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))]}function ke(e,t,i,s){const o=Ne(i,s);return[e/o*ze,t/o*ze]}function je(e,t,i,s,o=ze){if(e.isGeospatial){const[e,o]=De(t,i,s),[r,n]=De(t+1,i+1,s);return{west:e,north:o,east:r,south:n}}const[r,n]=ke(t,i,s,o),[a,l]=ke(t+1,i+1,s,o);return{left:r,top:n,right:a,bottom:l}}function Be(e,t,i,s,o){const r=function(e,t,i){let s;if(t&&2===t.length){const[i,o]=t,r=e.getBounds({z:i}),n=e.getBounds({z:o});s=[Math.min(r[0],n[0]),Math.min(r[1],n[1]),Math.max(r[2],n[2]),Math.max(r[3],n[3])]}else s=e.getBounds();return e.isGeospatial?[Math.max(s[0],i[0]),Math.max(s[1],i[1]),Math.min(s[2],i[2]),Math.min(s[3],i[3])]:[Math.max(Math.min(s[0],i[2]),i[0]),Math.max(Math.min(s[1],i[3]),i[1]),Math.min(Math.max(s[2],i[0]),i[2]),Math.min(Math.max(s[3],i[1]),i[3])]}(e,null,s),n=Ne(t,i),[a,l,c,d]=function(e,t,i){if(i)return Oe(e,i).map((e=>e*t/ze));return e.map((e=>e*t/ze))}(r,n,o),h=[];for(let e=Math.floor(a);e<c;e++)for(let i=Math.floor(l);i<d;i++)h.push({x:e,y:i,z:t});return h}function Ue({viewport:e,maxZoom:t,minZoom:i,zRange:r,extent:n,tileSize:a=ze,modelMatrix:l,modelMatrixInverse:c,zoomOffset:d=0}){let h=e.isGeospatial?Math.round(e.zoom+Math.log2(ze/a))+d:Math.ceil(e.zoom)+d;if("number"==typeof i&&Number.isFinite(i)&&h<i){if(!n)return[];h=i}"number"==typeof t&&Number.isFinite(t)&&h>t&&(h=t);let u=n;return l&&c&&n&&!e.isGeospatial&&(u=Oe(n,l)),e.isGeospatial?function(e,t,i,r){const n=e instanceof s&&e.resolution?e.projectPosition:null,a=Object.values(e.getFrustumPlanes()).map((({normal:e,distance:t})=>new L(e.clone().negate(),t))),l=new M(a),c=e.distanceScales.unitsPerMeter[2],d=i&&i[0]*c||0,h=i&&i[1]*c||0,u=e instanceof o&&e.pitch<=60?t:0;if(r){const[e,t,i,s]=r,o=y([e,s]),n=y([i,t]);r=[o[0],Se-o[1],n[0],Se-n[1]]}const p=new Pe(0,0,0),g={viewport:e,project:n,cullingVolume:l,elevationBounds:[d,h],minZ:u,maxZ:t,bounds:r,offset:0};if(p.update(g),e instanceof o&&e.subViewports&&e.subViewports.length>1){for(g.offset=-1;p.update(g)&&!(--g.offset<-Le););for(g.offset=1;p.update(g)&&!(++g.offset>Le););}return p.getSelected()}(e,h,r,n):Be(e,h,a,u||Ie,c)}function Ve(e,t){if(e===t)return!0;if(Array.isArray(e)){const i=e.length;if(!t||t.length!==i)return!1;for(let s=0;s<i;s++)if(e[s]!==t[s])return!1;return!0}return!1}const He=2,qe="best-available",Ze={[qe]:function(e){for(const t of e)t.state=0;for(const t of e)t.isSelected&&!$e(t)&&Je(t);for(const t of e)t.isVisible=Boolean(t.state&He)},"no-overlap":function(e){for(const t of e)t.state=0;for(const t of e)t.isSelected&&$e(t);const t=Array.from(e).sort(((e,t)=>e.zoom-t.zoom));for(const e of t)if(e.isVisible=Boolean(e.state&He),e.children&&(e.isVisible||1&e.state))for(const t of e.children)t.state=1;else e.isSelected&&Je(e)},never:()=>{}},We={extent:null,tileSize:512,maxZoom:null,minZoom:null,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:"best-available",zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{}};class Ge{constructor(e){this._getCullBounds=function(e){let t,i={};return s=>{for(const o in s)if(!Ve(s[o],i[o])){t=e(s),i=s;break}return t}}(Ee),this.opts={...We,...e},this.setOptions(this.opts),this.onTileLoad=e=>{this.opts.onTileLoad?.(e),this.opts.maxCacheByteSize&&(this._cacheByteSize+=e.byteLength,this._resizeCache())},this._requestScheduler=new v({throttleRequests:this.opts.maxRequests>0||this.opts.debounceTime>0,maxRequests:this.opts.maxRequests,debounceTime:this.opts.debounceTime}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._zRange=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new b,this._modelMatrixInverse=new b}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return null!==this._selectedTiles&&this._selectedTiles.every((e=>e.isLoaded))}get needsReload(){return null!==this._selectedTiles&&this._selectedTiles.some((e=>e.needsReload))}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(const e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(const e of this._cache.keys()){const t=this._cache.get(e);this._selectedTiles&&this._selectedTiles.includes(t)?t.setNeedsReload():this._cache.delete(e)}}update(e,{zRange:t,modelMatrix:i}={zRange:null,modelMatrix:null}){const s=i?new b(i):new b,o=!s.equals(this._modelMatrix);if(this._viewport&&e.equals(this._viewport)&&T(this._zRange,t)&&!o)this.needsReload&&(this._selectedTiles=this._selectedTiles.map((e=>this._getTile(e.index,!0))));else{o&&(this._modelMatrixInverse=s.clone().invert(),this._modelMatrix=s),this._viewport=e,this._zRange=t;const i=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=i.map((e=>this._getTile(e,!0))),this._dirty&&this._rebuildTree()}const r=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),r&&this._frameNumber++,this._frameNumber}isTileVisible(e,t){if(!e.isVisible)return!1;if(t&&this._viewport){const i=this._getCullBounds({viewport:this._viewport,z:this._zRange,cullRect:t}),{bbox:s}=e;for(const[e,t,o,r]of i){let i;if("west"in s)i=s.west<o&&s.east>e&&s.south<r&&s.north>t;else{const n=Math.min(s.top,s.bottom),a=Math.max(s.top,s.bottom);i=s.left<o&&s.right>e&&n<r&&a>t}if(i)return!0}return!1}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:i,zRange:s,modelMatrix:o,modelMatrixInverse:r}){const{tileSize:n,extent:a,zoomOffset:l}=this.opts;return Ue({viewport:e,maxZoom:t,minZoom:i,zRange:s,tileSize:n,extent:a,modelMatrix:o,modelMatrixInverse:r,zoomOffset:l})}getTileId(e){return`${e.x}-${e.y}-${e.z}`}getTileZoom(e){return e.z}getTileMetadata(e){const{tileSize:t}=this.opts;return{bbox:je(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){return{x:Math.floor(e.x/2),y:Math.floor(e.y/2),z:e.z-1}}updateTileStates(){const e=this.opts.refinementStrategy||qe,t=new Array(this._cache.size);let i=0;for(const e of this._cache.values())t[i++]=e.isVisible,e.isSelected=!1,e.isVisible=!1;for(const e of this._selectedTiles)e.isSelected=!0,e.isVisible=!0;("function"==typeof e?e:Ze[e])(Array.from(this._cache.values())),i=0;for(const e of this._cache.values())if(t[i++]!==e.isVisible)return!0;return!1}_pruneRequests(){const{maxRequests:e=0}=this.opts,t=[];let i=0;for(const e of this._cache.values())e.isLoading&&(i++,e.isSelected||e.isVisible||t.push(e));for(;e>0&&i>e&&t.length>0;){t.shift().abort(),i--}}_rebuildTree(){const{_cache:e}=this;for(const t of e.values())t.parent=null,t.children&&(t.children.length=0);for(const t of e.values()){const e=this._getNearestAncestor(t);t.parent=e,e?.children&&e.children.push(t)}}_resizeCache(){const{_cache:e,opts:t}=this,i=t.maxCacheSize||(t.maxCacheByteSize?1/0:5*this.selectedTiles.length),s=t.maxCacheByteSize||1/0;if(e.size>i||this._cacheByteSize>s){for(const[o,r]of e)if(r.isVisible||r.isSelected||(this._cacheByteSize-=t.maxCacheByteSize?r.byteLength:0,e.delete(o),this.opts.onTileUnload?.(r)),e.size<=i&&this._cacheByteSize<=s)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort(((e,t)=>e.zoom-t.zoom)),this._dirty=!1)}_getTile(e,t){const i=this.getTileId(e);let s=this._cache.get(i),o=!1;return!s&&t?(s=new Te(e),Object.assign(s,this.getTileMetadata(s.index)),Object.assign(s,{id:i,zoom:this.getTileZoom(s.index)}),o=!0,this._cache.set(i,s),this._dirty=!0):s&&s.needsReload&&(o=!0),s&&o&&s.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),s}_getNearestAncestor(e){const{_minZoom:t=0}=this;let i=e.index;for(;this.getTileZoom(i)>t;){i=this.getParentIndex(i);const e=this._getTile(i);if(e)return e}return null}}function $e(e){let t=e;for(;t;){if(t.isLoaded||t.content)return t.state|=He,!0;t=t.parent}return!1}function Je(e){for(const t of e.children)t.isLoaded||t.content?t.state|=He:Je(t)}const Ke={TilesetClass:Ge,data:{type:"data",value:[]},dataComparator:Re.equal,renderSubLayers:{type:"function",value:e=>new h(e)},getTileData:{type:"function",optional:!0,value:null},onViewportLoad:{type:"function",optional:!0,value:null},onTileLoad:{type:"function",value:e=>{}},onTileUnload:{type:"function",value:e=>{}},onTileError:{type:"function",value:e=>console.error(e)},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:qe,zRange:null,maxRequests:6,debounceTime:0,zoomOffset:0};class Xe extends e{static{this.defaultProps=Ke}static{this.layerName="TileLayer"}initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){this.state?.tileset?.finalize()}get isLoaded(){return Boolean(this.state?.tileset?.selectedTiles?.every((e=>e.isLoaded&&e.layers&&e.layers.every((e=>e.isLoaded)))))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state;const i=e.propsOrDataChanged||e.updateTriggersChanged,s=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?i&&(t.setOptions(this._getTilesetOptions()),s?t.reloadAll():t.tiles.forEach((e=>{e.layers=null}))):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){const{tileSize:e,maxCacheSize:t,maxCacheByteSize:i,refinementStrategy:s,extent:o,maxZoom:r,minZoom:n,maxRequests:a,debounceTime:l,zoomOffset:c}=this.props;return{maxCacheSize:t,maxCacheByteSize:i,maxZoom:r,minZoom:n,tileSize:e,refinementStrategy:s,extent:o,maxRequests:a,debounceTime:l,zoomOffset:c,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){const e=this.state.tileset,{zRange:t,modelMatrix:i}=this.props,s=e.update(this.context.viewport,{zRange:t,modelMatrix:i}),{isLoaded:o}=e,r=this.state.isLoaded!==o,n=this.state.frameNumber!==s;o&&(r||n)&&this._onViewportLoad(),n&&this.setState({frameNumber:s}),this.state.isLoaded=o}_onViewportLoad(){const{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){const{data:t,getTileData:i,fetch:s}=this.props,{signal:o}=e;return e.url="string"==typeof t||Array.isArray(t)?Fe(t,e):null,i?i(e):s&&e.url?s(e.url,{propName:"data",layer:this,signal:o}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo(e){const t=e.sourceLayer.props.tile,i=e.info;return i.picked&&(i.tile=t),i.sourceTile=t,i}_updateAutoHighlight(e){const t=e.sourceTile;if(t&&t.layers)for(const i of t.layers)i.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map((e=>{const t=this.getSubLayerPropsByTile(e);if(e.isLoaded||e.content)if(e.layers)t&&e.layers[0]&&Object.keys(t).some((i=>e.layers[0].props[i]!==t[i]))&&(e.layers=e.layers.map((e=>e.clone(t))));else{const i=this.renderSubLayers({...this.props,...this.getSubLayerProps({id:e.id,updateTriggers:this.props.updateTriggers}),data:e.content,_offset:0,tile:e});e.layers=r(i,Boolean).map((i=>i.clone({tile:e,...t})))}else;return e.layers}))}filterSubLayer({layer:e,cullRect:t}){const{tile:i}=e.props;return this.state.tileset.isTileVisible(i,t)}}const Ye={fadeTrail:!0,trailLength:{type:"number",value:120,min:0},currentTime:{type:"number",value:0,min:0},getTimestamps:{type:"accessor",value:e=>e.timestamps}};class Qe extends u{static{this.layerName="TripsLayer"}static{this.defaultProps=Ye}getShaders(){const e=super.getShaders();return e.inject={"vs:#decl":"uniform float trailLength;\nin float instanceTimestamps;\nin float instanceNextTimestamps;\nout float vTime;\n","vs:#main-end":"vTime = instanceTimestamps + (instanceNextTimestamps - instanceTimestamps) * vPathPosition.y / vPathLength;\n","fs:#decl":"uniform bool fadeTrail;\nuniform float trailLength;\nuniform float currentTime;\nin float vTime;\n","fs:#main-start":"if(vTime > currentTime || (fadeTrail && (vTime < currentTime - trailLength))) {\n  discard;\n}\n","fs:DECKGL_FILTER_COLOR":"if(fadeTrail) {\n  color.a *= 1.0 - (currentTime - vTime) / trailLength;\n}\n"},e}initializeState(){super.initializeState();this.getAttributeManager().addInstanced({timestamps:{size:1,accessor:"getTimestamps",shaderAttributes:{instanceTimestamps:{vertexOffset:0},instanceNextTimestamps:{vertexOffset:1}}}})}draw(e){const{fadeTrail:t,trailLength:i,currentTime:s}=this.props;e.uniforms={...e.uniforms,fadeTrail:t,trailLength:i,currentTime:s},super.draw(e)}}function et(e,t){t=void 0===t?e[0][0]:t;for(const i of e){const e=i[0]-t;e>180?i[0]-=360:e<-180&&(i[0]+=360)}}function tt(e,t,i){const s=e(t,i),[o,r]=P(s);return[r,o]}function it(e,t=1){const i=z(e,!0);return 1!==t?function(e,t,i){const[s,o]=P(e),r=t.length;et(t,o);const n=t[0]===t[r-1]?r-1:r;for(let e=0;e<n;e++)t[e][0]=S(o,t[e][0],i),t[e][1]=S(s,t[e][1],i)}(e,i,t):et(i),i}const st={...d.defaultProps,highPrecision:"auto",coverage:{type:"number",min:0,max:1,value:1},centerHexagon:null,getHexagon:{type:"accessor",value:e=>e.hexagon},extruded:!0};class ot extends e{static{this.defaultProps=st}static{this.layerName="H3HexagonLayer"}static{this._checkH3Lib=()=>{}}initializeState(){ot._checkH3Lib(),this.state={edgeLengthKM:0,resolution:-1}}shouldUpdateState({changeFlags:e}){return this._shouldUseHighPrecision()?e.propsOrDataChanged:e.somethingChanged}updateState({props:e,changeFlags:t}){if(!0!==e.highPrecision&&(t.dataChanged||t.updateTriggersChanged&&t.updateTriggersChanged.getHexagon)){const e=this._calculateH3DataProps();this.setState(e)}this._updateVertices(this.context.viewport)}_calculateH3DataProps(){let e=-1,t=!1,i=!1;const{iterable:s,objectInfo:o}=n(this.props.data);for(const r of s){o.index++;const s=this.props.getHexagon(r,o),n=I(s);if(e<0){if(e=n,!this.props.highPrecision)break}else if(e!==n){i=!0;break}if(R(s)){t=!0;break}}return{resolution:e,edgeLengthKM:e>=0?O(e,"km"):0,hasMultipleRes:i,hasPentagon:t}}_shouldUseHighPrecision(){if("auto"===this.props.highPrecision){const{resolution:e,hasPentagon:t,hasMultipleRes:i}=this.state,{viewport:s}=this.context;return Boolean(s?.resolution)||i||t||e>=0&&e<=5}return this.props.highPrecision}_updateVertices(e){if(this._shouldUseHighPrecision())return;const{resolution:t,edgeLengthKM:i,centerHex:s}=this.state;if(t<0)return;const o=this.props.centerHexagon||F(e.latitude,e.longitude,t);if(s===o)return;if(s)try{if(E(s,o)*i<10)return}catch{}const{unitsPerMeter:r}=e.distanceScales;let n=it(o);const[a,l]=P(o),[c,d]=e.projectFlat([l,a]);n=n.map((t=>{const i=e.projectFlat(t);return[(i[0]-c)/r[0],(i[1]-d)/r[1]]})),this.setState({centerHex:o,vertices:n})}renderLayers(){return this._shouldUseHighPrecision()?this._renderPolygonLayer():this._renderColumnLayer()}_getForwardProps(){const{elevationScale:e,material:t,coverage:i,extruded:s,wireframe:o,stroked:r,filled:n,lineWidthUnits:a,lineWidthScale:l,lineWidthMinPixels:c,lineWidthMaxPixels:d,getFillColor:h,getElevation:u,getLineColor:p,getLineWidth:g,transitions:m,updateTriggers:f}=this.props;return{elevationScale:e,extruded:s,coverage:i,wireframe:o,stroked:r,filled:n,lineWidthUnits:a,lineWidthScale:l,lineWidthMinPixels:c,lineWidthMaxPixels:d,material:t,getElevation:u,getFillColor:h,getLineColor:p,getLineWidth:g,transitions:m,updateTriggers:{getFillColor:f.getFillColor,getElevation:f.getElevation,getLineColor:f.getLineColor,getLineWidth:f.getLineWidth}}}_renderPolygonLayer(){const{data:e,getHexagon:t,updateTriggers:i,coverage:s}=this.props,o=this.getSubLayerClass("hexagon-cell-hifi",d),r=this._getForwardProps();return r.updateTriggers.getPolygon=function(e,t){let i;return i=null==e?t:"object"==typeof e?{...e,coverage:t}:{getHexagon:e,coverage:t},i}(i.getHexagon,s),new o(r,this.getSubLayerProps({id:"hexagon-cell-hifi",updateTriggers:r.updateTriggers}),{data:e,_normalize:!1,_windingOrder:"CCW",positionFormat:"XY",getPolygon:(e,i)=>function(e){const t=new Float64Array(2*e.length);let i=0;for(const s of e)t[i++]=s[0],t[i++]=s[1];return t}(it(t(e,i),s))})}_renderColumnLayer(){const{data:e,getHexagon:t,updateTriggers:i}=this.props,s=this.getSubLayerClass("hexagon-cell",p),o=this._getForwardProps();return o.updateTriggers.getPosition=i.getHexagon,new s(o,this.getSubLayerProps({id:"hexagon-cell",flatShading:!0,updateTriggers:o.updateTriggers}),{data:e,diskResolution:6,radius:1,vertices:this.state.vertices,getPosition:tt.bind(null,t)})}}const rt={getHexagons:{type:"accessor",value:e=>e.hexagons}};class nt extends se{static{this.layerName="H3ClusterLayer"}static{this.defaultProps=rt}initializeState(){ot._checkH3Lib()}updateState({props:e,changeFlags:t}){if(t.dataChanged||t.updateTriggersChanged&&t.updateTriggersChanged.getHexagons){const{data:t,getHexagons:i}=e,s=[],{iterable:o,objectInfo:r}=n(t);for(const e of o){r.index++;const t=i(e,r),o=A(t,!0);for(const t of o){for(const e of t)et(e);s.push(this.getSubLayerRow({polygon:t},e,r.index))}}this.setState({polygons:s})}}indexToBounds(){const{getElevation:e,getFillColor:t,getLineColor:i,getLineWidth:s}=this.props;return{data:this.state.polygons,getPolygon:e=>e.polygon,getElevation:this.getSubLayerAccessor(e),getFillColor:this.getSubLayerAccessor(t),getLineColor:this.getSubLayerAccessor(i),getLineWidth:this.getSubLayerAccessor(s)}}}const at={pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}};class lt extends k{static{this.layerName="MeshLayer"}static{this.defaultProps=at}getShaders(){const e=super.getShaders();return e.modules.push(U),{...e,vs:"#version 300 es\n#define SHADER_NAME simple-mesh-layer-vs\nuniform float sizeScale;\nuniform bool composeModelMatrix;\nuniform bool pickFeatureIds;\nin vec3 positions;\nin vec3 normals;\nin vec3 colors;\nin vec2 texCoords;\nin vec4 uvRegions;\nin vec3 featureIdsPickingColors;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin vec3 instanceModelMatrixCol0;\nin vec3 instanceModelMatrixCol1;\nin vec3 instanceModelMatrixCol2;\nout vec2 vTexCoord;\nout vec3 cameraPosition;\nout vec3 normals_commonspace;\nout vec4 position_commonspace;\nout vec4 vColor;\nvec2 applyUVRegion(vec2 uv) {\n#ifdef HAS_UV_REGIONS\nreturn fract(uv) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;\n#else\nreturn uv;\n#endif\n}\nvoid main(void) {\nvec2 uv = applyUVRegion(texCoords);\ngeometry.uv = uv;\nif (pickFeatureIds) {\ngeometry.pickingColor = featureIdsPickingColors;\n} else {\ngeometry.pickingColor = instancePickingColors;\n}\nmat3 instanceModelMatrix = mat3(instanceModelMatrixCol0, instanceModelMatrixCol1, instanceModelMatrixCol2);\nvTexCoord = uv;\ncameraPosition = project_uCameraPosition;\nvColor = vec4(colors * instanceColors.rgb, instanceColors.a);\nvec3 pos = (instanceModelMatrix * positions) * sizeScale;\nvec3 projectedPosition = project_position(positions);\nposition_commonspace = vec4(projectedPosition, 1.0);\ngl_Position = project_common_position_to_clipspace(position_commonspace);\ngeometry.position = position_commonspace;\nnormals_commonspace = project_normal(instanceModelMatrix * normals);\ngeometry.normal = normals_commonspace;\nDECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n#ifdef MODULE_PBR\npbr_vPosition = geometry.position.xyz;\n#ifdef HAS_NORMALS\npbr_vNormal = geometry.normal;\n#endif\n#ifdef HAS_UV\npbr_vUV = uv;\n#else\npbr_vUV = vec2(0., 0.);\n#endif\ngeometry.uv = pbr_vUV;\n#endif\nDECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME simple-mesh-layer-fs\nprecision highp float;\nuniform bool hasTexture;\nuniform sampler2D sampler;\nuniform bool flatShading;\nuniform float opacity;\nin vec2 vTexCoord;\nin vec3 cameraPosition;\nin vec3 normals_commonspace;\nin vec4 position_commonspace;\nin vec4 vColor;\nout vec4 fragColor;\nvoid main(void) {\n#ifdef MODULE_PBR\nfragColor = vColor * pbr_filterColor(vec4(0));\ngeometry.uv = pbr_vUV;\nfragColor.a *= opacity;\n#else\ngeometry.uv = vTexCoord;\nvec3 normal;\nif (flatShading) {\nnormal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));\n} else {\nnormal = normals_commonspace;\n}\nvec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;\nvec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);\nfragColor = vec4(lightColor, color.a * opacity);\n#endif\nDECKGL_FILTER_COLOR(fragColor, geometry);\n}\n"}}initializeState(){const{featureIds:e}=this.props;super.initializeState();const t=this.getAttributeManager();e&&t.add({featureIdsPickingColors:{type:"uint8",size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState(e){super.updateState(e);const{props:t,oldProps:i}=e;t.pbrMaterial!==i.pbrMaterial&&this.updatePbrMaterialUniforms(t.pbrMaterial)}draw(e){const{featureIds:t}=this.props;this.state.model&&(this.state.model.setUniforms({u_Camera:this.state.model.uniforms.project_uCameraPosition,pickFeatureIds:Boolean(t)}),super.draw(e))}getModel(e){const{id:t,pbrMaterial:i}=this.props,s=this.parseMaterial(i,e);this.setState({parsedPBRMaterial:s});const o=this.getShaders();!function(e){const t=e.positions||e.POSITION,i=t.value.length/t.size;e.COLOR_0||e.colors||(e.colors={size:4,value:new Uint8Array(4*i).fill(255),normalized:!0})}(e.attributes);return new N(this.context.device,{...this.getShaders(),id:t,geometry:e,bufferLayout:this.getAttributeManager().getBufferLayouts(),defines:{...o.defines,...s?.defines,HAS_UV_REGIONS:e.attributes.uvRegions?1:0},parameters:s?.parameters,isInstanced:!0})}updatePbrMaterialUniforms(e){const{model:t}=this.state;if(t){const{mesh:i}=this.props,s=this.parseMaterial(e,i);this.setState({parsedPBRMaterial:s}),t.setBindings(s.bindings),t.setUniforms(s.uniforms)}}parseMaterial(e,t){const i=Boolean(e.pbrMetallicRoughness&&e.pbrMetallicRoughness.baseColorTexture);return B(this.context.device,{unlit:i,...e},{NORMAL:t.attributes.normals,TEXCOORD_0:t.attributes.texCoords},{pbrDebug:!1,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(e){const t=this.props.featureIds,i=new Uint8ClampedArray(t.length*e.size),s=[];for(let e=0;e<t.length;e++)this.encodePickingColor(t[e],s),i[3*e]=s[0],i[3*e+1]=s[1],i[3*e+2]=s[2];e.value=i}finalizeState(e){super.finalizeState(e),this.state.parsedPBRMaterial?.generatedTextures.forEach((e=>e.destroy())),this.setState({parsedPBRMaterial:null})}}const ct=[0],dt={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:"",loader:Z,onTilesetLoad:{type:"function",value:e=>{}},onTileLoad:{type:"function",value:e=>{}},onTileUnload:{type:"function",value:e=>{}},onTileError:{type:"function",value:(e,t,i)=>{}},_getMeshColor:{type:"function",value:e=>[255,255,255]}};class ht extends e{static{this.defaultProps=dt}static{this.layerName="Tile3DLayer"}initializeState(){"onTileLoadFail"in this.props&&a.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){return Boolean(this.state?.tileset3d?.isLoaded()&&super.isLoaded)}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({props:e,oldProps:t,changeFlags:i}){if(e.data&&e.data!==t.data&&this._loadTileset(e.data),i.viewportChanged){const{activeViewports:e}=this.state;Object.keys(e).length&&(this._updateTileset(e),this.state.lastUpdatedViewports=e,this.state.activeViewports={})}if(i.propsChanged){const{layerMap:e}=this.state;for(const t in e)e[t].needsUpdate=!0}}activateViewport(e){const{activeViewports:t,lastUpdatedViewports:i}=this.state;this.internalState.viewport=e,t[e.id]=e;const s=i?.[e.id];s&&e.equals(s)||(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:e,sourceLayer:t}){const i=t&&t.props.tile;return e.picked&&(e.object=i),e.sourceTile=i,e}filterSubLayer({layer:e,viewport:t}){const{tile:i}=e.props,{id:s}=t;return i.selected&&i.viewportIds.includes(s)}_updateAutoHighlight(e){const t=e.sourceTile,i=this.state.layerMap[t?.id];i&&i.layer&&i.layer.updateAutoHighlight(e)}async _loadTileset(e){const{loadOptions:t={}}=this.props,i=this.props.loader||this.props.loaders,s=Array.isArray(i)?i[0]:i,o={loadOptions:{...t}};let r=e;if(s.preload){const i=await s.preload(e,t);i.url&&(r=i.url),i.headers&&(o.loadOptions.fetch={...o.loadOptions.fetch,headers:i.headers}),Object.assign(o,i)}const n=await V(r,s,o.loadOptions),a=new H(n,{onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileError:this.props.onTileError,...o});this.setState({tileset3d:a,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(a)}_onTileLoad(e){const{lastUpdatedViewports:t}=this.state;this.props.onTileLoad(e),this._updateTileset(t),this.setNeedsUpdate()}_onTileUnload(e){delete this.state.layerMap[e.id],this.props.onTileUnload(e)}_updateTileset(e){if(!e)return;const{tileset3d:t}=this.state,{timeline:i}=this.context,s=Object.keys(e).length;i&&s&&t&&t.selectTiles(Object.values(e)).then((e=>{this.state.frameNumber!==e&&this.setState({frameNumber:e})}))}_getSubLayer(e,t){if(!e.content)return null;switch(e.type){case q.POINTCLOUD:return this._makePointCloudLayer(e,t);case q.SCENEGRAPH:return this._make3DModelLayer(e);case q.MESH:return this._makeSimpleMeshLayer(e,t);default:throw new Error(`Tile3DLayer: Failed to render layer of type ${e.content.type}`)}}_makePointCloudLayer(e,t){const{attributes:s,pointCount:o,constantRGBA:r,cartographicOrigin:n,modelMatrix:a}=e.content,{positions:l,normals:c,colors:d}=s;if(!l)return null;const h=t&&t.props.data||{header:{vertexCount:o},attributes:{POSITION:l,NORMAL:c,COLOR_0:d}},{pointSize:u,getPointColor:p}=this.props;return new(this.getSubLayerClass("pointcloud",g))({pointSize:u},this.getSubLayerProps({id:"pointcloud"}),{id:`${this.id}-pointcloud-${e.id}`,tile:e,data:h,coordinateSystem:i.METER_OFFSETS,coordinateOrigin:n,modelMatrix:a,getColor:r||p,_offset:0})}_make3DModelLayer(e){const{gltf:t,instances:s,cartographicOrigin:o,modelMatrix:r}=e.content;return new(this.getSubLayerClass("scenegraph",j))({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:`${this.id}-scenegraph-${e.id}`,tile:e,data:s||ct,scenegraph:t,coordinateSystem:i.METER_OFFSETS,coordinateOrigin:o,modelMatrix:r,getTransformMatrix:e=>e.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(e,t){const s=e.content,{attributes:o,indices:r,modelMatrix:n,cartographicOrigin:a,coordinateSystem:l=i.METER_OFFSETS,material:c,featureIds:d}=s,{_getMeshColor:h}=this.props,u=t&&t.props.mesh||new D({topology:"triangle-list",attributes:ut(o),indices:r});return new(this.getSubLayerClass("mesh",lt))(this.getSubLayerProps({id:"mesh"}),{id:`${this.id}-mesh-${e.id}`,tile:e,mesh:u,data:ct,getColor:h(e),pbrMaterial:c,modelMatrix:n,coordinateOrigin:a,coordinateSystem:l,featureIds:d,_offset:0})}renderLayers(){const{tileset3d:e,layerMap:t}=this.state;return e?e.tiles.map((e=>{const i=t[e.id]=t[e.id]||{tile:e};let{layer:s}=i;return e.selected&&(s?i.needsUpdate&&(s=this._getSubLayer(e,s),i.needsUpdate=!1):s=this._getSubLayer(e)),i.layer=s,s})).filter(Boolean):null}}function ut(e){const t={};return t.positions={...e.positions,value:new Float32Array(e.positions.value)},e.normals&&(t.normals=e.normals),e.texCoords&&(t.texCoords=e.texCoords),e.colors&&(t.colors=e.colors),e.uvRegions&&(t.uvRegions=e.uvRegions),t}const pt=[1],gt={...Xe.defaultProps,elevationData:Re,texture:{...Re,optional:!0},meshMaxError:{type:"number",value:4},bounds:{type:"array",value:null,optional:!0,compare:!0},color:{type:"color",value:[255,255,255]},elevationDecoder:{type:"object",value:{rScaler:1,gScaler:0,bScaler:0,offset:0}},workerUrl:"",wireframe:!1,material:!0,loaders:[W]};function mt(e){return Array.isArray(e)?e.join(";"):e||""}class ft extends e{static{this.defaultProps=gt}static{this.layerName="TerrainLayer"}updateState({props:e,oldProps:t}){const i=e.elevationData!==t.elevationData;if(i){const{elevationData:t}=e,i=t&&(Array.isArray(t)||t.includes("{x}")&&t.includes("{y}"));this.setState({isTiled:i})}const s=i||e.meshMaxError!==t.meshMaxError||e.elevationDecoder!==t.elevationDecoder||e.bounds!==t.bounds;if(!this.state.isTiled&&s){const t=this.loadTerrain(e);this.setState({terrain:t})}e.workerUrl&&a.removed("workerUrl","loadOptions.terrain.workerUrl")()}loadTerrain({elevationData:e,bounds:t,elevationDecoder:i,meshMaxError:s,signal:o}){if(!e)return null;let r=this.getLoadOptions();r={...r,terrain:{skirtHeight:this.state.isTiled?2*s:0,...r?.terrain,bounds:t,meshMaxError:s,elevationDecoder:i}};const{fetch:n}=this.props;return n(e,{propName:"elevationData",layer:this,loadOptions:r,signal:o})}getTiledTerrainData(e){const{elevationData:t,fetch:i,texture:s,elevationDecoder:o,meshMaxError:r}=this.props,{viewport:n}=this.context,a=Fe(t,e),l=s&&Fe(s,e),{signal:c}=e;let d=[0,0],h=[0,0];if(n.isGeospatial){const t=e.bbox;d=n.projectFlat([t.west,t.south]),h=n.projectFlat([t.east,t.north])}else{const t=e.bbox;d=[t.left,t.bottom],h=[t.right,t.top]}const u=[d[0],d[1],h[0],h[1]],p=this.loadTerrain({elevationData:a,bounds:u,elevationDecoder:o,meshMaxError:r,signal:c}),g=l?i(l,{propName:"texture",layer:this,loaders:[],signal:c}).catch((e=>null)):Promise.resolve(null);return Promise.all([p,g])}renderSubLayers(e){const t=this.getSubLayerClass("mesh",k),{color:s,wireframe:o,material:r}=this.props,{data:n}=e;if(!n)return null;const[a,l]=n;return new t(e,{data:pt,mesh:a,texture:l,_instanced:!1,coordinateSystem:i.CARTESIAN,getPosition:e=>[0,0,0],getColor:s,wireframe:o,material:r})}onViewportLoad(e){if(!e)return;const{zRange:t}=this.state,i=e.map((e=>e.content)).filter(Boolean).map((e=>e[0].header.boundingBox.map((e=>e[2]))));if(0===i.length)return;const s=Math.min(...i.map((e=>e[0]))),o=Math.max(...i.map((e=>e[1])));(!t||s<t[0]||o>t[1])&&this.setState({zRange:[s,o]})}renderLayers(){const{color:e,material:t,elevationData:i,texture:s,wireframe:o,meshMaxError:r,elevationDecoder:n,tileSize:a,maxZoom:l,minZoom:c,extent:d,maxRequests:h,onTileLoad:u,onTileUnload:p,onTileError:g,maxCacheSize:m,maxCacheByteSize:f,refinementStrategy:y}=this.props;if(this.state.isTiled)return new Xe(this.getSubLayerProps({id:"tiles"}),{getTileData:this.getTiledTerrainData.bind(this),renderSubLayers:this.renderSubLayers.bind(this),updateTriggers:{getTileData:{elevationData:mt(i),texture:mt(s),meshMaxError:r,elevationDecoder:n}},onViewportLoad:this.onViewportLoad.bind(this),zRange:this.state.zRange||null,tileSize:a,maxZoom:l,minZoom:c,extent:d,maxRequests:h,onTileLoad:u,onTileUnload:p,onTileError:g,maxCacheSize:m,maxCacheByteSize:f,refinementStrategy:y});if(!i)return null;return new(this.getSubLayerClass("mesh",k))(this.getSubLayerProps({id:"mesh"}),{data:pt,mesh:this.state.terrain,texture:s,_instanced:!1,getPosition:e=>[0,0,0],getColor:e,material:t,wireframe:o})}}const yt={Point:xt,MultiPoint:function(e,t,i){return _t(e,t,i)},LineString:vt,MultiLineString:function(e,t,i){return e.map((e=>vt(e,t,i)))},Polygon:bt,MultiPolygon:function(e,t,i){return e.map((e=>bt(e,t,i)))}};function xt([e,t],[i,s],o){const r=S(i[0],s[0],e),n=S(i[1],s[1],t);return o.unprojectFlat([r,n])}function _t(e,t,i){return e.map((e=>xt(e,t,i)))}function vt(e,t,i){return _t(e,t,i)}function bt(e,t,i){return e.map((e=>_t(e,t,i)))}const Tt=["points","lines","polygons"];function St(e,t,i,s){const o=e.featureIds.value;if(!o.length)return-1;let r=0,n=o[o.length-1]+1;if(s){const t=function(e,t){if(!e.__layers){const t={},{properties:i}=e;for(let e=0;e<i.length;e++){const{layerName:s}=i[e];s&&(t[s]?t[s][1]=e:t[s]=[e,e])}e.__layers=t}return e.__layers[t]}(e,s);if(!t)return-1;r=t[0],n=t[1]+1}let a=-1;if(t in e.numericProps){const s=e.numericProps[t].value.findIndex(((e,t)=>e===i&&o[t]>=r&&o[t]<n));return s>=0?e.globalFeatureIds.value[s]:-1}return t?a=Lt(e.properties,(e=>e[t]===i),r,n):e.fields&&(a=Lt(e.fields,(e=>e.id===i),r,n)),a>=0?function(e,t){if(!e.__ids){const t=[],i=e.featureIds.value,s=e.globalFeatureIds.value;for(let e=0;e<i.length;e++)t[i[e]]=s[e];e.__ids=t}return e.__ids[t]}(e,a):-1}function Lt(e,t,i,s){for(let o=i;o<s;o++)if(t(e[o],o))return o;return-1}const Mt={...h.defaultProps,data:Re,onDataLoad:{type:"function",value:null,optional:!0,compare:!1},uniqueIdProperty:"",highlightedFeatureId:null,loaders:[$],binary:!0};class Ct extends Xe{static{this.layerName="MVTLayer"}static{this.defaultProps=Mt}initializeState(){super.initializeState();const e=void 0===this.context.viewport.resolution&&this.props.binary;this.setState({binary:e,data:null,tileJSON:null,hoveredFeatureId:null,hoveredFeatureLayerName:null})}get isLoaded(){return Boolean(this.state?.data&&super.isLoaded)}updateState({props:e,oldProps:t,context:i,changeFlags:s}){s.dataChanged&&this._updateTileData(),this.state?.data&&(super.updateState({props:e,oldProps:t,context:i,changeFlags:s}),this._setWGS84PropertyForTiles());const{highlightColor:o}=e;o!==t.highlightColor&&Array.isArray(o)&&this.setState({highlightColor:o})}async _updateTileData(){let e=this.props.data,t=null;if("string"!=typeof e||/(?=.*{z})(?=.*{x})(?=.*({y}|{-y}))/.test(e))e&&"object"==typeof e&&"tilejson"in e&&(t=e);else{const{onDataLoad:i,fetch:s}=this.props;this.setState({data:null,tileJSON:null});try{t=await s(e,{propName:"data",layer:this,loaders:[]})}catch(t){this.raiseError(t,"loading TileJSON"),e=null}i&&i(t,{propName:"data",layer:this})}t&&(e=t.tiles),this.setState({data:e,tileJSON:t})}_getTilesetOptions(){const e=super._getTilesetOptions(),t=this.state.tileJSON,{minZoom:i,maxZoom:s}=this.props;return t&&(Number.isFinite(t.minzoom)&&t.minzoom>i&&(e.minZoom=t.minzoom),Number.isFinite(t.maxzoom)&&(!Number.isFinite(s)||t.maxzoom<s)&&(e.maxZoom=t.maxzoom)),e}renderLayers(){return this.state?.data?super.renderLayers():null}getTileData(e){const{data:t,binary:i}=this.state,{index:s,signal:o}=e,r=Fe(t,e);if(!r)return Promise.reject("Invalid URL");let n=this.getLoadOptions();const{fetch:a}=this.props;return n={...n,mimeType:"application/x-protobuf",mvt:{...n?.mvt,coordinates:this.context.viewport.resolution?"wgs84":"local",tileIndex:s},gis:i?{format:"binary"}:{}},a(r,{propName:"data",layer:this,loadOptions:n,signal:o})}renderSubLayers(e){const{x:t,y:s,z:o}=e.tile.index,r=Math.pow(2,o),n=512/r,l=-n,c=512*t/r,d=512*(1-s/r),u=(new b).scale([n,l,1]);e.autoHighlight=!1,this.context.viewport.resolution||(e.modelMatrix=u,e.coordinateOrigin=[c,d,0],e.coordinateSystem=i.CARTESIAN,e.extensions=[...e.extensions||[],new G]);const p=super.renderSubLayers(e);return!this.state.binary||p instanceof h||a.warn("renderSubLayers() must return GeoJsonLayer when using binary:true")(),p}_updateAutoHighlight(e){const{uniqueIdProperty:t}=this.props,{hoveredFeatureId:i,hoveredFeatureLayerName:s}=this.state,o=e.object;let r=null,n=null;o&&(r=wt(o,t),n=Pt(o));let{highlightColor:a}=this.props;"function"==typeof a&&(a=a(e)),i===r&&s===n||this.setState({highlightColor:a,hoveredFeatureId:r,hoveredFeatureLayerName:n})}getPickingInfo(e){const t=super.getPickingInfo(e),i=Boolean(this.context.viewport.resolution);if(this.state.binary&&-1!==t.index){const{data:i}=e.sourceLayer.props;t.object=J(i,{globalFeatureId:t.index})}return t.object&&!i&&(t.object=It(t.object,t.tile.bbox,this.context.viewport)),t}getSubLayerPropsByTile(e){return{highlightedObjectIndex:this.getHighlightedObjectIndex(e),highlightColor:this.state.highlightColor}}getHighlightedObjectIndex(e){const{hoveredFeatureId:t,hoveredFeatureLayerName:i,binary:s}=this.state,{uniqueIdProperty:o,highlightedFeatureId:r}=this.props,n=e.content,a=zt(r);if(!(zt(t)||a))return-1;const l=a?r:t;return Array.isArray(n)?n.findIndex((e=>{const t=wt(e,o)===l,s=a||Pt(e)===i;return t&&s})):n&&s?function(e,t,i,s){for(const o of Tt){const r=e[o]&&St(e[o],t,i,s);if(r>=0)return r}return-1}(n,o,l,a?"":i):-1}_pickObjects(e){const{deck:t,viewport:i}=this.context,s=i.width,o=i.height,r=i.x,n=i.y,a=[this.id];return t.pickObjects({x:r,y:n,width:s,height:o,layerIds:a,maxObjects:e})}getRenderedFeatures(e=null){const t=this._pickObjects(e),i=new Set,s=[];for(const e of t){const t=wt(e.object,this.props.uniqueIdProperty);void 0===t?s.push(e.object):i.has(t)||(i.add(t),s.push(e.object))}return s}_setWGS84PropertyForTiles(){const e="dataInWGS84";this.state.tileset.selectedTiles.forEach((t=>{t.hasOwnProperty(e)||Object.defineProperty(t,e,{get:()=>{if(!t.content)return null;if(this.state.binary&&Array.isArray(t.content)&&!t.content.length)return[];const{bbox:e}=t;if(void 0===t._contentWGS84&&(i=e,Number.isFinite(i.west)&&Number.isFinite(i.north)&&Number.isFinite(i.east)&&Number.isFinite(i.south))){const i=this.state.binary?J(t.content):t.content;t._contentWGS84=i.map((t=>It(t,e,this.context.viewport)))}var i;return t._contentWGS84}})}))}}function wt(e,t){return e.properties&&t?e.properties[t]:"id"in e?e.id:void 0}function Pt(e){return e.properties?.layerName||null}function zt(e){return null!=e&&""!==e}function It(e,t,i){const s={...e,geometry:{type:e.geometry.type}};return Object.defineProperty(s.geometry,"coordinates",{get:()=>{const s=function(e,t,i){const s=[i.projectFlat([t.west,t.north]),i.projectFlat([t.east,t.south])];return{...e,coordinates:yt[e.type](e.coordinates,s,i)}}(e.geometry,t,i);return s.coordinates}}),s}const Rt="0123456789bcdefghjkmnpqrstuvwxyz",Ot={};for(let e=0;e<32;e++)Ot[Rt.charAt(e)]=e;const Ft=-90,Et=90,At=-180,Nt=180;function Dt(e){const[t,i,s,o]=function(e){let t,i=!0,s=Et,o=Ft,r=Nt,n=At,a=0;for(let l=0,c=e.length;l<c;l++){const c=e[l].toLowerCase();a=Ot[c];for(let e=4;e>=0;e--){const l=a>>e&1;i?(t=(r+n)/2,1===l?n=t:r=t):(t=(s+o)/2,1===l?o=t:s=t),i=!i}}return[o,n,s,r]}(e);return[o,s,o,t,i,t,i,s,o,s]}const kt={getGeohash:{type:"accessor",value:e=>e.geohash}};class jt extends se{static{this.layerName="GeohashLayer"}static{this.defaultProps=kt}indexToBounds(){const{data:e,getGeohash:t}=this.props;return{data:e,_normalize:!1,positionFormat:"XY",getPolygon:(e,i)=>Dt(t(e,i))}}}export{jt as GeohashLayer,te as GreatCircleLayer,nt as H3ClusterLayer,ot as H3HexagonLayer,Ct as MVTLayer,be as QuadkeyLayer,ye as S2Layer,ft as TerrainLayer,ht as Tile3DLayer,Xe as TileLayer,Qe as TripsLayer,se as _GeoCellLayer,Te as _Tile2DHeader,Ge as _Tileset2D,Q as _WMSLayer,Fe as _getURLFromTemplate};export default null;
